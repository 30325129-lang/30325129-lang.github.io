<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>經驗值/戰力 排名查詢</title>
<meta name="description" content="新楓之谷角色經驗值、戰力、職業內排名查詢與前 100 名榜單" />
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:24px;line-height:1.5}
.card{max-width:1100px;margin:0 auto;border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 2px 14px rgba(0,0,0,.05)}
h1{margin:0 0 8px;font-size:20px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
input,select,button{font-size:14px;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px}
input{flex:1;min-width:220px}
select{min-width:180px}
button{cursor:pointer;background:#111827;color:#fff;border-color:#111827}
button.secondary{background:#fff;color:#111827}
button:disabled{opacity:.6;cursor:not-allowed}
.muted{color:#6b7280;font-size:13px;margin-top:6px}
.status{margin-top:10px;font-size:13px}

.faq-inline{
  margin-top:10px;
  padding:12px 14px;
  border:1px dashed #e5e7eb;
  border-radius:12px;
  background:#fafafa;
  font-size:14px;
  line-height:1.6;
}
.faq-inline .faq-title{font-weight:700;margin-bottom:6px}
.faq-inline .faq-q{font-weight:700}
.faq-inline .faq-p{margin-top:6px}
.ok{color:#065f46}
.bad{color:#991b1b}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:left;font-size:14px;vertical-align:top}
th{background:#f9fafb;position:sticky;top:0;z-index:1}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3f4f6;font-size:12px}
.tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.tabs button{background:#fff;color:#111827}
.tabs button.active{background:#111827;color:#fff;border-color:#111827}
.small{font-size:12px;color:#6b7280}
.right{margin-left:auto}

.controls{display:inline-flex;gap:8px;align-items:center;margin-left:8px}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
.nowrap{white-space:nowrap}

/* ✅ 靜態說明區（讓工具頁不是只有 Loading） */
.intro{
margin-top:10px;
padding:10px 12px;
border:1px solid #e5e7eb;
border-radius:12px;
background:#fafafa;
}
.intro a{color:#111827}

/* ===== 全畫面 Loading Overlay ===== */
.overlay{
position:fixed;inset:0;z-index:9999;
background:rgba(255,255,255,.78);
backdrop-filter: blur(4px);
display:none;
align-items:center;
justify-content:center;
padding:24px;
}
.overlay.show{display:flex;}
.overlay-card{
width:min(560px, 100%);
border:1px solid #e5e7eb;
border-radius:16px;
background:#fff;
padding:18px 18px 16px;
box-shadow:0 10px 30px rgba(0,0,0,.08);
display:flex;
gap:14px;
align-items:flex-start;
}
.spinner{
width:42px;height:42px;border-radius:999px;
border:4px solid #e5e7eb;
border-top-color:#111827;
animation:spin 0.9s linear infinite;
flex:0 0 auto;
margin-top:2px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.overlay-title{font-weight:700;margin:0 0 2px;font-size:15px}
.overlay-sub{margin:0;color:#6b7280;font-size:13px}

/* 進度條 */
.progress-wrap{margin-top:10px}
.progress{
width:100%;
height:10px;
border-radius:999px;
background:#eef2f7;
overflow:hidden;
border:1px solid #e5e7eb;
}
.progress-bar{
height:100%;
width:0%;
background:#111827;
border-radius:999px;
transition:width .18s ease;
}
.progress-row{
display:flex;
justify-content:space-between;
gap:10px;
margin-top:8px;
font-size:12px;
color:#6b7280;
}
.progress-row .pct{font-variant-numeric:tabular-nums;color:#111827;font-weight:700}

/* ✅ 查詢結果：附近榜控制區 */
.around-controls{
display:none;
margin-top:10px;
padding:10px;
border:1px solid #e5e7eb;
border-radius:12px;
background:#fafafa;
}
.around-controls.show{display:block;}
.around-top{
display:flex;
gap:10px;
flex-wrap:wrap;
align-items:center;
}
.around-tabs{
display:flex;
gap:8px;
flex-wrap:wrap;
}
.around-tabs button{
background:#fff;color:#111827;
border-color:#d1d5db;
}
.around-tabs button.active{
background:#111827;color:#fff;border-color:#111827
}
.around-controls .hint{
margin-top:6px;
font-size:12px;
color:#6b7280;
}

/* =========================
      ✅ 搜尋紀錄下拉（LocalStorage）
      - 雙擊名稱輸入框顯示
      - 方向鍵上下選 / Enter 套用 / Esc 關閉
   ========================= */
.history-dropdown{
position:fixed;
z-index:10001;
display:none;
border:1px solid #d1d5db;
border-radius:12px;
background:#fff;
box-shadow:0 10px 30px rgba(0,0,0,.10);
overflow:hidden;
}
.history-dropdown.show{display:block;}
.history-topbar{
display:flex;
align-items:center;
justify-content:space-between;
gap:10px;
padding:8px 10px;
border-bottom:1px solid #e5e7eb;
background:#fafafa;
}
.history-title{
font-size:12px;
color:#6b7280;
user-select:none;
}
.history-clear{
font-size:12px;
padding:6px 8px;
border-radius:10px;
border:1px solid #d1d5db;
background:#fff;
color:#111827;
cursor:pointer;
}
.history-clear:hover{background:#f9fafb;}
.history-list{
max-height:280px;
overflow:auto;
}
.history-item{
width:100%;
text-align:left;
padding:10px 12px;
border:0;
border-bottom:1px solid #f3f4f6;
background:#fff;
cursor:pointer;
font-size:14px;
color:#111827;
}
.history-item:last-child{border-bottom:0;}
.history-item:hover{background:#f9fafb;}
.history-item.active{background:#eef2ff;}
.history-name{font-weight:700;}
.history-meta{
margin-top:2px;
font-size:12px;
color:#6b7280;
}
.history-empty{
padding:12px;
font-size:13px;
color:#6b7280;
}
/* =========================
      ✅ 同名角色選擇 / 只看此角色
   ========================= */
.dupe-panel{
  margin-top:10px;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fafafa;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.dupe-panel .label{font-size:13px;color:#6b7280;user-select:none}
.dupe-panel select{min-width:260px}
.miniBtn{
  font-size:12px;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid #d1d5db;
  background:#fff;
  color:#111827;
  cursor:pointer;
}
.miniBtn.primary{background:#111827;color:#fff;border-color:#111827}
.miniBtn.danger{background:#fff;color:#b91c1c;border-color:#ef4444}
.miniBtn.danger:hover{background:#fff1f2}
.miniBtn:disabled{opacity:.6;cursor:not-allowed}

/* ===== FAQ Modal（查不到角色時跳出） ===== */
.modal{position:fixed;inset:0;z-index:10001;display:none}
.modal.show{display:block}
.modal-backdrop{position:absolute;inset:0;background:rgba(17,24,39,.45);backdrop-filter: blur(2px)}
.modal-card{position:relative;width:min(680px,92vw);margin:8vh auto 0;background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 14px 40px rgba(0,0,0,.18);padding:14px 14px 12px}
.modal-head{display:flex;align-items:center;gap:10px;padding:4px 6px 10px}
.modal-title{font-weight:800;font-size:16px}
button.modal-close{margin-left:auto;background:#fff;color:#111827;border-color:#d1d5db}
.modal-body{padding:0 6px 10px;font-size:14px;line-height:1.65}
.modal-body a{color:#111827;text-decoration:underline}
.modal-foot{display:flex;justify-content:flex-end;gap:8px;padding:0 6px 6px}
.faq-q{font-weight:700;margin:0 0 6px}
.faq-p{margin:0 0 8px}

</style>
<!-- ✅ 注意：rank.html 故意不放 AdSense script，避免 Loading 畫面投放又被判定「沒有發布內容」 -->
</head>
<body>

<!-- 全畫面 Loading + 進度條 -->
<div id="overlay" class="overlay" aria-live="polite" aria-busy="true">
<div class="overlay-card">
<div class="spinner" aria-hidden="true"></div>
<div style="flex:1">
<div id="overlayTitle" class="overlay-title">資料載入中…</div>
<p id="overlaySub" class="overlay-sub">正在抓取最新資料，請稍候。</p>

<div class="progress-wrap">
<div class="progress"><div id="progressBar" class="progress-bar"></div></div>
<div class="progress-row">
<span id="progressHint">連線中…</span>
<span class="pct" id="progressPct">0%</span>
</div>
</div>
</div>
</div>
</div>


<!-- FAQ Modal：查不到角色時提示如何收錄 -->
<div id="faqModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="faqModal" aria-hidden="true"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
    <div class="modal-head">
      <div id="faqTitle" class="modal-title">常見問題</div>
      <button id="faqCloseBtn" type="button" class="secondary modal-close" aria-label="關閉">✕</button>
    </div>
    <div class="modal-body">
      <div class="faq-q">Q：查不到角色怎麼辦？＆ 轉移過伺服器也一樣要重新搜尋登錄！</div>
      <div class="faq-p">本資料庫收錄 挑戰者服 260 以上、一般服 270 以上角色。</div>
      <div class="faq-p">第一次查詢，請至
        <a href="https://opencheapgpt.pse.is/opencheapgpt" target="_blank" rel="noopener">https://opencheapgpt.pse.is/opencheapgpt</a>
        輸入角色名稱，數分鐘後將自動收錄，或隔天再查詢看看。
      </div>
    </div>
    <div class="modal-foot">
      <button id="faqOkBtn" type="button">知道了</button>
    </div>
  </div>
</div>


<div class="card">
<h1>挑戰者伺服器（或其他伺服器）經驗值 / 戰力 / 職業內排名 查詢</h1>

    <div class="intro">
      <div class="muted">
        本頁為查詢工具頁。若要看完整介紹/FAQ 請回 <a href="./index.html"><b>首頁</b></a>；
        <span class="small">｜看到宣傳/異常資料可按表格右側「檢舉」，累計達 <b>3</b> 次會自動隱藏。</span>
        <a href="./privacy.html"><b>隱私權政策</b></a>。
  
      </div>
    </div>

<div class="row" style="margin-top:12px">
<!-- ✅ 雙擊這個輸入框會出現「搜尋紀錄」 -->
<input id="nameInput" placeholder="輸入角色名稱（例：Ezra蓮）" />
<select id="worldSelect"><option value="__ALL__">全部伺服器</option></select>

<!-- 職業篩選（主要用在前100名） -->
<select id="jobSelect" title="前100名可用：職業篩選"><option value="__ALL_JOB__">全部職業</option></select>

<button id="searchBtn">查詢</button>
<button id="shareBtn" class="secondary">複製查詢連結</button>
</div>

<div class="tabs">
<button id="tabResult" class="active">查詢結果</button>
<button id="tabTopExp">前 100 名（經驗）</button>
<button id="tabTopBp">前 100 名（戰力）</button>
<span class="right small" id="metaInfo"></span>
  <span class="controls"></span>
</div>

<div id="status" class="status"></div>
<div id="faqInline" class="faq-inline" style="display:none"></div>

    <noscript>
      <div class="intro"><div class="muted">本站需要啟用 JavaScript 才能載入排名資料與查詢功能。</div></div>
    </noscript>

<!-- ✅ 查詢自己時：附近榜（經驗/戰力 Tab + 上下 50 名） -->
<div id="aroundControls" class="around-controls">
<div class="around-top">
<div class="around-tabs">
<button id="tabAroundExp" class="active">附近（經驗）</button>
<button id="tabAroundBp">附近（戰力）</button>
</div>

<button id="btnUp50" class="secondary">⬆ 顯示上方 50 名</button>
<button id="btnDown50" class="secondary">⬇ 顯示下方 50 名</button>

<span class="right small" id="aroundMeta"></span>
</div>
<div class="hint" id="aroundHint">（以所選榜單為基準，顯示你附近的排名，可一直往上/往下翻）</div>
</div>

<div id="content"></div>

<div class="muted" style="margin-top:14px">
← <a href="./index.html">回首頁</a>　|　<a href="./privacy.html">隱私權政策</a>
</div>
</div>

<script>
  // ✅ 檢舉系統設定：只要改這裡（不需要改內碼）
  window.RANK_REPORT_HIDE_THRESHOLD = 3;      // 幾次檢舉就自動隱藏
  window.RANK_REPORT_RATE_LIMIT_HOURS = 24;  // 同一台裝置同一角色多久只能檢舉一次
  window.RANK_REPORT_API_URL = "https://script.google.com/macros/s/AKfycbwL6S__yGbYsyH6lAtsWzGtADbYuJWnOD3uy--eQmBOZQntQlwfkEOWkagZIyKk10-kOQ/exec";           // TODO: 貼上 Google Apps Script Web App /exec URL（留空＝只做本機隱藏）
</script>

<script>

/** ====== 你只需要改這兩個 ====== */
const SHEET_ID = "1GCs7Dovg7DJkENlyTNqn_gkFc6ARSdinBrNoZUvCM0Y";
const SHEET_NAME = "character_data";
/** ================================= */

/** ✅ 過濾異常戰鬥力：>= 100 億 直接排除（避免榜單被污染） */
const BP_EXCLUDE_MIN = 10_000_000_000;

// ✅ 過濾指定名稱（宣傳/測試資料）
// - 你可在這裡持續新增想排除的名字或關鍵字
const NAME_EXCLUDE = new Set([
    "想變得跟我一樣強嗎? (搜尋DanceGPT)",
  "想跟我一樣請搜 DanceGPT",
  "想跟我一樣請搜DanceGPT",
  "想跟我一樣強請搜Dance GPT",
  "想跟我一樣強請搜DanceGPT",
  "想跟我一樣強請搜D a n c e G P T",
  "[想跟我一樣強請搜D a n c e G P T]",
  "想跟我一樣強請搜D-a*n,c-e*G,P-T",
  "想跟我一樣強請搜\"用AI生成式腳本幫你練功 冰楓\"",
  "想跟我一樣強請搜用AI生成式腳本幫你練功 冰楓",
  "想跟我一樣強請搜用AI生成式腳本幫你練功冰楓"
]);
// 只要名字符合其中任一條，就會整筆排除
const NAME_EXCLUDE_PATTERNS = [
    /搜尋\s*DanceGPT/i,
  /搜\s*DanceGPT/i,
  /DanceGPT/i,
  /Dance\s*GPT/i,
  /\[?\s*想跟我一樣強請搜\s*D\s*a\s*n\s*c\s*e\s*G\s*P\s*T\s*\]?/i,
  /想(?:變得)?跟我一樣.*請\s*(?:搜|google)/i,
  /用\s*A\s*I.*腳本.*練功/i
];


/* =========================
   ✅ 檢舉系統（被檢舉多次自動隱藏）
   - GitHub Pages 靜態頁需要後端才能「多人累計」檢舉次數
   - 若未設定 REPORT_API_URL：就只做「本機端」檢舉/隱藏
   - 建議用 Google Apps Script 當簡易 API（免費）
========================= */
const REPORT_HIDE_THRESHOLD = Number(window.RANK_REPORT_HIDE_THRESHOLD || 3); // 達到幾次檢舉就自動隱藏（建議 3~5）
const REPORT_API_URL = (window.RANK_REPORT_API_URL || ""); // TODO: 貼上 Apps Script Web App 的 /exec URL
const REPORT_RATE_LIMIT_HOURS = Number(window.RANK_REPORT_RATE_LIMIT_HOURS || 24); // 同一台裝置同一角色多久只能檢舉一次（避免狂點）

const LS_REPORT_COUNTS = "rank_report_v1_counts";        // fallback：無後台時用（本機累計）
const LS_REPORT_REPORTED_AT = "rank_report_v1_reported"; // 本機：上次檢舉時間（用於限流）

const reportCountCache = new Map();    // key -> count（後台回傳）
const reportModeCache  = new Map();    // key -> "WHITELIST" | "BLACKLIST"（後台回傳）
const reportRequestedKeys = new Set(); // 避免同一 key 反覆打 API

// ✅ 管理員模式（需要後台 + ADMIN_TOKEN）
const LS_ADMIN_TOKEN = "rank_admin_v1_token";
const LS_ADMIN_SHOW_HIDDEN = "rank_admin_v1_showHidden";
let adminToken = "";
let adminVerified = false;
let adminShowHidden = true;
let adminBtnEl = null;
let adminShowHiddenWrapEl = null;

function loadAdminState(){
  try{ adminToken = (localStorage.getItem(LS_ADMIN_TOKEN) || "").trim(); } catch {}
  try{
    const v = localStorage.getItem(LS_ADMIN_SHOW_HIDDEN);
    adminShowHidden = (v === null) ? true : (v === "1");
  } catch {}
}
function saveAdminShowHidden(){
  try{ localStorage.setItem(LS_ADMIN_SHOW_HIDDEN, adminShowHidden ? "1" : "0"); } catch {}
}
function isAdmin(){
  return !!adminToken && adminVerified && hasReportBackend();
}
function setAdminToken(t, verified){
  adminToken = String(t || "").trim();
  if (!adminToken) adminVerified = false;
  else if (typeof verified === "boolean") adminVerified = verified;
  try{
    if (adminToken) localStorage.setItem(LS_ADMIN_TOKEN, adminToken);
    else localStorage.removeItem(LS_ADMIN_TOKEN);
  } catch {}
  updateAdminUi();
  // 重新渲染（可能影響是否隱藏）
  if (typeof dataLoaded !== "undefined" && dataLoaded){
    if (activeTab === "topExp") renderTop("exp");
    else if (activeTab === "topBp") renderTop("bp");
    else if (activeTab === "result") runSearch();
    if (aroundState && aroundState.enabled) renderAroundTable();
  }
}
function updateAdminUi(){
  if (!adminBtnEl) return;
  adminBtnEl.textContent = isAdmin() ? "管理員：已登入" : (adminToken ? "管理員：驗證中" : "管理員模式");
  if (adminShowHiddenWrapEl){
    adminShowHiddenWrapEl.style.display = isAdmin() ? "inline-flex" : "none";
  }
}
function initAdminUi(){
  loadAdminState();
  const controls = document.querySelector(".controls") || document.getElementById("controls");
  if (!controls) return;

  // 管理員按鈕
  const btn = document.createElement("button");
  btn.type = "button";
  btn.id = "adminBtn";
  btn.className = "secondary";
  btn.style.whiteSpace = "nowrap";
  btn.addEventListener("click", async ()=>{
    if (!hasReportBackend()){
      alert("請先在 rank.html 設定 RANK_REPORT_API_URL（Apps Script /exec）。");
      return;
    }
    if (isAdmin()){
      if (confirm("要登出管理員模式嗎？")){
        setAdminToken("");
      }
      return;
    }
    const t = prompt("輸入管理員 Token（Apps Script 的 ADMIN_TOKEN）");
    if (t && String(t).trim()){
      const cand = String(t).trim();
      // ✅ 先跟後端驗證 Token，正確才算登入
      try{ setStatus("正在驗證管理員 Token…", true); } catch {}
      const ok = await verifyAdminToken(cand);
      if (ok){
        setAdminToken(cand, true);
        try{ setStatus("管理員登入成功。", true); } catch {}
      } else {
        setAdminToken("", false);
        try{ setStatus("管理員 Token 錯誤，登入失敗。", false); } catch {}
        alert("Token 錯誤，無法登入管理員模式。");
      }
    }
  });
  controls.appendChild(btn);

  // 顯示被隱藏：checkbox（只有管理員看得到）
  const wrap = document.createElement("label");
  wrap.className = "small";
  wrap.style.display = "inline-flex";
  wrap.style.alignItems = "center";
  wrap.style.gap = "6px";
  wrap.style.marginLeft = "6px";
  wrap.style.userSelect = "none";
  const cb = document.createElement("input");
  cb.type = "checkbox";
  cb.checked = !!adminShowHidden;
  cb.addEventListener("change", ()=>{
    adminShowHidden = !!cb.checked;
    saveAdminShowHidden();
    if (typeof dataLoaded !== "undefined" && dataLoaded){
      if (activeTab === "topExp") renderTop("exp");
      else if (activeTab === "topBp") renderTop("bp");
      else if (activeTab === "result") runSearch();
      if (aroundState && aroundState.enabled) renderAroundTable();
    }
  });
  wrap.appendChild(cb);
  wrap.appendChild(document.createTextNode("顯示被檢舉隱藏"));
  controls.appendChild(wrap);

  adminBtnEl = btn;
  adminShowHiddenWrapEl = wrap;
  updateAdminUi();
  // 若 localStorage 已有 token，啟動時先驗證一次，避免「亂輸也顯示已登入」
  verifyStoredAdminToken();
}

function clearLocalReportForKey(key){
  const local = getLocalReportCounts();
  if (local && (key in local)){ delete local[key]; setLocalReportCounts(local); }
  const m = getLocalReportedAt();
  if (m && (key in m)){ delete m[key]; setLocalReportedAt(m); }
}

async function adminOp(op, key, label){
  if (!isAdmin()){
    setStatus("請先登入管理員模式。", false);
    return;
  }
  const opText = ({whitelist:"加入白名單（免疫檢舉）", blacklist:"強制黑名單（直接隱藏）", clear:"取消白/黑名單", resetcount:"檢舉歸零"})[op] || op;
  const ok = confirm(`確定要對「${label}」執行：${opText}？`);
  if (!ok) return;

  const url = `${REPORT_API_URL}?action=admin&op=${encodeURIComponent(op)}&key=${encodeURIComponent(key)}&token=${encodeURIComponent(adminToken)}`;
  let js = null;
  try{
    js = await jsonpRequest(url, 10000);
  } catch (err){
    setStatus("管理操作失敗：" + (err?.message || err), false);
    return;
  }
  if (!js || !js.ok){
    setStatus("管理操作失敗：" + (js?.error || "unknown"), false);
    return;
  }

  if (op === "whitelist"){
    reportModeCache.set(key, "WHITELIST");
    reportCountCache.set(key, 0);
    clearLocalReportForKey(key);
    setStatus(`已加入白名單：${label}（之後不會再因檢舉自動隱藏）`, true);
    reportRequestedKeys.delete(key);
    scheduleReportFetchAndRerender([key]); // 強制回讀後台，避免只有本機快取生效
  } else if (op === "blacklist"){
    reportModeCache.set(key, "BLACKLIST");
    reportCountCache.set(key, 9999);
    clearLocalReportForKey(key);
    setStatus(`已強制黑名單：${label}`, true);
    reportRequestedKeys.delete(key);
    scheduleReportFetchAndRerender([key]); // 強制回讀後台，避免只有本機快取生效
  } else if (op === "clear"){
    reportModeCache.delete(key);
    reportCountCache.delete(key);
    reportRequestedKeys.delete(key);
    clearLocalReportForKey(key);
    setStatus(`已取消白/黑名單：${label}`, true);
    scheduleReportFetchAndRerender([key]); // 重新抓一次真實 count
  } else if (op === "resetcount"){
    reportCountCache.set(key, 0);
    clearLocalReportForKey(key);
    setStatus(`已將檢舉歸零：${label}`, true);
    scheduleReportFetchAndRerender([key]);
  }

  // 依目前頁面重繪一次
  if (typeof dataLoaded !== "undefined" && dataLoaded){
    if (activeTab === "topExp") renderTop("exp");
    else if (activeTab === "topBp") renderTop("bp");
    else if (activeTab === "result") runSearch();
    if (aroundState && aroundState.enabled) renderAroundTable();
  }
}

function adminButtonsHtml(name, world, job){
  if (!isAdmin()) return "";
  const key = reportKey(world, name);
  const mode = reportModeCache.get(key) || "";
  const badge = mode === "WHITELIST"
    ? `<span class="mono" title="白名單（免疫檢舉）" style="margin-left:6px">W</span>`
    : (mode === "BLACKLIST"
      ? `<span class="mono" title="黑名單（強制隱藏）" style="margin-left:6px">B</span>`
      : "");
  const label = `${normalizeText(name)}（${normalizeText(world)}）`;
  return (
    ` <button type="button" class="miniBtn primary" data-action="admin_whitelist" data-key="${escapeHtml(key)}" data-label="${escapeHtml(label)}">白</button>` +
    ` <button type="button" class="miniBtn danger" data-action="admin_blacklist" data-key="${escapeHtml(key)}" data-label="${escapeHtml(label)}">黑</button>` +
    ` <button type="button" class="miniBtn" data-action="admin_clear" data-key="${escapeHtml(key)}" data-label="${escapeHtml(label)}">清</button>` +
    ` <button type="button" class="miniBtn" data-action="admin_resetcount" data-key="${escapeHtml(key)}" data-label="${escapeHtml(label)}">0</button>` +
    badge
  );
}

function reportKey(world, name){
  const w = normalizeText(world).toLowerCase();
  const n = normalizeText(name).toLowerCase();
  return `${w}||${n}`;
}
function hasReportBackend(){
  return /^https?:\/\//i.test((REPORT_API_URL || "").trim());
}
function readJsonLs(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    const v = JSON.parse(raw);
    return (v ?? fallback);
  } catch {
    return fallback;
  }
}
function writeJsonLs(key, val){
  try{ localStorage.setItem(key, JSON.stringify(val)); } catch {}
}
function getLocalReportCounts(){
  return readJsonLs(LS_REPORT_COUNTS, {});
}
function setLocalReportCounts(obj){
  writeJsonLs(LS_REPORT_COUNTS, obj || {});
}
function getLocalReportedAt(){
  return readJsonLs(LS_REPORT_REPORTED_AT, {});
}
function setLocalReportedAt(obj){
  writeJsonLs(LS_REPORT_REPORTED_AT, obj || {});
}
function canReportNow(key){
  const m = getLocalReportedAt();
  const last = Number(m[key] || 0);
  if (!last) return true;
  return (Date.now() - last) >= (REPORT_RATE_LIMIT_HOURS * 3600 * 1000);
}
function markReportedNow(key){
  const m = getLocalReportedAt();
  m[key] = Date.now();
  setLocalReportedAt(m);
}
function getReportCount(key){
  // 後台白/黑名單優先（可覆蓋本機累計）
  const mode = reportModeCache.get(key);
  if (mode === "WHITELIST") return 0;
  if (mode === "BLACKLIST") return 9999;

  const local = getLocalReportCounts();
  const localCount = Number(local[key] || 0);
  const safeLocal = Number.isFinite(localCount) ? localCount : 0;

  if (!hasReportBackend()){
    return safeLocal;
  }
  const serverCount = reportCountCache.get(key);
  const safeServer = (typeof serverCount === "number" && Number.isFinite(serverCount)) ? serverCount : 0;
  return Math.max(safeServer, safeLocal); // 讓你自己檢舉後可立即隱藏
}
function isHiddenByReport(world, name){
  const key = reportKey(world, name);
  const c = getReportCount(key);
  return (typeof c === "number" && c >= REPORT_HIDE_THRESHOLD);
}
function shouldHideByReport(world, name){
  // 管理員模式可選擇「仍顯示被隱藏的資料」
  if (isAdmin() && adminShowHidden) return false;
  return isHiddenByReport(world, name);
}
function reportButtonHtml(name, world, job){
  const key = reportKey(world, name);
  const c = getReportCount(key);
  const tip = `檢舉累計：${c}（達 ${REPORT_HIDE_THRESHOLD} 次自動隱藏）`;
  return `<button type="button" class="miniBtn danger" data-action="report" data-name="${escapeHtml(name)}" data-world="${escapeHtml(world)}" data-job="${escapeHtml(job || "")}" title="${escapeHtml(tip)}">檢舉</button>`;
}

function jsonpRequest(url, timeoutMs = 8000){
  return new Promise((resolve, reject) => {
    const cb = "jsonp_cb_" + Math.random().toString(36).slice(2);
    const sep = url.includes("?") ? "&" : "?";
    const src = url + sep + "callback=" + encodeURIComponent(cb);

    let done = false;
    const script = document.createElement("script");

    const cleanup = () => {
      if (done) return;
      done = true;
      try{ delete window[cb]; } catch { window[cb] = undefined; }
      if (script && script.parentNode) script.parentNode.removeChild(script);
      if (timer) clearTimeout(timer);
    };

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("JSONP timeout"));
    }, timeoutMs);

    window[cb] = (data) => {
      cleanup();
      resolve(data);
    };

    script.src = src;
    script.async = true;
    script.onerror = () => {
      cleanup();
      reject(new Error("JSONP load error"));
    };
    document.head.appendChild(script);
  });
}


async function verifyAdminToken(token){
  if (!hasReportBackend()) return false;
  const t = String(token || "").trim();
  if (!t) return false;
  // 用「admin clear 一個不會存在的 key」當成 ping，不會改動任何真實資料
  const url = `${REPORT_API_URL}?action=admin&op=clear&key=__admin_ping__&token=${encodeURIComponent(t)}`;
  try{
    const res = await jsonpRequest(url, 10000);
    return !!res && res.ok === true;
  } catch {
    return false;
  }
}

async function verifyStoredAdminToken(){
  if (!adminToken) return;
  adminVerified = false;
  updateAdminUi();
  const ok = await verifyAdminToken(adminToken);
  if (ok){
    adminVerified = true;
    updateAdminUi();
  } else {
    setAdminToken("", false);
    try{ alert("管理員 Token 無效或已失效，已自動登出。"); } catch {}
  }
}

async function fetchReportCounts(keys){
  if (!hasReportBackend()) return { ok:false, loaded:0 };

  const uniq = Array.from(new Set(keys)).filter(Boolean);
  const want = uniq.filter(k =>
    k &&
    (!reportCountCache.has(k) || !reportModeCache.has(k)) &&
    !reportRequestedKeys.has(k)
  );

  if (!want.length) return { ok:true, loaded:0 };
  want.forEach(k => reportRequestedKeys.add(k));

  const url = `${REPORT_API_URL}?action=get&keys=${encodeURIComponent(JSON.stringify(want))}`;

  let js = null;
  // 先嘗試正常 fetch（若後台有 CORS 會成功）
  try{
    const res = await fetch(url, { cache: "no-store" });
    js = await res.json();
  } catch (err){
    // 若被 CORS 擋住，改用 JSONP（後台需支援 callback）
    try{
      js = await jsonpRequest(url, 9000);
    } catch (err2){
      console.warn("檢舉統計讀取失敗：", err2);
      // 失敗要解除鎖定，避免這批 key 之後都不再重試
      want.forEach(k => reportRequestedKeys.delete(k));
      return { ok:false, loaded:0 };
    }
  }

  if (!js || js.ok === false){
    console.warn("檢舉統計讀取失敗（後端回錯誤）：", js?.error || js);
    want.forEach(k => reportRequestedKeys.delete(k));
    return { ok:false, loaded:0 };
  }

  const counts = (js && typeof js === "object" && js.counts) ? js.counts : (js || {});
  const modes = (js && typeof js === "object" && js.modes) ? js.modes : {};

  let loaded = 0;
  for (const k of want){
    const num = Number(counts?.[k] ?? 0);
    reportCountCache.set(k, Number.isFinite(num) ? num : 0);

    const modeRaw = String(modes?.[k] || "").trim().toUpperCase();
    if (modeRaw === "WHITELIST" || modeRaw === "BLACKLIST") reportModeCache.set(k, modeRaw);
    else reportModeCache.set(k, ""); // 記錄「已查過但無覆蓋」

    loaded++;
  }
  return { ok:true, loaded };
}
function scheduleReportFetchAndRerender(keys){
  if (!hasReportBackend()) return;
  fetchReportCounts(keys).then(({loaded})=>{
    if (loaded <= 0) return;
    // 依目前頁面重繪一次
    if (activeTab === "topExp") renderTop("exp");
    else if (activeTab === "topBp") renderTop("bp");
    else if (activeTab === "result") runSearch();
    if (aroundState.enabled) renderAroundTable();
  });
}
async function submitReport({name, world, job}){
  const n = normalizeText(name);
  const w = normalizeText(world);
  if (!n || !w) return;

  const key = reportKey(w, n);

  if (!canReportNow(key)){
    setStatus(`你剛剛已檢舉過「${n}（${w}）」了，${REPORT_RATE_LIMIT_HOURS} 小時內只能檢舉一次。`, false);
    return;
  }

  const ok = confirm(`確定要檢舉「${n}（${w}）」？\n累計檢舉達 ${REPORT_HIDE_THRESHOLD} 次會自動隱藏。`);
  if (!ok) return;

  // 本機先記一筆：讓你自己馬上看不到
  markReportedNow(key);
  const local = getLocalReportCounts();
  local[key] = Math.max(1, Number(local[key] || 0) + 1);
  setLocalReportCounts(local);

  if (!hasReportBackend()){
    setStatus(`已檢舉（本機累計 ${local[key]} 次）。`, true);
  } else {
    let js = null;
    // 先嘗試 POST（若後台有 CORS 會成功）
    try{
      setStatus("送出檢舉中…", true);
      const res = await fetch(`${REPORT_API_URL}?action=report`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          key,
          name: n,
          world: w,
          job: job || "",
          ts: Date.now(),
          ua: navigator.userAgent || ""
        })
      });
      js = await res.json().catch(()=>null);
    } catch (err){
      // CORS / 後台未設：改用 JSONP GET（後台需支援 callback）
      try{
        const u = `${REPORT_API_URL}?action=report&key=${encodeURIComponent(key)}&name=${encodeURIComponent(n)}&world=${encodeURIComponent(w)}&job=${encodeURIComponent(job || "")}`;
        js = await jsonpRequest(u, 9000);
      } catch (err2){
        console.warn(err2);
        setStatus("已在本機隱藏，但檢舉送出失敗（可能尚未設定後台）。", false);
      }
    }

    const count = Number(js?.count ?? js?.counts?.[key] ?? js?.[key] ?? NaN);
    if (Number.isFinite(count)){
      reportCountCache.set(key, count);
      setStatus(`已檢舉：目前累計 ${count} 次。`, true);
    } else if (js) {
      setStatus("已檢舉（後台未回傳累計次數）。", true);
    }
  }

  // 重新渲染（讓被隱藏的立即消失）
  if (activeTab === "topExp") renderTop("exp");
  else if (activeTab === "topBp") renderTop("bp");
  else if (activeTab === "result") runSearch();
  if (aroundState.enabled) renderAroundTable();
}


const $ = (id) => document.getElementById(id);

const overlay = $("overlay");
const overlayTitle = $("overlayTitle");
const overlaySub = $("overlaySub");
const progressBar = $("progressBar");
const progressPct = $("progressPct");
const progressHint = $("progressHint");

const faqModalEl = $("faqModal");
const faqCloseBtn = $("faqCloseBtn");
const faqOkBtn = $("faqOkBtn");

const statusEl = $("status");
const contentEl = $("content");
const nameInput = $("nameInput");
const worldSelect = $("worldSelect");
const jobSelect = $("jobSelect");
const searchBtn = $("searchBtn");
const shareBtn = $("shareBtn");
const tabResult = $("tabResult");
const tabTopExp = $("tabTopExp");
const tabTopBp = $("tabTopBp");
const metaInfo = $("metaInfo");
const faqInlineEl = $("faqInline");

/* ✅ 附近榜 UI */
const aroundControls = $("aroundControls");
const tabAroundExp = $("tabAroundExp");
const tabAroundBp = $("tabAroundBp");
const btnUp50 = $("btnUp50");
const btnDown50 = $("btnDown50");
const aroundMeta = $("aroundMeta");
const aroundHint = $("aroundHint");

let rows = [];              // {rowIdx, name, world, job, exp, bp, updatedText, updatedDate}
let dataLoaded = false;
let dataLoadingPromise = null;
let pendingWorld = null;
let pendingJob = null;
let pendingAutoRun = false; // URL 帶 name 時：載入完成後自動查詢

function applyDataLoadedUi(){
  const ready = !!dataLoaded;
  shareBtn.disabled = !ready;
  tabTopExp.disabled = !ready;
  tabTopBp.disabled = !ready;
  worldSelect.disabled = !ready;
  jobSelect.disabled = !ready;

  tabAroundExp.disabled = !ready;
  tabAroundBp.disabled = !ready;
  btnUp50.disabled = !ready;
  btnDown50.disabled = !ready;
}

async function ensureDataLoaded(){
  if (dataLoaded) return true;
  if (dataLoadingPromise) return dataLoadingPromise;

  dataLoadingPromise = (async ()=>{
    await loadData();
    dataLoaded = true;

    if (pendingWorld){
      const wantWorld = pendingWorld;
      const hasWorld = Array.from(worldSelect.options).some(o => o.value === wantWorld);
      worldSelect.value = hasWorld ? wantWorld : "__ALL__";
    }

    refreshJobOptions(false);

    if (pendingJob){
      const wantJob = pendingJob;
      const hasJob = Array.from(jobSelect.options).some(o => o.value === wantJob);
      jobSelect.value = hasJob ? wantJob : "__ALL_JOB__";
    } else {
      jobSelect.value = "__ALL_JOB__";
    }

    pendingWorld = null;
    pendingJob = null;

    applyDataLoadedUi();

    // ✅ 載入成功：收起 overlay（避免卡在 92%）
    finishLoadingProgress(true);
    setTimeout(()=>hideOverlay(), 260);

    if (pendingAutoRun){
      pendingAutoRun = false;
      setActiveTab("result");
    }
    return true;
  })().catch(err=>{
    dataLoadingPromise = null;
    throw err;
  });

  return dataLoadingPromise;
}

let worlds = [];
let rankCache = new Map();      // key(world or "__ALL__") -> {expRank,bpRank,expSorted,bpSorted}
let jobRankCache = new Map();   // `${worldKey}||${job}` -> {expJobRank,bpJobRank}
let loadedAt = null;
let latestUpdated = null;
let activeTab = "result";

// ✅ 是否使用者曾「手動」調整過伺服器（避免預設=挑戰者造成首次查不到）
let worldUserTouched = false;
// ✅ 同名角色時：可鎖定只看其中一筆
let pinnedRowIdx = null;
/* ✅ 附近榜狀態 */
let aroundState = {
enabled: false,
metric: "exp",            // "exp" | "bp"
worldKey: "__ALL__",      // "__ALL__" or specific world
centerRowIdx: null,       // 以哪一筆資料當中心（rowIdx）
listStart: 0,             // 目前顯示區間起點（0-based index on sorted list）
pageSize: 50
};

/* =========================
  ✅ 搜尋紀錄（LocalStorage）
  - 雙擊名稱輸入框顯示
  - Up/Down 選取、Enter 套用、Esc 關閉
========================= */
const HISTORY_KEY = "ms_rank_search_history_v1";
const HISTORY_LIMIT = 25;

let historyDropdownEl = null;
let historyOpen = false;
let historyActiveIndex = -1;
let historyFiltered = [];

function safeParseJson(s, fallback){
try { return JSON.parse(s); } catch { return fallback; }
}
function loadSearchHistory(){
try{
const raw = localStorage.getItem(HISTORY_KEY);
const arr = safeParseJson(raw, []);
return Array.isArray(arr) ? arr : [];
} catch {
return [];
}
}
function saveSearchHistory(arr){
try{
localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
} catch {
// private mode / no quota：忽略
}
}
function normalizeHistoryKey(name, world, job){
return `${name}||${world}||${job}`;
}
function addSearchHistory(name, world, job){
const n = (name ?? "").toString().trim();
if (!n) return;

const w = (world ?? "__ALL__").toString();
const j = (job ?? "__ALL_JOB__").toString();
const key = normalizeHistoryKey(n, w, j);

const list = loadSearchHistory();
const now = Date.now();

// 去重：相同 name+world+job 移到最前面
const next = [];
next.push({ key, name: n, world: w, job: j, ts: now });

for (const it of list){
if (!it) continue;
if (it.key === key) continue;
if ((it.name ?? "").toString().trim() === "" ) continue;
next.push(it);
if (next.length >= HISTORY_LIMIT) break;
}
saveSearchHistory(next);
}
function clearSearchHistory(){
try{ localStorage.removeItem(HISTORY_KEY); } catch {}
}
function ensureHistoryDropdown(){
if (historyDropdownEl) return;

historyDropdownEl = document.createElement("div");
historyDropdownEl.id = "historyDropdown";
historyDropdownEl.className = "history-dropdown";
historyDropdownEl.setAttribute("role", "listbox");

// 防止點下拉時 input 失焦導致先關掉
historyDropdownEl.addEventListener("mousedown", (e)=>{ e.preventDefault(); });

historyDropdownEl.addEventListener("click", (e)=>{
const clearBtn = e.target.closest("[data-action='clear']");
if (clearBtn){
clearSearchHistory();
renderHistoryDropdown(nameInput.value);
setStatus("已清除搜尋紀錄。", true);
return;
}
const btn = e.target.closest("[data-hindex]");
if (!btn) return;
const idx = Number(btn.getAttribute("data-hindex"));
if (!Number.isFinite(idx)) return;
applyHistoryByIndex(idx);
});

document.body.appendChild(historyDropdownEl);
}
function isHistoryShown(){
return !!historyDropdownEl && historyDropdownEl.classList.contains("show");
}
function positionHistoryDropdown(){
if (!historyDropdownEl) return;

const rect = nameInput.getBoundingClientRect();
const margin = 6;

// 盡量跟輸入框同寬
let left = rect.left;
let width = rect.width;

// 避免超出視窗
const maxRight = window.innerWidth - 8;
if (left + width > maxRight){
left = Math.max(8, maxRight - width);
}

// 下拉高度：避免超出底部
const top = rect.bottom + margin;
const maxH = Math.max(160, window.innerHeight - top - 12);

historyDropdownEl.style.left = Math.round(left) + "px";
historyDropdownEl.style.top = Math.round(top) + "px";
historyDropdownEl.style.width = Math.round(width) + "px";
historyDropdownEl.style.maxHeight = Math.round(maxH) + "px";
}
function worldTextOf(v){
return (v === "__ALL__") ? "全部伺服器" : v;
}
function jobTextOf(v){
return (v === "__ALL_JOB__") ? "全部職業" : v;
}
function formatTime(ts){
try{
if (!ts) return "";
return new Date(ts).toLocaleString("zh-TW");
} catch { return ""; }
}
function renderHistoryDropdown(filterText){
ensureHistoryDropdown();

const q = (filterText ?? "").toString().trim();
const list = loadSearchHistory();

// 篩選：輸入框有字就只顯示包含字串的
let filtered = list;
if (q){
filtered = list.filter(it => ((it?.name ?? "") + "").includes(q));
}

historyFiltered = filtered.slice(0, HISTORY_LIMIT);
historyActiveIndex = Math.min(historyActiveIndex, historyFiltered.length - 1);

let html = `
   <div class="history-topbar">
     <div class="history-title">搜尋紀錄（雙擊可叫出｜↑↓選擇 Enter 套用 Esc 關閉）</div>
     <button type="button" class="history-clear" data-action="clear">清除</button>
   </div>
 `;

if (!historyFiltered.length){
html += `<div class="history-empty">目前沒有搜尋紀錄。</div>`;
} else {
html += `<div class="history-list">`;
historyFiltered.forEach((it, idx)=>{
const active = (idx === historyActiveIndex) ? " active" : "";
const name = escapeHtml(it?.name ?? "");
const w = escapeHtml(worldTextOf(it?.world ?? "__ALL__"));
const j = escapeHtml(jobTextOf(it?.job ?? "__ALL_JOB__"));
const t = escapeHtml(formatTime(it?.ts));
html += `
       <button type="button" class="history-item${active}" data-hindex="${idx}">
         <div><span class="history-name">${name}</span></div>
         <div class="history-meta">${w}　|　${j}${t ? "　|　" + t : ""}</div>
       </button>
     `;
});
html += `</div>`;
}

historyDropdownEl.innerHTML = html;
}
function showHistoryDropdown(){
ensureHistoryDropdown();
positionHistoryDropdown();
historyOpen = true;

// 預設選第一筆
historyActiveIndex = 0;
renderHistoryDropdown(nameInput.value);

historyDropdownEl.classList.add("show");
}
function hideHistoryDropdown(){
if (!historyDropdownEl) return;
historyOpen = false;
historyActiveIndex = -1;
historyFiltered = [];
historyDropdownEl.classList.remove("show");
}
function moveHistoryActive(delta){
if (!historyFiltered.length) return;
const n = historyFiltered.length;
let next = historyActiveIndex;
if (!Number.isFinite(next) || next < 0) next = 0;
next = Math.max(0, Math.min(n - 1, next + delta));
historyActiveIndex = next;
renderHistoryDropdown(nameInput.value);

// 確保可見
const btn = historyDropdownEl.querySelector(`.history-item[data-hindex="${next}"]`);
if (btn && btn.scrollIntoView){
btn.scrollIntoView({ block: "nearest" });
}
}
function applyHistoryByIndex(idx){
  const it = historyFiltered[idx];
  if (!it) return;

  nameInput.value = (it.name ?? "").toString();

  // ✅ Lazy Load：先記住想套用的 world/job，等資料載入後再套用
  pendingWorld = (it.world ?? "__ALL__").toString();
  pendingJob   = (it.job ?? "__ALL_JOB__").toString();
  worldUserTouched = true;

  hideHistoryDropdown();
  activateTab("result");
}
/* ========================= */

/* ===== 進度條（假進度：0→92，完成跳 100） ===== */
let progressValue = 0;
let progressTimer = null;
let progressTicks = 0;

function setProgress(p, hint){
progressValue = Math.max(0, Math.min(100, p));
const pct = Math.round(progressValue);
progressBar.style.width = pct + "%";
progressPct.textContent = pct + "%";
if (typeof hint === "string") progressHint.textContent = hint;
}
function startLoadingProgress(){
stopLoadingProgress();
progressValue = 0;
progressTicks = 0;
setProgress(1, "連線中…");
progressTimer = setInterval(()=>{
progressTicks++;
if (progressTicks === 8)  progressHint.textContent = "下載資料中…";
if (progressTicks === 28) progressHint.textContent = "解析資料中…";
if (progressTicks === 55) progressHint.textContent = "整理清單中…";
const target = 92;
const step = Math.max(0.35, (target - progressValue) * 0.06);
progressValue = Math.min(target, progressValue + step);
setProgress(progressValue);
}, 120);
}
function stopLoadingProgress(){
if (progressTimer){
clearInterval(progressTimer);
progressTimer = null;
}
}
function finishLoadingProgress(ok){
stopLoadingProgress();
if (ok){
setProgress(98, "即將完成…");
setTimeout(()=>setProgress(100, "完成"), 120);
} else {
setProgress(100, "失敗");
}
}
/* ================================================ */

function setUiDisabled(disabled){
searchBtn.disabled = disabled;
shareBtn.disabled = disabled;
tabResult.disabled = disabled;
tabTopExp.disabled = disabled;
tabTopBp.disabled = disabled;
nameInput.disabled = disabled;
worldSelect.disabled = disabled;
jobSelect.disabled = disabled;

tabAroundExp.disabled = disabled;
tabAroundBp.disabled = disabled;
btnUp50.disabled = disabled;
btnDown50.disabled = disabled;
}
function showOverlay(title="資料載入中…", sub="正在抓取最新資料，請稍候。"){
overlayTitle.textContent = title;
overlaySub.textContent = sub;
overlay.classList.add("show");
setUiDisabled(true);
startLoadingProgress();
}
function hideOverlay(){
overlay.classList.remove("show");
setUiDisabled(false);
}

function setStatus(msg, ok=true){
statusEl.textContent = msg;
statusEl.className = "status " + (ok ? "ok" : "bad");
}

function hideFaqInline(){
  if (!faqInlineEl) return;
  faqInlineEl.style.display = "none";
  faqInlineEl.innerHTML = "";
}

function showFaqInline(){
  if (!faqInlineEl) return;
  faqInlineEl.innerHTML = `
    <div class="faq-title">常見問題</div>
    <div class="faq-q">Q：查不到角色怎麼辦？＆ 轉移過伺服器也一樣要重新搜尋登錄！</div>
    <div class="faq-p">本資料庫收錄 <b>挑戰者服 260 以上</b>、<b>一般服 270 以上</b> 角色。</div>
    <div class="faq-p">若符合條件但未顯示，請至
      <a href="https://opencheapgpt.pse.is/opencheapgpt" target="_blank" rel="noopener">https://opencheapgpt.pse.is/opencheapgpt</a>
      搜尋角色暱稱，數分鐘後將自動收錄，或隔天再查詢看看。</div>
  `;
  faqInlineEl.style.display = "block";
}

function ensureFaqModalDom(){
  // ✅ 保險：就算使用者部署到舊版（不小心沒帶 faqModal），也能動態補上
  let el = document.getElementById("faqModal");
  if (el) return el;

  const html = `
<div id="faqModal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="faqModal" aria-hidden="true"></div>
  <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
    <div class="modal-head">
      <div id="faqTitle" class="modal-title">常見問題</div>
      <button id="faqCloseBtn" type="button" class="secondary modal-close" aria-label="關閉">✕</button>
    </div>
    <div class="modal-body">
      <div class="faq-q">Q：查不到角色怎麼辦？＆ 轉移過伺服器也一樣要重新搜尋登錄！</div>
      <div class="faq-p">本資料庫收錄 挑戰者服 260 以上、一般服 270 以上角色。</div>
      <div class="faq-p">第一次查詢，請至
        <a href="https://opencheapgpt.pse.is/opencheapgpt" target="_blank" rel="noopener">https://opencheapgpt.pse.is/opencheapgpt</a>
        輸入角色名稱，數分鐘後將自動收錄，或隔天再查詢看看。
      </div>
    </div>
    <div class="modal-foot">
      <button id="faqOkBtn" type="button">知道了</button>
    </div>
  </div>
</div>`;
  document.body.insertAdjacentHTML("afterbegin", html);
  el = document.getElementById("faqModal");
  return el;
}

function showFaqModal(){
  const el = ensureFaqModalDom();
  if (!el) return;

  // ✅ 用 inline style 強制顯示（避免任何 CSS / 快取 / 覆蓋規則導致 .show 無效）
  el.classList.add("show");
  el.style.display = "block";
  el.style.zIndex = "200000";
  el.setAttribute("aria-hidden","false");

  // 讓使用者可直接按 Enter 關閉（部分瀏覽器 focus(options) 可能不支援，所以 try/catch）
  try{
    const ok = el.querySelector("#faqOkBtn");
    if (ok && ok.focus) ok.focus({preventScroll:true});
  } catch {
    // ignore
  }
}

function hideFaqModal(){
  const el = document.getElementById("faqModal");
  if (!el) return;
  el.classList.remove("show");
  el.style.display = "none";
  el.setAttribute("aria-hidden","true");
}
if (faqCloseBtn) faqCloseBtn.addEventListener("click", hideFaqModal);
if (faqOkBtn) faqOkBtn.addEventListener("click", hideFaqModal);
document.addEventListener("click", (e) => {
  const t = e.target;
  if (!t) return;

  // ✅ 動態插入時也能關閉（保險）
  if (t.id === "faqCloseBtn" || t.id === "faqOkBtn") {
    hideFaqModal();
    return;
  }

  if (t.getAttribute && t.getAttribute("data-close") === "faqModal") hideFaqModal();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && document.getElementById("faqModal")?.classList.contains("show")) hideFaqModal();
});

function normalizeText(v){
const s = (v ?? "").toString();
return s.replace(/\u00A0/g,"").replace(/\u3000/g,"").trim();
}
function toNumber(v){
if (v === null || v === undefined) return null;
if (typeof v === "number" && Number.isFinite(v)) return v;
const s = normalizeText(v);
if (!s) return null;
const n = Number(s.replace(/,/g,""));
return Number.isFinite(n) ? n : null;
}

/** 拆等級 / 經驗值%（✅ 去掉前導 0：067.096 -> 67.096） */
function splitLevelExpRate(expVal){
if (expVal === null || expVal === undefined || !Number.isFinite(expVal)) {
return { level: "-", expPct: "-" };
}

let level = Math.floor(expVal / 1000);
let rem = expVal - level * 1000;
if (rem >= 999.9995) { level += 1; rem = 0; }

const remFixed = rem.toFixed(3);
const [i, d] = remFixed.split(".");

const intPart = Number.parseInt(i, 10);
const cleanI = Number.isFinite(intPart) ? String(intPart) : (i || "0");

const expPct = cleanI + "." + d;
return { level, expPct };
}

/** 戰力顯示：1億358萬175 */
function formatBattlePower(v){
const n0 = toNumber(v);
if (n0 === null) return "-";
let n = Math.floor(n0);
if (!Number.isFinite(n)) return "-";

const units = [
{ value: 1e12, label: "兆" },
{ value: 1e8,  label: "億" },
{ value: 1e4,  label: "萬" },
];

let out = "";
for (const u of units){
const q = Math.floor(n / u.value);
if (q > 0){
out += `${q}${u.label}`;
n = n % u.value;
}
}
if (n > 0 || out === "") out += `${n}`;
return out;
}

/* =========================
  ✅ 並列排名工具（競賽排名：會跳號）
  例：1,1,3,4...
========================= */
function sameNumber(a, b, eps = 1e-9){
return (a !== null && b !== null && Number.isFinite(a) && Math.abs(a - b) <= eps);
}
function buildCompetitionRankMap(sortedList, getVal){
const m = new Map();
let prevVal = null;
let prevRank = 0;

for (let i = 0; i < sortedList.length; i++){
const r = sortedList[i];
const v = getVal(r);
let rank;

if (i === 0){
rank = 1;
} else if (sameNumber(v, prevVal)){
rank = prevRank;
} else {
rank = i + 1; // 競賽排名：跳號
}

m.set(r.rowIdx, rank);
prevVal = v;
prevRank = rank;
}
return m;
}
/* ========================= */

/** 日期解析 */
function parseDateLoose(s){
if (!s) return null;
const t = s.replace(" ", "T");
const d = new Date(t);
return isNaN(d.getTime()) ? null : d;
}
function parseUpdatedCell(cell){
const f = normalizeText(cell?.f);
if (f){
const d = parseDateLoose(f);
return { text: f, date: d };
}
const v = cell?.v;
if (v instanceof Date){
return { text: v.toLocaleString("zh-TW"), date: v };
}
const s = normalizeText(v);
if (!s) return { text: "-", date: null };

const m = s.match(/^Date\((\d+),(\d+),(\d+)(?:,(\d+),(\d+),(\d+))?\)$/);
if (m){
const yy = Number(m[1]);
const mm = Number(m[2]);
const dd = Number(m[3]);
const hh = Number(m[4] ?? 0);
const mi = Number(m[5] ?? 0);
const ss = Number(m[6] ?? 0);
const d = new Date(yy, mm, dd, hh, mi, ss);
return { text: d.toLocaleString("zh-TW"), date: d };
}

const d = parseDateLoose(s);
return { text: s, date: d };
}

function gvizUrl(){
const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
const params = new URLSearchParams({ tqx: "out:json", sheet: SHEET_NAME });
return `${base}?${params.toString()}`;
}
function parseGviz(text){
const start = text.indexOf("{");
const end = text.lastIndexOf("}");
if (start < 0 || end < 0) throw new Error("GViz 回傳格式不正確");
return JSON.parse(text.slice(start, end + 1));
}
function detectColIndex(cols, label){
return cols.findIndex(c => normalizeText(c.label) === label);
}
function escapeHtml(s){
return (s ?? "").toString()
.replaceAll("&","&amp;")
.replaceAll("<","&lt;")
.replaceAll(">","&gt;")
.replaceAll('"',"&quot;")
.replaceAll("'","&#039;");
}
function tableHtml(headers, rows2d){
const thead = `<thead><tr>${headers.map(h=>`<th>${h}</th>`).join("")}</tr></thead>`;
const tbody = `<tbody>${rows2d.map(r=>`<tr>${r.map(cell=>`<td>${cell}</td>`).join("")}</tr>`).join("")}</tbody>`;
return `<table>${thead}${tbody}</table>`;
}

/** ✅ 取得目前榜單使用的 worldKey：選全部就用 "__ALL__" */
function worldKeyForTop(){
return worldSelect.value; // "__ALL__" or specific world
}

/** ✅ 依目前選擇刷新職業下拉（全部伺服器 = 全伺服器職業） */
function refreshJobOptions(keepValue=true){
const worldKey = worldKeyForTop();
const prev = jobSelect.value;

const set = new Set();
for (const r of rows){
if (!r.job || r.job === "-" ) continue;
if (worldKey !== "__ALL__" && r.world !== worldKey) continue;
set.add(r.job);
}
const jobs = Array.from(set).sort((a,b)=>a.localeCompare(b, "zh-Hant"));

jobSelect.innerHTML = "";
const optAll = document.createElement("option");
optAll.value = "__ALL_JOB__";
optAll.textContent = "全部職業";
jobSelect.appendChild(optAll);

for (const j of jobs){
const opt = document.createElement("option");
opt.value = j;
opt.textContent = j;
jobSelect.appendChild(opt);
}

if (keepValue && prev && prev !== "__ALL_JOB__" && jobs.includes(prev)){
jobSelect.value = prev;
} else {
jobSelect.value = "__ALL_JOB__";
}
}

/* =========================
  ✅ 附近榜（經驗/戰力）+ 上下 50 名
========================= */
function setAroundTab(metric){
aroundState.metric = metric;

tabAroundExp.classList.toggle("active", metric === "exp");
tabAroundBp.classList.toggle("active", metric === "bp");

renderAroundTable();
}

function hideAroundControls(){
aroundControls.classList.remove("show");
aroundMeta.textContent = "";
aroundHint.textContent = "（以所選榜單為基準，顯示你附近的排名，可一直往上/往下翻）";

tabAroundExp.disabled = false;
tabAroundBp.disabled = false;

aroundState = {
enabled: false,
metric: "exp",
worldKey: "__ALL__",
centerRowIdx: null,
listStart: 0,
pageSize: 50
};

const markerId = "__around_block__";
const old = document.getElementById(markerId);
if (old) old.remove();
}

function showAroundControls(){
aroundControls.classList.add("show");
}

function initAroundForSingleResult(oneRow, worldKey){
aroundState.enabled = true;
aroundState.worldKey = worldKey;
aroundState.centerRowIdx = oneRow.rowIdx;
aroundState.pageSize = 50;

tabAroundExp.disabled = (oneRow.exp === null);
tabAroundBp.disabled  = (oneRow.bp  === null);

let defaultMetric = "exp";
if (oneRow.exp === null && oneRow.bp !== null) defaultMetric = "bp";
aroundState.metric = defaultMetric;

const pack = buildRanks(worldKey);
const list = (defaultMetric === "exp") ? pack.expSorted : pack.bpSorted;

const centerIdx = list.findIndex(r => r.rowIdx === oneRow.rowIdx);
if (centerIdx < 0){
hideAroundControls();
return;
}

const pageSize = aroundState.pageSize;
const halfUp = 25;
let start = Math.max(0, centerIdx - halfUp);
if (start + pageSize > list.length){
start = Math.max(0, list.length - pageSize);
}
aroundState.listStart = start;

showAroundControls();
setAroundTab(defaultMetric);
}

function renderAroundTable(){
if (!aroundState.enabled) return;

const worldKey = aroundState.worldKey;
const metric = aroundState.metric;
const pack = buildRanks(worldKey);

const list = (metric === "exp") ? pack.expSorted : pack.bpSorted;
const rankMap = (metric === "exp") ? pack.expRank : pack.bpRank;

const centerRank = rankMap.get(aroundState.centerRowIdx) ?? "-";

const worldText = (worldKey === "__ALL__") ? "全部伺服器" : worldKey;
const metricText = (metric === "exp") ? "經驗" : "戰力";
aroundMeta.textContent = `（${worldText}｜你的${metricText}排名：${centerRank === "-" ? "-" : "第" + centerRank + "名"}）`;

const start = Math.max(0, Math.min(aroundState.listStart, Math.max(0, list.length - aroundState.pageSize)));
aroundState.listStart = start;

const end = Math.min(list.length, start + aroundState.pageSize);
const slice = list.slice(start, end);

// ✅ 檢舉過多自動隱藏
const _aroundKeys = slice.map(r => reportKey(r.world, r.name));
scheduleReportFetchAndRerender(_aroundKeys);

const hiddenByReport = slice.filter(r => isHiddenByReport(r.world, r.name));
const sliceShown = slice.filter(r => !shouldHideByReport(r.world, r.name));

if (hiddenByReport.length){
  const extra = (isAdmin() && adminShowHidden) ? "｜管理員模式：仍顯示被隱藏" : "";
  aroundHint.textContent = `（已自動隱藏 ${hiddenByReport.length} 筆：檢舉≥${REPORT_HIDE_THRESHOLD}${extra}｜仍可一直往上/往下翻）`;
} else {
  aroundHint.textContent = "（以所選榜單為基準，顯示你附近的排名，可一直往上/往下翻）";
}

btnUp50.disabled = (start <= 0);
btnDown50.disabled = (end >= list.length);

let headers;
if (metric === "exp"){
  headers = ["排名","name","world","職業","等級","經驗值%","更新時間","檢舉"];
} else {
  headers = ["排名","name","world","職業","戰鬥力","更新時間","檢舉"];
}

const body = sliceShown.map(r=>{
  const rk = rankMap.get(r.rowIdx) ?? "-";
  const isCenter = (r.rowIdx === aroundState.centerRowIdx);
  const hiddenTag = isHiddenByReport(r.world, r.name) ? ` <span class="muted">（已隱藏）</span>` : "";
  const nameCellRaw = isCenter ? `<span class="pill">${escapeHtml(r.name)}</span>` : escapeHtml(r.name);
  const nameCell = nameCellRaw + hiddenTag;

  if (metric === "exp"){
    const s = splitLevelExpRate(r.exp);
    return [
      `<span class="mono">${rk === "-" ? "-" : "#" + rk}</span>`,
      nameCell,
      escapeHtml(r.world),
      escapeHtml(r.job),
      s.level,
      s.expPct,
      `<span class="nowrap">${escapeHtml(r.updatedText || "-")}</span>`,
      reportButtonHtml(r.name, r.world, r.job) + adminButtonsHtml(r.name, r.world, r.job)
    ];
  } else {
    const bpText = formatBattlePower(r.bp);
    return [
      `<span class="mono">${rk === "-" ? "-" : "#" + rk}</span>`,
      nameCell,
      escapeHtml(r.world),
      escapeHtml(r.job),
      `<span title="${escapeHtml(r.bp ?? "")}">${escapeHtml(bpText)}</span>`,
      `<span class="nowrap">${escapeHtml(r.updatedText || "-")}</span>`,
      reportButtonHtml(r.name, r.world, r.job) + adminButtonsHtml(r.name, r.world, r.job)
    ];
  }
});

const aroundHtml =
  `<div class="muted" style="margin-top:12px">你的附近排名（${metricText}榜｜每次顯示 50 名，可一直往上/往下翻）：</div>` +
  tableHtml(headers, body);

const markerId = "__around_block__";
const old = document.getElementById(markerId);
if (old) old.remove();

const wrap = document.createElement("div");
wrap.id = markerId;
wrap.innerHTML = aroundHtml;
contentEl.appendChild(wrap);
}

function shiftAround(deltaPages){
if (!aroundState.enabled) return;
const pageSize = aroundState.pageSize;
const pack = buildRanks(aroundState.worldKey);
const list = (aroundState.metric === "exp") ? pack.expSorted : pack.bpSorted;

let nextStart = aroundState.listStart + deltaPages * pageSize;
nextStart = Math.max(0, Math.min(nextStart, Math.max(0, list.length - pageSize)));
aroundState.listStart = nextStart;
renderAroundTable();
}
/* ========================= */

async function loadData(){
showOverlay("資料載入中…", "正在抓取最新資料，請稍候。");
setStatus("載入資料中…");

const res = await fetch(gvizUrl(), { cache: "no-store" });
const txt = await res.text();
const json = parseGviz(txt);

const table = json.table;
if (!table || !table.cols || !table.rows) throw new Error("讀不到資料表（可能未公開）");

setProgress(progressValue, "解析欄位中…");

const cols = table.cols;
const iName    = detectColIndex(cols, "name");
const iWorld   = detectColIndex(cols, "world_name");
const iJob     = detectColIndex(cols, "job");
const iExp     = detectColIndex(cols, "level_plus_exp_rate");
const iBp      = detectColIndex(cols, "battle_power");
const iUpdated = detectColIndex(cols, "updated");

const missing = [];
if (iName < 0)    missing.push("name");
if (iWorld < 0)   missing.push("world_name");
if (iJob < 0)     missing.push("job");
if (iExp < 0)     missing.push("level_plus_exp_rate");
if (iBp < 0)      missing.push("battle_power");
if (iUpdated < 0) missing.push("updated");
if (missing.length){
throw new Error("找不到欄位：" + missing.join(", ") + "（請確認標題列）");
}

setProgress(progressValue, "整理資料中…");

// ✅ 先做初步轉換
let tmpRows = table.rows.map((r, idx) => {
const c = r.c || [];
const name  = normalizeText(c[iName]?.v);
const world = normalizeText(c[iWorld]?.v);
const job   = normalizeText(c[iJob]?.v) || "-";
const exp   = toNumber(c[iExp]?.v);
const bp    = toNumber(c[iBp]?.v);
const up    = parseUpdatedCell(c[iUpdated]);
return { rowIdx: idx, name, world, job, exp, bp, updatedText: up.text || "-", updatedDate: up.date || null };
}).filter(x => x.name && x.world);

// ✅ 過濾掉戰鬥力 >= 100 億 的異常資料（整筆排除）
const beforeCount = tmpRows.length;
tmpRows = tmpRows.filter(r => !(r.bp !== null && r.bp >= BP_EXCLUDE_MIN));
const removedCount = beforeCount - tmpRows.length;

// ✅ 過濾指定名稱（宣傳/測試資料）
// - 避免榜單被惡意/宣傳資料污染
const beforeNameCount = tmpRows.length;
tmpRows = tmpRows.filter(r => {
  const n = normalizeText(r.name);
  if (!n) return false;

  // ✅ 先做「只保留英數」的正規化，專抓各種變形的 DanceGPT（含 D-a*n,c-e*G,P-T 這種）
  let nNorm = "";
  try{
    nNorm = n.toLowerCase().normalize("NFKC").replace(/[^0-9a-z\u4e00-\u9fff]/gu,"");
  } catch {
    nNorm = n.toLowerCase().replace(/[^0-9a-z\u4e00-\u9fff]/gu,"");
  }
  if (nNorm.includes("dancegpt")) return false;
  const nNormNoIL = nNorm.replace(/[il1]/g,"");
  if (nNormNoIL.includes("dancegpt")) return false;
  if ((nNorm.includes("想跟我一樣") || nNorm.includes("想變得跟我一樣")) && nNorm.includes("google")) return false;
  if (nNorm.includes("想跟我一樣強請搜") || nNorm.includes("想跟我一樣請搜") || nNorm.includes("想變得跟我一樣強嗎搜尋") || nNorm.includes("想跟我一樣強請google") || nNorm.includes("想跟我一樣請google") || nNorm.includes("想變得跟我一樣強嗎google")) return false;
  if (nNorm.includes("用ai生成式腳本幫你練功") || (nNorm.includes("ai") && nNorm.includes("腳本") && nNorm.includes("練功"))) return false;

  // ✅ 精準字串黑名單
  if (NAME_EXCLUDE.has(n)) return false;

  // ✅ 正則黑名單
  for (const re of NAME_EXCLUDE_PATTERNS){
    try{
      if (re && re.test && re.test(n)) return false;
    } catch {}
  }
  return true;
});
const removedNameCount = beforeNameCount - tmpRows.length;

// ✅ 重新連號 rowIdx（避免 rank map 用舊 idx）
rows = tmpRows.map((r, newIdx) => ({ ...r, rowIdx: newIdx }));

// ✅ 如果有移除，印 log（不影響 UI）
if (removedCount > 0){
console.warn(`已過濾異常戰鬥力資料：${removedCount} 筆（bp >= ${BP_EXCLUDE_MIN}）`);
}
if (removedNameCount > 0){
console.warn(`已過濾指定名稱資料：${removedNameCount} 筆`);
}

rankCache.clear();
jobRankCache.clear();

latestUpdated = null;
for (const r of rows){
if (r.updatedDate && (!latestUpdated || r.updatedDate > latestUpdated)){
latestUpdated = r.updatedDate;
}
}

setProgress(progressValue, "建立伺服器清單…");

const setW = new Set(rows.map(r => r.world));
worlds = Array.from(setW).sort((a,b)=>a.localeCompare(b, "zh-Hant"));

worldSelect.innerHTML = "";
const optAll = document.createElement("option");
optAll.value = "__ALL__";
optAll.textContent = "全部伺服器";
worldSelect.appendChild(optAll);
for (const w of worlds){
const opt = document.createElement("option");
opt.value = w;
opt.textContent = w;
worldSelect.appendChild(opt);
}

// ✅ 預設伺服器：一律預設「全部伺服器」
//   - 避免同名角色第一次漏查（例如預設挑戰者導致查不到一般服同名）
//   - 若網址有帶 world 參數，ensureDataLoaded() 會再覆蓋
worldSelect.value = "__ALL__";

refreshJobOptions(false);

loadedAt = new Date();
const latestText = latestUpdated ? latestUpdated.toLocaleString("zh-TW") : "-";
metaInfo.textContent =
`資料筆數：${rows.length.toLocaleString()}　|　資料最新更新：${latestText}　|　載入時間：${loadedAt.toLocaleString()}`;

setStatus("載入完成。", true);
  // ✅ 只負責載入與建表；是否自動查詢由 init() 決定
}

/** ✅ 排名包：worldKey="__ALL__" -> 全伺服器合併排名（並列同名次） */
function buildRanks(worldKey){
if (rankCache.has(worldKey)) return rankCache.get(worldKey);

const group = (worldKey === "__ALL__") ? rows : rows.filter(r => r.world === worldKey);

const expSorted = group
.filter(r => r.exp !== null)
.slice()
.sort((a,b) => (b.exp - a.exp) || (a.rowIdx - b.rowIdx));
const expRank = buildCompetitionRankMap(expSorted, r => r.exp);

const bpSorted = group
.filter(r => r.bp !== null)
.slice()
.sort((a,b) => (b.bp - a.bp) || (a.rowIdx - b.rowIdx));
const bpRank = buildCompetitionRankMap(bpSorted, r => r.bp);

const pack = { expRank, bpRank, expSorted, bpSorted };
rankCache.set(worldKey, pack);
return pack;
}

/** ✅ 職業內排名：worldKey="__ALL__" -> 全伺服器同職業合併排名（並列同名次） */
function buildJobRanks(worldKey, job){
const key = `${worldKey}||${job}`;
if (jobRankCache.has(key)) return jobRankCache.get(key);

const groupAll = (worldKey === "__ALL__") ? rows : rows.filter(r => r.world === worldKey);
const group = groupAll.filter(r => r.job === job);

const expSorted = group
.filter(r => r.exp !== null)
.slice()
.sort((a,b) => (b.exp - a.exp) || (a.rowIdx - b.rowIdx));
const expJobRank = buildCompetitionRankMap(expSorted, r => r.exp);

const bpSorted = group
.filter(r => r.bp !== null)
.slice()
.sort((a,b) => (b.bp - a.bp) || (a.rowIdx - b.rowIdx));
const bpJobRank = buildCompetitionRankMap(bpSorted, r => r.bp);

const pack = { expJobRank, bpJobRank };
jobRankCache.set(key, pack);
return pack;
}

function runSearch(){
  activeTab = "result";
  hideAroundControls();

  const targetName = normalizeText(nameInput.value);

// ✅ 角色查詢：一律先用「全部伺服器」進行搜尋（避免同名角色第一次漏查）
if (worldSelect.value !== "__ALL__"){
  worldSelect.value = "__ALL__";
  // 伺服器變更後，職業清單也同步刷新（避免選項不一致）
  refreshJobOptions(true);
}
const selectedWorld = "__ALL__";
  // ✅ 每次查詢先把「查不到角色」提示區清空
  hideFaqInline();

  if (!targetName){
    setStatus("請先輸入角色名稱。", false);
    contentEl.innerHTML = "";
    hideFaqInline();
    return;
  }

  // ✅ 只要有查詢，就記錄（不論有沒有查到）
  addSearchHistory(targetName, selectedWorld, jobSelect.value || "__ALL_JOB__");

  // 先找出所有同名（跨伺服器）
  const allSameName = rows.filter(r => r.name === targetName);

  // 先依目前下拉篩選（可能是預設=挑戰者）
  let candidates = allSameName;
  let usedWorld = selectedWorld;
  let autoAllWorld = false;

  if (selectedWorld !== "__ALL__"){
    candidates = allSameName.filter(r => r.world === selectedWorld);

    // ✅ 修正：若在預設伺服器找不到，但其他伺服器有同名角色
    if (!candidates.length && allSameName.length){
      autoAllWorld = true;
      usedWorld = "__ALL__";
      candidates = allSameName;

      // 反映到 UI：改成「全部伺服器」讓使用者知道目前的查詢範圍
      worldSelect.value = "__ALL__";
      refreshJobOptions(true);
    }
  } else {
    usedWorld = "__ALL__";
  }

  // ✅ 同名鎖定（只看其中一筆）
  if (pinnedRowIdx !== null){
    const pinned = candidates.filter(r => r.rowIdx === pinnedRowIdx);
    if (pinned.length){
      candidates = pinned;
    } else {
      pinnedRowIdx = null;
    }
  }

  if (!candidates.length){
    const fuzzy = rows
      .filter(r => r.name.includes(targetName) && (selectedWorld==="__ALL__" || r.world===selectedWorld))
      .slice(0, 20);

    setStatus(`找不到「${targetName}」${selectedWorld==="__ALL__"?"":`（${selectedWorld}）`}。`, false);
    showFaqInline();

    if (fuzzy.length){
      contentEl.innerHTML =
        `<div class="muted">可能是名稱不完全一致，以下是包含「${escapeHtml(targetName)}」的前 20 筆：</div>` +
        tableHtml(["遊戲ID","伺服器","職業","等級","經驗值%","戰鬥力","更新時間"], fuzzy.map(r=>{
          const s = splitLevelExpRate(r.exp);
          const bpText = formatBattlePower(r.bp);
          return [
            escapeHtml(r.name),
            escapeHtml(r.world),
            escapeHtml(r.job),
            s.level,
            s.expPct,
            `<span title="${escapeHtml(r.bp ?? "")}">${escapeHtml(bpText)}</span>`,
            `<span class="nowrap">${escapeHtml(r.updatedText || "-")}</span>`
          ];
        }));
    } else {
      contentEl.innerHTML = "";
    }
    return;
  }
  // ✅ 角色查詢：同名跨伺服器列出結果（避免漏查），排名一律以「各伺服器各自榜單」計算
  const useCombinedAllWorldRank = false;
  const globalPack = null;

  const out = candidates.map(r => {
    const pack = useCombinedAllWorldRank ? globalPack : buildRanks(r.world);

    const expRank = (r.exp !== null) ? (pack.expRank.get(r.rowIdx) ?? "-") : "-";
    const bpRank  = (r.bp  !== null) ? (pack.bpRank.get(r.rowIdx)  ?? "-") : "-";

    const jobPack = buildJobRanks(useCombinedAllWorldRank ? "__ALL__" : r.world, r.job);
    const expJobRank = (r.exp !== null) ? (jobPack.expJobRank.get(r.rowIdx) ?? "-") : "-";
    const bpJobRank  = (r.bp  !== null) ? (jobPack.bpJobRank.get(r.rowIdx)  ?? "-") : "-";

    return {
      rowIdx: r.rowIdx,
      name: r.name,
      world: r.world,
      job: r.job,
      exp: r.exp,
      expRank,
      expJobRank,
      bp: r.bp,
      bpRank,
      bpJobRank,
      updatedText: r.updatedText || "-"
    };
  });

  out.sort((a,b)=> (b.exp??-1)-(a.exp??-1));

  // ✅ 狀態訊息
  if (autoAllWorld){
    hideFaqInline();
    setStatus(`在「${selectedWorld}」找不到「${targetName}」，但其他伺服器有同名角色，已改用「全部伺服器」結果。`, true);
  } else {
    hideFaqInline();
    setStatus(`找到 ${out.length} 筆「${targetName}」資料。`, true);

  }

  // ✅ 檢舉過多自動隱藏（多人累計，若後台尚未設定則只做本機隱藏）
  const _outKeys = out.map(x => reportKey(x.world, x.name));
  scheduleReportFetchAndRerender(_outKeys);
  const hiddenByReport = out.filter(x => isHiddenByReport(x.world, x.name));
  const outShown = out.filter(x => !shouldHideByReport(x.world, x.name));
  if (hiddenByReport.length){
    // 只追加提示，不改你原本的查詢邏輯
    setStatus((statusEl.textContent || "") + `（已隱藏 ${hiddenByReport.length} 筆：檢舉≥${REPORT_HIDE_THRESHOLD}）`, true);
  }

  // ✅ 同名角色選擇面板（跨伺服器）

  let panelHtml = "";
  const totalSameName = allSameName.length;

  if (totalSameName > 1){
    const pickList = allSameName
      .slice()
      .sort((a,b)=> (b.exp??-1)-(a.exp??-1));

    const optionsHtml = pickList.map(r=>{
      const s = splitLevelExpRate(r.exp);
      const bpText = formatBattlePower(r.bp);
      const label =
        `${r.world}｜${r.job}｜Lv ${s.level}｜BP ${bpText}｜更新 ${r.updatedText || "-"}`;
      const selected = (pinnedRowIdx !== null && r.rowIdx === pinnedRowIdx) ? " selected" : "";
      return `<option value="${r.rowIdx}"${selected}>${escapeHtml(label)}</option>`;
    }).join("");

    const modeNote = useCombinedAllWorldRank
      ? "（目前：全部伺服器合併排名）"
      : "（目前：各伺服器各自排名）";

    panelHtml = `
      <div class="dupe-panel">
        <span class="label">發現同名角色共 ${totalSameName} 筆 ${modeNote}，請選擇要查看哪一筆：</span>
        <select id="dupePickSelect">${optionsHtml}</select>
        <button type="button" class="miniBtn primary" data-action="pinPick">只看這筆</button>
        <button type="button" class="miniBtn" data-action="clearPin">顯示全部</button>
      </div>
    `;
  } else if (pinnedRowIdx !== null){
    // 理論上不會進來，但保險
    panelHtml = `
      <div class="dupe-panel">
        <span class="label">目前已鎖定只看一筆。</span>
        <button type="button" class="miniBtn" data-action="clearPin">取消鎖定</button>
      </div>
    `;
  }

  // ✅ 表格（加上「操作」欄位）
  contentEl.innerHTML = panelHtml + tableHtml(
    ["操作","遊戲ID","伺服器","職業","等級","經驗值%","經驗排名","職業經驗排名","戰鬥力","戰力排名","職業戰力排名","更新時間"],
    outShown.map(x => {
      const s = splitLevelExpRate(x.exp);
      const bpText = formatBattlePower(x.bp);

      const isPinned = (pinnedRowIdx !== null && pinnedRowIdx === x.rowIdx);
      const btnText = isPinned ? "已選" : "只看";
      const btnDisabled = isPinned ? " disabled" : "";

      return [
        `<button type="button" class="miniBtn${isPinned ? "" : ""}" data-action="pin" data-rowidx="${x.rowIdx}"${btnDisabled}>${btnText}</button>` + " " + reportButtonHtml(x.name, x.world, x.job) + adminButtonsHtml(x.name, x.world, x.job),
        `<span class="pill">${escapeHtml(x.name)}</span>${isHiddenByReport(x.world, x.name) ? ' <span class="muted">（已隱藏）</span>' : ""}`,
        escapeHtml(x.world),
        escapeHtml(x.job),
        s.level,
        s.expPct,
        (x.expRank === "-" ? "-" : `第${x.expRank}名`),
        (x.expJobRank === "-" ? "-" : `第${x.expJobRank}名`),
        `<span title="${escapeHtml(x.bp ?? "")}">${escapeHtml(bpText)}</span>`,
        (x.bpRank === "-" ? "-" : `第${x.bpRank}名`),
        (x.bpJobRank === "-" ? "-" : `第${x.bpJobRank}名`),
        `<span class="nowrap">${escapeHtml(x.updatedText || "-")}</span>`
      ];
    })
  );

  // ✅ 只有單筆結果才顯示「附近榜」
  if (outShown.length === 1){
    const one = outShown[0];

    // 若使用者明確選了「全部伺服器」且用合併排名，附近榜就用合併榜；否則用該伺服器榜
    const worldKey = (useCombinedAllWorldRank && worldSelect.value === "__ALL__") ? "__ALL__" : one.world;
    initAroundForSingleResult(one, worldKey);
  }
}

function renderTop(metric){
hideAroundControls();
activeTab = (metric === "exp") ? "topExp" : "topBp";

const worldKey = worldKeyForTop();
const jobFilter = jobSelect.value || "__ALL_JOB__";

const pack = buildRanks(worldKey);
let list = (metric === "exp") ? pack.expSorted : pack.bpSorted;

if (jobFilter !== "__ALL_JOB__"){
list = list.filter(r => r.job === jobFilter);
}

const listRankMap = buildCompetitionRankMap(
list,
r => (metric === "exp" ? r.exp : r.bp)
);

let end = Math.min(100, list.length);
if (list.length > 100){
const v100 = (metric === "exp") ? list[99].exp : list[99].bp;
while (end < list.length){
const vNext = (metric === "exp") ? list[end].exp : list[end].bp;
if (!sameNumber(vNext, v100)) break;
end++;
}
}

const top = list.slice(0, end).map((r) => {
const jobPack = buildJobRanks(worldKey, r.job);
const jobRank = (metric === "exp")
? (jobPack.expJobRank.get(r.rowIdx) ?? "-")
: (jobPack.bpJobRank.get(r.rowIdx) ?? "-");

return {
rank: listRankMap.get(r.rowIdx) ?? "-",
name: r.name,
world: r.world,
job: r.job,
value: (metric === "exp") ? r.exp : r.bp,
jobRank,
updatedText: r.updatedText || "-"
};
});


// ✅ 檢舉過多自動隱藏（多人累計，若後台尚未設定則只做本機隱藏）
const _topKeys = top.map(x => reportKey(x.world, x.name));
scheduleReportFetchAndRerender(_topKeys);
const hiddenByReport = top.filter(x => isHiddenByReport(x.world, x.name));
const shownTop = top.filter(x => !shouldHideByReport(x.world, x.name));


const worldText = (worldKey === "__ALL__") ? "全部伺服器" : worldKey;
const filterText = (jobFilter === "__ALL_JOB__") ? "全部職業" : jobFilter;

setStatus(`顯示 ${worldText} 前 100 名（${metric === "exp" ? "經驗" : "戰力"} / ${filterText}）。` + (hiddenByReport.length ? `（已隱藏 ${hiddenByReport.length} 筆：檢舉≥${REPORT_HIDE_THRESHOLD}）` : ""), true);

if (metric === "exp") {
contentEl.innerHTML = tableHtml(
["排名","name","world","職業","等級","經驗值%","職業經驗排名","更新時間","檢舉"],
shownTop.map(x => {
const s = splitLevelExpRate(Number(x.value));
const rk = (x.rank === "-" ? "-" : `#${x.rank}`);
return [
`<span class="mono">${escapeHtml(rk)}</span>`,
escapeHtml(x.name) + (isHiddenByReport(x.world, x.name) ? ' <span class="muted">（已隱藏）</span>' : ''),
escapeHtml(x.world),
escapeHtml(x.job),
s.level,
s.expPct,
(x.jobRank === "-" ? "-" : `第${x.jobRank}名`),
`<span class="nowrap">${escapeHtml(x.updatedText || "-")}</span>`,
reportButtonHtml(x.name, x.world, x.job) + adminButtonsHtml(x.name, x.world, x.job)
];
})
);
} else {
contentEl.innerHTML = tableHtml(
["排名","name","world","職業","戰鬥力","職業戰力排名","更新時間","檢舉"],
shownTop.map(x => {
const bpText = formatBattlePower(x.value);
const rk = (x.rank === "-" ? "-" : `#${x.rank}`);
return [
`<span class="mono">${escapeHtml(rk)}</span>`,
escapeHtml(x.name) + (isHiddenByReport(x.world, x.name) ? ' <span class="muted">（已隱藏）</span>' : ''),
escapeHtml(x.world),
escapeHtml(x.job),
`<span title="${escapeHtml(x.value ?? "")}">${escapeHtml(bpText)}</span>`,
(x.jobRank === "-" ? "-" : `第${x.jobRank}名`),
`<span class="nowrap">${escapeHtml(x.updatedText || "-")}</span>`,
reportButtonHtml(x.name, x.world, x.job) + adminButtonsHtml(x.name, x.world, x.job)
];
})
);
}
}

function setActiveTab(tab){
activeTab = tab;

[tabResult, tabTopExp, tabTopBp].forEach(b=>b.classList.remove("active"));
if (tab==="result") tabResult.classList.add("active");
if (tab==="topExp") tabTopExp.classList.add("active");
if (tab==="topBp") tabTopBp.classList.add("active");

if (tab==="result") runSearch();
if (tab==="topExp") renderTop("exp");
if (tab==="topBp") renderTop("bp");
}

function copyShareLink(){
const name = normalizeText(nameInput.value);
const world = worldSelect.value;
const job = jobSelect.value || "__ALL_JOB__";

const url = new URL(location.href);
if (name) url.searchParams.set("name", name);
url.searchParams.set("world", world);
url.searchParams.set("job", job);

navigator.clipboard.writeText(url.toString()).then(()=>{
setStatus("已複製查詢連結。", true);
}).catch(()=>{
setStatus("複製失敗（瀏覽器不允許剪貼簿）。你可以手動複製網址列。", false);
});
}

/* ====== 事件（Lazy Load：首次操作才載入資料） ====== */

async function activateTab(tab){
  try{
    await ensureDataLoaded();
    setActiveTab(tab);
  } catch (err){
    console.error(err);
    finishLoadingProgress(false);
    setTimeout(()=>hideOverlay(), 380);
    hideFaqInline();
    setStatus("載入失敗：" + (err?.message || err), false);
  }
}

searchBtn.addEventListener("click", ()=>activateTab("result"));
shareBtn.addEventListener("click", copyShareLink);
tabResult.addEventListener("click", ()=>activateTab("result"));
tabTopExp.addEventListener("click", ()=>activateTab("topExp"));
tabTopBp.addEventListener("click", ()=>activateTab("topBp"));

nameInput.addEventListener("keydown", (e)=>{
  if (e.key==="Enter") activateTab("result");
});

/* ✅ 搜尋紀錄：雙擊 input 出現 */
nameInput.addEventListener("dblclick", ()=>{
  if (isHistoryShown()) hideHistoryDropdown();
  else showHistoryDropdown();
});
/* ✅ 當下拉開著時，輸入會即時篩選 */
nameInput.addEventListener("input", ()=>{
  pinnedRowIdx = null;
  if (isHistoryShown()){
    renderHistoryDropdown(nameInput.value);
    positionHistoryDropdown();
  }
});
/* ✅ 鍵盤操作（搜尋紀錄） */
nameInput.addEventListener("keydown", (e)=>{
  if (e.key === "ArrowDown"){
    if (!isHistoryShown()){
      showHistoryDropdown();
      e.preventDefault();
      return;
    }
    moveHistoryActive(+1);
    e.preventDefault();
    return;
  }
  if (e.key === "ArrowUp"){
    if (isHistoryShown()){
      moveHistoryActive(-1);
      e.preventDefault();
    }
    return;
  }
  if (e.key === "Escape"){
    if (isHistoryShown()){
      hideHistoryDropdown();
      e.preventDefault();
    }
    return;
  }
  if (e.key === "Enter"){
    if (isHistoryShown() && historyActiveIndex >= 0){
      const it = historyFiltered[historyActiveIndex];
      if (it){
        nameInput.value = (it.name ?? "").toString();
        pendingWorld = (it.world ?? "__ALL__").toString();
        pendingJob = (it.job ?? "__ALL_JOB__").toString();
        worldUserTouched = true;
      }
      hideHistoryDropdown();
      activateTab("result");
      e.preventDefault();
      return;
    }
  }
});
/* ✅ 點空白處關閉下拉 */
document.addEventListener("mousedown", (e)=>{
  if (!isHistoryShown()) return;
  const t = e.target;
  if (t === nameInput) return;
  if (historyDropdownEl && historyDropdownEl.contains(t)) return;
  hideHistoryDropdown();
});
/* ✅ 捲動 / 視窗變更時重新定位 */
window.addEventListener("resize", ()=>{
  if (isHistoryShown()) positionHistoryDropdown();
});
window.addEventListener("scroll", ()=>{
  if (isHistoryShown()) positionHistoryDropdown();
}, true);

tabAroundExp.addEventListener("click", ()=>{
  if (!tabAroundExp.disabled) setAroundTab("exp");
});
tabAroundBp.addEventListener("click", ()=>{
  if (!tabAroundBp.disabled) setAroundTab("bp");
});

btnUp50.addEventListener("click", ()=>shiftAround(-1));
btnDown50.addEventListener("click", ()=>shiftAround(+1));

worldSelect.addEventListener("change", ()=>{
  if (!dataLoaded) return;
  worldUserTouched = true;
  pinnedRowIdx = null;
  refreshJobOptions(true);
  hideAroundControls();

  if (activeTab === "topExp") renderTop("exp");
  if (activeTab === "topBp") renderTop("bp");
  if (activeTab === "result") runSearch();
});

jobSelect.addEventListener("change", ()=>{
  if (!dataLoaded) return;
  if (activeTab === "topExp") renderTop("exp");
  if (activeTab === "topBp") renderTop("bp");
});

/* ✅ 同名角色：點「只看」/ 下拉選擇 */
function pinByRowIdx(rowIdx){
  const idx = Number(rowIdx);
  if (!Number.isFinite(idx)) return;
  const r = rows.find(x => x.rowIdx === idx);
  if (!r) return;

  pinnedRowIdx = idx;

  // 切到該角色所在伺服器（確保附近榜/排名都是對的）
  worldSelect.value = r.world;
  worldUserTouched = true;
  refreshJobOptions(true);

  runSearch();
}

contentEl.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-action]");
  if (!btn) return;

  const act = btn.getAttribute("data-action");

  // ✅ 管理員操作
  if (act && act.startsWith("admin_")){
    const op = act.replace("admin_", "");
    const key = btn.getAttribute("data-key") || "";
    const label = btn.getAttribute("data-label") || key;
    if (!key) return;
    adminOp(op, key, label);
    return;
  }

  if (act === "pin"){
    const idx = btn.getAttribute("data-rowidx");
    pinByRowIdx(idx);
    return;
  }

  if (act === "report"){
    const name = btn.getAttribute("data-name") || "";
    const world = btn.getAttribute("data-world") || "";
    const job = btn.getAttribute("data-job") || "";
    submitReport({ name, world, job });
    return;
  }

  if (act === "pinPick"){
    const sel = document.getElementById("dupePickSelect");
    if (!sel) return;
    pinByRowIdx(sel.value);
    return;
  }

  if (act === "clearPin"){
    pinnedRowIdx = null;

    // 顯示全部同名角色：切到「全部伺服器」
    worldSelect.value = "__ALL__";
    worldUserTouched = true;
    refreshJobOptions(true);

    runSearch();
    return;
  }
});

/* ====== 初始化 ====== */
(function init(){
  applyDataLoadedUi();
  initAdminUi();
  setStatus("請輸入角色名稱後按「查詢」。首次使用會先下載資料。", true);

  const sp = new URLSearchParams(location.search);
  const qName  = sp.get("name");
  const qWorld = sp.get("world");
  const qJob   = sp.get("job");

  if (qName) nameInput.value = qName;
  if (qWorld) { pendingWorld = qWorld; worldUserTouched = true; }
  if (qJob) pendingJob = qJob;

  if (qName || qWorld || qJob){
    pendingAutoRun = !!qName;
    ensureDataLoaded().catch(err=>{
      console.error(err);
      finishLoadingProgress(false);
      setTimeout(()=>hideOverlay(), 380);
      hideFaqInline();
    setStatus("載入失敗：" + (err?.message || err), false);
    });
  }
})();

</script>

<div class="muted" style="margin-top:10px">瀏覽人數統計：<span data-visit-count>（載入中…）</span></div>

<script src="./counter.js"></script>
</body>
</html>
