<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maple è§’è‰²æŸ¥è©¢ï¼ˆWebï¼‰</title>
  <style>

:root{
  --bg:#050608;
  --panel:#1b1f2a;
  --panel2:#23283a;
  --line:#303851;
  --text:#e9edf7;
  --muted:#aab4c3;
  --accent:#00d1ff;
  --good:#4ade80;
  --warn:#fbbf24;
  --bad:#fb7185;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background: radial-gradient(1000px 600px at 20% 0%, rgba(0,209,255,.12), transparent 55%),
              radial-gradient(900px 540px at 90% 10%, rgba(168,85,247,.10), transparent 60%),
              var(--bg);
  color:var(--text);
}
a{color:var(--accent);text-decoration:none;}
.wrap{max-width:1200px;margin:0 auto;padding:28px 18px 44px;}
h1{margin:0 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px;}
.sub{color:var(--muted);font-size:13px;margin-bottom:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px;}
.input{
  flex:1 1 360px;
  height:44px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  outline:none;
}
.input:focus{border-color:rgba(0,209,255,.55); box-shadow:0 0 0 3px rgba(0,209,255,.12);}
.btn{
  height:44px;
  padding:0 16px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer;
  font-weight:700;
}
.btn.primary{background:linear-gradient(180deg, rgba(0,209,255,.20), rgba(0,209,255,.08)); border-color:rgba(0,209,255,.35);}
.btn:active{transform:translateY(1px);}
.status{min-height:18px;color:var(--muted);font-size:13px;margin:6px 0 14px;}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.grid{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:14px;
}
@media (max-width: 980px){
  .grid{grid-template-columns:1fr;}
}
.char{
  display:flex; gap:14px; align-items:center;
}
.avatar{
  width:88px;height:88px;border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:contain;image-rendering:auto;}
.char h2{margin:0;font-size:20px;font-weight:900;}
.char .meta{color:var(--muted);font-size:13px;margin-top:2px;line-height:1.45;}
.kpis{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width: 980px){
  .kpis{grid-template-columns: repeat(2, minmax(0,1fr));}
}
.kpi{
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  padding:10px 12px;
}
.kpi .k{color:var(--muted);font-size:12px;margin-bottom:4px}
.kpi .v{font-size:18px;font-weight:900;letter-spacing:.2px}
.section-title{
  margin:18px 0 10px;
  font-size:14px;
  font-weight:900;
  color:var(--text);
  display:flex; align-items:center; justify-content:space-between;
}
.small{color:var(--muted);font-size:12px}
.equip-grid{
  display:flex; flex-wrap:wrap; gap:10px;
}
.equip{
  width:84px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  padding:8px 8px 6px;
  cursor:pointer;
  user-select:none;
  transition:transform .08s ease, border-color .12s ease;
}
.equip:hover{transform:translateY(-1px); border-color:rgba(0,209,255,.35);}
.equip .iconbox{
  width:68px;height:68px;border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  margin:0 auto;
}
.equip img{max-width:100%;max-height:100%;image-rendering:auto;}
.equip .nm{
  margin-top:6px;
  font-size:11px;
  line-height:1.2;
  text-align:center;
  color:rgba(233,237,247,.92);
  min-height:26px;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
.equip .sf{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}

/* ===== Modal ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.60);
  z-index:9999;
}
.modal.hidden{display:none;}
.modal-panel{
  position:fixed;
  width:420px;
  max-width:calc(100vw - 32px);
  max-height:calc(100vh - 32px);
  overflow:auto;
  background:transparent; /* inner tooltip handles bg */
}
.modal-x{
  position:absolute;
  top:10px; right:10px;
  width:34px;height:34px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.35);
  color:var(--text);
  font-size:18px;
  cursor:pointer;
  z-index:2;
}
.modal-x:hover{border-color:rgba(0,209,255,.35);}

/* ===== Maple-like tooltip ===== */
.ms-tip{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(43,47,66,.98), rgba(33,36,54,.98));
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  padding:14px 14px 12px;
  position:relative;
}
.ms-stars{
  font-size:14px;
  letter-spacing:1px;
  color:#fff;
  opacity:.95;
  text-shadow:0 1px 0 rgba(0,0,0,.35);
  margin-bottom:6px;
  line-height:1.1;
  white-space:nowrap;
}
.ms-title{
  font-size:16px;
  font-weight:900;
  margin-bottom:10px;
  color:#fff;
}
.ms-top{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.ms-iconframe{
  width:62px;height:62px;border-radius:14px;
  border:2px solid rgba(173,255,47,.55);
  box-shadow:0 0 0 2px rgba(0,0,0,.40) inset;
  background:rgba(0,0,0,.20);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.ms-iconframe img{max-width:100%;max-height:100%;}
.ms-lines{
  flex:1;
  font-size:13px;
  line-height:1.55;
  color:rgba(255,255,255,.92);
}
.ms-lines .muted{color:rgba(170,180,195,.95);}
.ms-divider{
  height:1px;
  background:rgba(255,255,255,.10);
  margin:10px 0;
}
.ms-bar{
  margin-top:10px;
  border-radius:6px;
  padding:6px 10px;
  font-size:13px;
  font-weight:900;
  display:flex;
  gap:8px;
  align-items:center;
  color:#0b0c10;
}
.ms-bar .tag{
  width:22px;height:22px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(0,0,0,.18);
}
.ms-bar.legendary{background:linear-gradient(90deg, #c7ff3a, #7cffd6);}
.ms-bar.unique{background:linear-gradient(90deg, #ffd43a, #ffef7a);}
.ms-bar.epic{background:linear-gradient(90deg, #a78bfa, #60a5fa);}
.ms-bar.rare{background:linear-gradient(90deg, #60a5fa, #22d3ee);}
.ms-bar.common{background:linear-gradient(90deg, #94a3b8, #cbd5e1);}
.ms-opt{
  margin-top:6px;
  font-size:13px;
  color:rgba(255,255,255,.94);
}
.ms-opt .line{margin:2px 0;}
.ms-foot{
  margin-top:10px;
  display:flex;flex-direction:column;gap:6px;
}
.ms-buff{
  border-radius:8px;
  padding:8px 10px;
  font-size:13px;
  font-weight:800;
  color:#10131a;
}
.ms-buff.green{background:linear-gradient(90deg, #b8ff3a, #7cffd6);}
.ms-buff.orange{background:linear-gradient(90deg, #ffb020, #ffd27a);}


/* å…§æ½›ï¼ˆä¾ç´šåˆ¥ä¸Šè‰²ï¼‰ */
.ability-wrap{margin-top:8px;display:flex;flex-direction:column;gap:10px;}
.ms-buff.blue{background:linear-gradient(0deg,#0b4a8f,#0f5fb8);}
.ms-buff.purple{background:linear-gradient(0deg,#4a2a88,#6c44c8);}
.ms-buff.gray{background:linear-gradient(0deg,#3a3f49,#4a5160);}

/* è£å‚™æ•¸å€¼é…è‰²ï¼šåŸºæœ¬(ç™½) + æ˜ŸåŠ›(é»ƒ) + å·è»¸(è—) + æ˜Ÿç«(ç¶ ) */
.c-base{color:rgba(255,255,255,.92);font-weight:700;}
.c-star{color:#ffd35a;font-weight:800;}
.c-scroll{color:#53b6ff;font-weight:800;}
.c-flame{color:#7cff7c;font-weight:800;}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Maple è§’è‰²æŸ¥è©¢ï¼ˆWebï¼‰</h1>
    <div class="sub">åªè¼¸å…¥è§’è‰²æš±ç¨±ï¼›æ—¥æœŸè‡ªå‹•æŸ¥è©¢æ˜¨å¤©ï¼ˆå°ç£æ™‚é–“ï¼‰ã€‚æˆ°é¬¥åŠ›é¡¯ç¤ºã€Œå„„/è¬ã€å–®ä½ï¼›BOSSå‚·/ç„¡è¦–/çˆ†å‚·/çˆ†ç‡/æœ€çµ‚å‚·/å‚·å®³ çš†è‡ªå‹•åŠ ä¸Š %ã€‚è£å‚™/æ™‚è£æ»‘é¼ ç§»åˆ°åœ–ç‰‡å³å¯çœ‹å®Œæ•´æ•¸å€¼ã€‚</div>

    <div class="search">
      <input id="name" type="text" placeholder="è¼¸å…¥è§’è‰²æš±ç¨±ï¼ˆä¾‹ï¼šEzraçµ•ï¼‰" />
      <button id="btn" onclick="run()">æŸ¥è©¢</button>
    </div>
    <div id="status" class="status">å¾…å‘½</div>

    <div id="out" class="row"></div>
  </div>
<div id="modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel" role="document">
      <button class="modal-x" type="button" aria-label="é—œé–‰">Ã—</button>
      <div class="modal-body"></div>
    </div>
  </div>


<script>


/** ===== åŸºæœ¬è¨­å®š ===== */
const WORKER_BASE = "https://maple-proxy.ezraop.workers.dev";
const DEFAULT_PARTS = "basic,popularity,stat,ability,itemEquipment,cashitemEquipment,symbolEquipment";
const TZ = "Asia/Taipei";

/** ===== DOM helper ===== */
const $ = (id) => document.getElementById(id);
const esc = (s) => String(s ?? "").replace(/[&<>\"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

/** ===== æ—¥æœŸï¼ˆå°ç£ï¼‰æ˜¨å¤© yyyy-mm-dd ===== */
function getYesterdayYmdTz() {
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
  const parts = fmt.formatToParts(new Date());
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const dt = new Date(Date.UTC(y, m-1, d));
  dt.setUTCDate(dt.getUTCDate() - 1);
  const y2 = dt.getUTCFullYear();
  const m2 = String(dt.getUTCMonth()+1).padStart(2,"0");
  const d2 = String(dt.getUTCDate()).padStart(2,"0");
  return `${y2}-${m2}-${d2}`;
}


function fmtTs(d) {
  try {
    return new Intl.DateTimeFormat("zh-TW", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).format(d);
  } catch (e) {
    // fallback
    return d.toISOString();
  }
}


/** ===== BigInt å–®ä½æ ¼å¼ï¼šå„„/è¬ ===== */
function formatZhUnit(nLike) {
  // å°ˆé–€çµ¦ã€Œæˆ°é¬¥åŠ›ã€ç”¨ï¼š>=1å„„æ™‚ä¸€å®šåŒæ™‚é¡¯ç¤ºã€Œå„„ã€èˆ‡ã€Œè¬ã€
  const s0 = String(nLike ?? "").trim();
  if (!s0) return "";
  const s = s0.replace(/,/g, "");
  if (!/^\d+$/.test(s)) return s0;

  const n = BigInt(s);
  const YI = 100000000n;
  const WAN = 10000n;

  if (n >= YI) {
    const yi = n / YI;
    const remYi = n % YI;
    const wan = remYi / WAN;
    const rem = remYi % WAN; // 0..9999
    // å„„ã€è¬å›ºå®šå‡ºç¾ï¼›é¤˜æ•¸(åƒ/ç™¾/å/å€‹)è¦–æƒ…æ³è£œä¸Š
    return `${yi}å„„${wan}è¬${rem === 0n ? "" : String(rem)}`;
  }
  if (n >= WAN) {
    const wan = n / WAN;
    const rem = n % WAN;
    return `${wan}è¬${rem === 0n ? "" : String(rem)}`;
  }
  return String(n);
}


/** ===== % é¡¯ç¤º ===== */
function formatPercent(v) {
  const s = String(v ?? "").trim();
  if (!s) return "";
  if (s.includes("%")) return s;
  return s + "%";
}



/** ===== HTML è½‰ç¾©ï¼ˆé¿å… XSS / é¿å…é¢æ¿ç‚¸æ‰ï¼‰ ===== */
function escapeHtml(input) {
  const s = String(input ?? "");
  return s.replace(/[&<>"']/g, (ch) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;",
  }[ch]));
}


function renderStars_(n, max) {
  const nn = Math.max(0, Math.floor(Number(n) || 0));
  const mm = Math.max(0, Math.floor(Number(max) || 0));
  if (!mm) return "";
  const filled = "â˜…".repeat(Math.min(nn, mm));
  const empty = "â˜†".repeat(Math.max(0, mm - nn));
  // åˆ†å…©è¡Œé¡¯ç¤ºï¼Œé¿å…å¤ªé•·
  const s = filled + empty;
  if (s.length <= 15) return s;
  return s.slice(0, 15) + "<br>" + s.slice(15);
}

function fmtNum_(v, isPct) {
  const n = Number(v || 0);
  const sign = n >= 0 ? "+" : "";
  const abs = Math.abs(n);
  const txt = abs % 1 === 0 ? abs.toString() : abs.toFixed(2);
  return sign + txt + (isPct ? "%" : "");
}

function potentialClass_(grade) {
  const g = String(grade || "").trim();
  if (!g) return "common";
  if (g.includes("å‚³èªª") || g.toLowerCase().includes("legend")) return "legendary";
  if (g.includes("ç½•è¦‹") || g.toLowerCase().includes("unique")) return "unique";
  if (g.includes("å²è©©") || g.toLowerCase().includes("epic")) return "epic";
  if (g.includes("ç¨€æœ‰") || g.toLowerCase().includes("rare")) return "rare";
  return "common";
}

function potentialTag_(grade) {
  const g = String(grade || "").trim();
  if (!g) return "C";
  if (g.includes("å‚³èªª") || g.toLowerCase().includes("legend")) return "L";
  if (g.includes("ç½•è¦‹") || g.toLowerCase().includes("unique")) return "U";
  if (g.includes("å²è©©") || g.toLowerCase().includes("epic")) return "E";
  if (g.includes("ç¨€æœ‰") || g.toLowerCase().includes("rare")) return "R";
  return "C";
}

function renderPotentialBlock_(grade, opts, isAdd) {
  const g = String(grade || "").trim();
  const list = (opts || []).filter((x) => String(x || "").trim());
  if (!g && !list.length) return "";
  const cls = potentialClass_(g);
  const tag = potentialTag_(g);
  const title = isAdd ? "é™„åŠ æ½›èƒ½" : "æ½›èƒ½";
  return `
    <div class="ms-bar ${cls}">
      <div class="tag">${tag}</div>
      <div>${escapeHtml(title)}</div>
    </div>
    <div class="ms-opt">
      ${list.map((s)=>`<div class="line">${escapeHtml(String(s))}</div>`).join("")}
    </div>
  `;
}


/** ===== 8 å¤§æ•¸å€¼æŠ½å– ===== */
function statArrayToMap(final_stat) {
  const map = {};
  if (Array.isArray(final_stat)) {
    for (const s of final_stat) {
      if (s && s.stat_name) map[s.stat_name] = s.stat_value;
    }
  }
  return map;
}
function pick(map, keys) {
  for (const k of keys) {
    const v = map[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}
function extractMetrics(statMap) {
  const boss = pick(statMap, ["BOSSæ€ªç‰©å‚·å®³","Bossæ€ªç‰©å‚·å®³","bossæ€ªç‰©å‚·å®³"]);
  return {
    combat_power: pick(statMap, ["æˆ°é¬¥åŠ›"]),
    boss_damage: boss,
    ignore_def: pick(statMap, ["ç„¡è¦–é˜²ç¦¦ç‡"]),
    crit_damage: pick(statMap, ["çˆ†æ“Šå‚·å®³"]),
    crit_rate: pick(statMap, ["çˆ†æ“Šæ©Ÿç‡"]),
    final_damage: pick(statMap, ["æœ€çµ‚å‚·å®³"]),
    damage: pick(statMap, ["å‚·å®³"]),
    attack_power: pick(statMap, ["æ”»æ“ŠåŠ›"]),
  };
}

/** ===== Local leaderboardï¼ˆä½ æŸ¥éçš„äººï¼‰===== */
const LB_KEY = "maple_lb_v1";
function loadLB() {
  try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); } catch { return []; }
}
function saveLB(list) {
  localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0, 500)));
}
function upsertLB(entry) {
  const list = loadLB();
  const key = `${entry.character_name}@@${entry.world_name}`;
  const idx = list.findIndex(x => `${x.character_name}@@${x.world_name}` === key);
  if (idx >= 0) list[idx] = entry;
  else list.push(entry);
  list.sort((a,b)=> (b.fetched_at||"").localeCompare(a.fetched_at||""));
  saveLB(list);
}
function topByBigInt(field, limit=50) {
  const list = loadLB();
  const toBig = (v)=>{ try{ const s=String(v??"").replace(/,/g,"").trim(); return s?BigInt(s):0n; }catch{ return 0n; } };
  return [...list].sort((a,b)=>{
    const A = toBig(a[field]);
    const B = toBig(b[field]);
    return B > A ? 1 : B < A ? -1 : 0;
  }).slice(0, limit);
}

/** ===== Tooltipï¼ˆé»ä¸€ä¸‹é¡¯ç¤ºå®Œæ•´æ•¸å€¼ï¼ˆé»èƒŒæ™¯å¯é—œé–‰ï¼‰ï¼‰===== */
let __lastPointer = { x: 0, y: 0 };
let __tipInited = false;
window.__equipItems = [];
window.__cashItems = [];

function openItemModal(type, idx, anchorEl) {
  const it = getItemByTypeIdx_(type, idx);
  if (!it) return;

  const modal = document.getElementById("modal");
  const panel = modal.querySelector(".modal-panel");
  const body = modal.querySelector(".modal-body");

  let html = "";
  if (type === "equip") html = buildEquipModalHtml_(it);
  else if (type === "cash") html = buildCashModalHtml_(it);
  else html = "<div class='ms-tip'>ç„¡æ³•é¡¯ç¤º</div>";

  body.innerHTML = html;

  modal.classList.remove("hidden");

  // å…ˆçµ¦ä¸€å€‹åˆç†å¯¬åº¦
  const desiredW = 420;
  const maxW = Math.max(280, window.innerWidth - 32);
  const pw = Math.min(desiredW, maxW);
  panel.style.width = pw + "px";

  // å®šä½ï¼šå„ªå…ˆæ”¾åœ¨é»æ“Šç‰©ä»¶å·¦å´ï¼Œç©ºé–“ä¸å¤ å†æ”¾å³å´
  const rect = anchorEl ? anchorEl.getBoundingClientRect() : { left: window.innerWidth / 2, right: window.innerWidth / 2, top: window.innerHeight / 2 };
  let left = rect.left - pw - 14;
  if (left < 16) left = rect.right + 14;
  left = Math.min(left, window.innerWidth - pw - 16);
  left = Math.max(16, left);

  // top å…ˆå°é½Šåˆ° item ä¸Šæ–¹ä¸€é»ï¼Œä¹‹å¾Œå† clamp
  let top = rect.top - 80;
  top = Math.max(16, top);

  panel.style.left = left + "px";
  panel.style.top = top + "px";

  // é¡¯ç¤ºå¾Œå–å¾—é«˜åº¦ï¼Œé¿å…è¶…å‡ºè¦–çª—
  requestAnimationFrame(() => {
    const ph = panel.offsetHeight || 0;
    let t = top;
    if (t + ph > window.innerHeight - 16) t = Math.max(16, window.innerHeight - ph - 16);
    panel.style.top = t + "px";
  });
}

function closeItemModal() {
  const modal = document.getElementById("modal");
  if (!modal) return;
  modal.classList.add("hidden");
  const body = modal.querySelector(".modal-body");
  if (body) body.innerHTML = "";
}

function getItemByTypeIdx_(type, idx) {
  const i = Number(idx);
  if (!Number.isFinite(i) || i < 0) return null;
  if (type === "equip") return (window.__equipItems || [])[i] || null;
  if (type === "cash") return (window.__cashItems || [])[i] || null;
  return null;
}

function gradeClass_(g) {
  const s = String(g || "");
  if (s.includes("å‚³èªª")) return "g-legend";
  if (s.includes("ç‰¹æ®Š")) return "g-unique";
  if (s.includes("ç½•è¦‹")) return "g-epic";
  if (s.includes("ç¨€æœ‰")) return "g-rare";
  return "g-normal";
}

function pickNum_(v) {
  const s = String(v ?? "").trim();
  if (!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function buildOptionLines_(label, totalObj, baseObj, addObj, etcObj, starObj, exObj) {
  const keys = [
    ["str", "STR"],
    ["dex", "DEX"],
    ["int", "INT"],
    ["luk", "LUK"],
    ["max_hp", "æœ€å¤§HP"],
    ["max_mp", "æœ€å¤§MP"],
    ["attack_power", "æ”»æ“ŠåŠ›"],
    ["magic_power", "é­”æ³•æ”»æ“ŠåŠ›"],
    ["armor", "é˜²ç¦¦åŠ›"],
    ["speed", "ç§»å‹•é€Ÿåº¦"],
    ["jump", "è·³èºåŠ›"],
  ];

  const lines = [];
  for (const [k, name] of keys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;

    const parts = [];
    const b = pickNum_(baseObj?.[k]); if (b) parts.push(b);
    const a = pickNum_(addObj?.[k]); if (a) parts.push(a);
    const e = pickNum_(etcObj?.[k]); if (e) parts.push(e);
    const s = pickNum_(starObj?.[k]); if (s) parts.push(s);
    const x = pickNum_(exObj?.[k]); if (x) parts.push(x);

    const breakdown = parts.length >= 2 ? ` (${parts.join(" + ")})` : "";
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${breakdown}</span></div>`);
  }

  // ç™¾åˆ†æ¯”é¡
  const pctKeys = [
    ["all_stat", "å…¨å±¬æ€§", "%"],
    ["boss_damage", "BOSSå‚·", "%"],
    ["ignore_monster_armor", "ç„¡è¦–", "%"],
    ["damage", "å‚·å®³", "%"],
    ["max_hp_rate", "æœ€å¤§HP", "%"],
    ["max_mp_rate", "æœ€å¤§MP", "%"],
  ];
  for (const [k, name, unit] of pctKeys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${unit}</span></div>`);
  }

  return lines.length ? lines.join("") : `<div class="muted">ï¼ˆç„¡å¯é¡¯ç¤ºçš„å±¬æ€§ï¼‰</div>`;
}

function buildEquipModalHtml_(it) {
  const star = Number(it.starforce || 0);
  const starMax = 30;
  const stars = renderStars_(star, starMax);

  const title = escapeHtml(`${it.item_name || ""}${it.starforce ? ` (+${it.starforce})` : ""}`);

  const icon = it.item_icon || "";
  const part = it.item_equipment_part || it.item_equipment_slot || "";
  // ===== æ•¸å€¼ï¼ˆé…è‰²ï¼šåŸºæœ¬(ç™½) + æ˜ŸåŠ›(é»ƒ) + å·è»¸(è—) + æ˜Ÿç«(ç¶ )ï¼‰=====
  const total = it.item_total_option || {};
  const baseOpt = it.item_base_option || {};
  const starOpt = it.item_starforce_option || {};
  const scrollOpt = it.item_etc_option || {};
  const flameOpt = it.item_add_option || {};
  const excOpt = it.item_exceptional_option || {};

  const num = (v) => {
    if (v === "" || v === null || v === undefined) return 0;
    const s = String(v).replace(/,/g, "").trim();
    if (!s) return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const isPctKey = (k) => ["all_stat","boss_damage","ignore_monster_armor","damage","max_hp_rate","max_mp_rate"].includes(k);

  const fmtPart = (v, cls, pct) => {
    const n = num(v);
    if (!n) return "";
    const txt = (Math.round(n * 100) / 100).toString() + (pct ? "%" : "");
    return `<span class="${cls}">${txt}</span>`;
  };

  const fmtTotal = (v, pct) => {
    const n = num(v);
    if (!n) return "";
    return "+" + (Math.round(n * 100) / 100).toString() + (pct ? "%" : "");
  };

  const buildLine = (label, key) => {
    const pct = isPctKey(key);
    const t = fmtTotal(total[key], pct);
    if (!t) return "";

    // åŸºæœ¬ = base + exceptionalï¼ˆç™½ï¼‰
    const baseN = num(baseOpt[key]) + num(excOpt[key]);
    const parts = [];

    if (baseN) parts.push(fmtPart(baseN, "c-base", pct));
    const starP = fmtPart(starOpt[key], "c-star", pct);
    const scrollP = fmtPart(scrollOpt[key], "c-scroll", pct);
    const flameP = fmtPart(flameOpt[key], "c-flame", pct);

    if (starP) parts.push(starP);
    if (scrollP) parts.push(scrollP);
    if (flameP) parts.push(flameP);

    // è‹¥å‰›å¥½ baseN=0ï¼Œä½†å…¶ä»–æœ‰å€¼ï¼Œä»é¡¯ç¤ºå…¶ä»–ï¼ˆä¸ç¡¬å¡ 0ï¼‰
    const sumParts = parts.length ? ` <span class="muted">(${parts.join(" + ")})</span>` : "";

    return `${escapeHtml(label)}: ${t}${sumParts}`;
  };

  const lines = [];
  const keys = [
    ["ç¨®é¡", null],
    ["STR", "str"],
    ["DEX", "dex"],
    ["INT", "int"],
    ["LUK", "luk"],
    ["æœ€å¤§HP", "max_hp"],
    ["æœ€å¤§MP", "max_mp"],
    ["æ”»æ“ŠåŠ›", "attack_power"],
    ["é­”æ³•æ”»æ“ŠåŠ›", "magic_power"],
    ["é˜²ç¦¦åŠ›", "armor"],
    ["å…¨å±¬æ€§", "all_stat"],
    ["BOSSæ€ªç‰©å‚·å®³", "boss_damage"],
    ["ç„¡è¦–æ€ªç‰©é˜²ç¦¦ç‡", "ignore_monster_armor"],
  ];

  // ç¨®é¡
  if (it.item_equipment_part || it.item_equipment_slot) {
    const partTxt = (it.item_equipment_part || it.item_equipment_slot || "").toString();
    lines.push(`ç¨®é¡ï¼š${escapeHtml(partTxt)}`);
  }

  for (const [label, key] of keys) {
    if (!key) continue;
    const l = buildLine(label, key);
    if (l) lines.push(l);
  }

  const statBlock = lines.length
    ? `<div class="ms-lines">${lines.map((x) => `<div class="ms-line">${x}</div>`).join("")}</div>`
    : "";


  // æ½›èƒ½
  const pot = renderPotentialBlock_(it.potential_option_grade, [it.potential_option_1, it.potential_option_2, it.potential_option_3], false);
  const addPot = renderPotentialBlock_(it.additional_potential_option_grade, [it.additional_potential_option_1, it.additional_potential_option_2, it.additional_potential_option_3], true);

  // éˆé­‚ / å…¶ä»–ç°¡å–®è³‡è¨Š
  const soulLines = [];
  if (it.soul_name) soulLines.push(`éˆé­‚ï¼š${escapeHtml(it.soul_name)}`);
  if (it.soul_option) soulLines.push(`${escapeHtml(it.soul_option)}`);

  return `
  <div class="ms-tip">
    <div class="ms-stars">${stars}</div>
    <div class="ms-title">${title}</div>

    <div class="ms-top">
      <div class="ms-iconframe">${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}</div>
      <div class="ms-lines">
        ${lines.map((s)=>`<div>${s}</div>`).join("")}
      </div>
    </div>

    ${soulLines.length ? `<div class="ms-divider"></div><div class="ms-lines">${soulLines.map((s)=>`<div>${s}</div>`).join("")}</div>` : ""}

    ${(pot || addPot) ? `<div class="ms-divider"></div>` : ""}

    ${pot || ""}
    ${addPot || ""}
  </div>`;
}

function buildCashModalHtml_(it) {
  const title = escapeHtml(it.cash_item_name || "");
  const icon = it.cash_item_icon || "";
  const part = it.cash_item_equipment_part || it.cash_item_equipment_slot || "";

  const lines = [];
  if (part) lines.push(`<div class="muted">ç¨®é¡ï¼š${escapeHtml(part)}</div>`);

  const opts = Array.isArray(it.cash_item_option) ? it.cash_item_option : [];
  for (const o of opts) {
    const t = o.option_type || "";
    const v = o.option_value || "";
    if (!t && !v) continue;
    lines.push(`${escapeHtml(String(t))}: ${escapeHtml(String(v))}`);
  }
  if (it.date_expire) lines.push(`<div class="muted">åˆ°æœŸï¼š${escapeHtml(it.date_expire)}</div>`);
  if (it.date_option_expire) lines.push(`<div class="muted">é¸é …åˆ°æœŸï¼š${escapeHtml(it.date_option_expire)}</div>`);

  return `
  <div class="ms-tip">
    <div class="ms-stars">${renderStars_(0, 0)}</div>
    <div class="ms-title">${title}</div>

    <div class="ms-top">
      <div class="ms-iconframe">${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}</div>
      <div class="ms-lines">
        ${lines.map((s)=>`<div>${s}</div>`).join("")}
      </div>
    </div>
  </div>`;
}

function setupModalOnce() {
  if (window.__modalInited) return;
  window.__modalInited = true;
  const modal = document.getElementById("modal");
  if (!modal) return;

  modal.addEventListener("click", (e) => {
    if (e.target && e.target.classList.contains("modal")) closeItemModal();
    if (e.target && e.target.getAttribute("data-close") === "1") closeItemModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeItemModal();
  });
}

function initItemModalOnce() {
  if (window.__itemModalInited) return;
  window.__itemModalInited = true;

  // é»èƒŒæ™¯é—œé–‰ã€ESC é—œé–‰
  const modal = document.getElementById("modal");
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeItemModal();
  });
  modal.querySelector(".modal-x").addEventListener("click", (e) => {
    e.preventDefault();
    closeItemModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeItemModal();
  });

  // é»è£å‚™ / æ™‚è£å°±é–‹å•Ÿ tooltip
  document.addEventListener("click", (e) => {
    const el = e.target.closest(".equip");
    if (!el) return;
    const type = el.dataset.type;
    const idx = el.dataset.idx;
    if (!type) return;
    e.preventDefault();
    e.stopPropagation();
    openItemModal(type, idx, el);
  });
}

function isZeroLike(v) {
  const s = String(v ?? "").trim();
  if (!s) return true;
  return s === "0" || s === "0.0" || s === "0.00" || s === "0%" || s === "0.000" || s === "0.0000";
}
function formatObjLines(obj, label, keyOrder = null) {
  if (!obj || typeof obj !== "object") return [];
  const lines = [];
  lines.push(label + "ï¼š");
  const keys = Array.isArray(keyOrder) ? keyOrder : Object.keys(obj);
  for (const k of keys) {
    const v = obj[k];
    if (v === undefined || v === null) continue;
    if (isZeroLike(v)) continue;
    lines.push(`- ${k}: ${v}`);
  }
  if (lines.length === 1) lines.push("- ï¼ˆç„¡ï¼‰");
  return lines;
}

/** ===== Render ===== */
function renderProfile(basic, date, popularity, metrics) {
  const expRate = basic.character_exp_rate ? formatPercent(basic.character_exp_rate) : "";
  const expText = basic.character_exp ? String(basic.character_exp) : "";
  const cls = basic.character_class || "";
  const world = basic.world_name || "";
  const level = basic.character_level ?? "";
  const guild = basic.character_guild_name || "";

  const img = basic.character_image || "";
  const chips = [
    world ? `ä¼ºæœå™¨ï¼š${world}` : "",
    cls ? `è·æ¥­ï¼š${cls}` : "",
    level !== "" ? `Lv.${level}` : "",
    guild ? `å…¬æœƒï¼š${guild}` : "",
    popularity !== "" ? `äººæ°£ï¼š${popularity}` : "",
    date ? `æ—¥æœŸï¼š${date}` : "",
  ].filter(Boolean);

  return `
    <div class="card big">
      <div class="profile">
        ${img ? `<img class="avatar" src="${esc(img)}" />` : `<div class="avatar"></div>`}
        <div>
          <p class="pname">${esc(basic.character_name || "")}</p>
          <div class="pmeta">
            EXPï¼š${esc(expText)} ${expRate ? `ï¼ˆ${esc(expRate)}ï¼‰` : ""}
          </div>
          <div class="chips">${chips.map(c=>`<span class="chip">${esc(c)}</span>`).join("")}</div>
        </div>
      </div>

      <div class="grid">
        ${renderMetric("æˆ°é¬¥åŠ›", formatZhUnit(metrics.combat_power))}
        ${renderMetric("BOSSå‚·", metrics.boss_damage ? formatPercent(metrics.boss_damage) : "")}
        ${renderMetric("ç„¡è¦–", metrics.ignore_def ? formatPercent(metrics.ignore_def) : "")}
        ${renderMetric("çˆ†å‚·", metrics.crit_damage ? formatPercent(metrics.crit_damage) : "")}
        ${renderMetric("çˆ†ç‡", metrics.crit_rate ? formatPercent(metrics.crit_rate) : "")}
        ${renderMetric("æœ€çµ‚å‚·", metrics.final_damage ? formatPercent(metrics.final_damage) : "")}
        ${renderMetric("å‚·å®³", metrics.damage ? formatPercent(metrics.damage) : "")}
        ${renderMetric("æ”»æ“ŠåŠ›", metrics.attack_power || "")}
      </div>
    </div>
  `;
}
function renderMetric(name, val) {
  return `
    <div class="metric">
      <div class="mname">${esc(name)}</div>
      <div class="mval">${esc(val || "-")}</div>
    </div>
  `;
}

function renderEquip(e) {
  const arr = Array.isArray(e?.item_equipment) ? e.item_equipment : [];
  window.__equipItems = arr;
  initItemModalOnce();

  const cells = arr.map((it, i) => {
    const icon = it.item_icon || it.item_shape_icon || "";
    const name = it.item_name || "";
    const star = it.starforce ? `â˜…${it.starforce}` : "";
    return `
      <div class="equip" role="button" tabindex="0" data-type="equip" data-idx="${i}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
        <div class="small">${esc(star)}</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card full">
      <div class="title">è£å‚™ï¼ˆequippedï¼‰</div>
      <div class="small" style="margin:6px 0 10px;">æ»‘é¼ ç§»åˆ°åœ–ç‰‡ä¸Šå¯çœ‹å®Œæ•´æ•¸å€¼ï¼ˆå«åŸå§‹ JSONï¼‰ã€‚</div>
      <div class="equip-grid">${cells || `<div class="muted">ç„¡è³‡æ–™</div>`}</div>
    </div>
  `;
}


function renderAbility(ability) {
  if (!ability) return "";

  // Nexon å›å‚³ï¼šability_info (ç›®å‰å¥—ç”¨) + ability_grade
  const info = Array.isArray(ability.ability_info) ? ability.ability_info : [];
  if (!info.length) return "";

  const gradeToBuff = (g) => {
    const s = String(g || "").trim();
    if (s.includes("å‚³èªª")) return "green";
    if (s.includes("ååŒ ")) return "blue";
    if (s.includes("ç¨ç‰¹") || s.includes("ç‰¹æ®Š")) return "purple";
    if (s.includes("å²è©©")) return "orange";
    if (s.includes("ç½•è¦‹")) return "orange";
    if (s.includes("ç¨€æœ‰")) return "orange";
    return "gray";
  };

  const rows = info
    .filter((x) => x && x.ability_value)
    .map((x) => {
      const cls = gradeToBuff(x.ability_grade || ability.ability_grade);
      return `<div class="ms-buff ${cls}">${escapeHtml(x.ability_value)}</div>`;
    })
    .join("");

  return `
<div class="sec">
  <div class="sec-title"><span class="ico">ğŸ‘ï¸</span> å…§æ½›</div>
  <div class="ability-wrap">${rows}</div>
</div>`;
}


function renderCash(c) {
  const arr = Array.isArray(c?.cash_item_equipment_base) ? c.cash_item_equipment_base : [];
  window.__cashItems = arr;
  initItemModalOnce();

  const cells = arr.map((it, i) => {
    const icon = it.cash_item_icon || "";
    const name = it.cash_item_name || "";
    return `
      <div class="equip" role="button" tabindex="0" data-type="cash" data-idx="${i}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
        <div class="small">&nbsp;</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card full">
      <div class="title">æ™‚è£ï¼ˆbaseï¼‰</div>
      <div class="small" style="margin:6px 0 10px;">æ»‘é¼ ç§»åˆ°åœ–ç‰‡ä¸Šå¯çœ‹å®Œæ•´æ•¸å€¼ï¼ˆå«åŸå§‹ JSONï¼‰ã€‚</div>
      <div class="equip-grid">${cells || `<div class="muted">ç„¡è³‡æ–™</div>`}</div>
    </div>
  `;
}

function renderLeaderboard() {
  const expTop = topByBigInt("exp", 50);
  const combatTop = topByBigInt("combat_power", 50);

  const table = (rows, type) => `
    <table>
      <thead>
        <tr>
          <th class="right">#</th>
          <th>è§’è‰²</th>
          <th>ä¼ºæœå™¨</th>
          <th class="right">${type==="exp"?"EXP":"æˆ°é¬¥åŠ›"}</th>
          <th class="right">Lv</th>
          <th class="right">æ›´æ–°æ™‚é–“</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map((r,i)=>`
          <tr>
            <td class="right">${i+1}</td>
            <td>${esc(r.character_name||"")}</td>
            <td>${esc(r.world_name||"")}</td>
            <td class="right">${type==="exp"?esc(r.exp||""):esc(formatZhUnit(r.combat_power||""))}</td>
            <td class="right">${esc(r.level||"")}</td>
            <td class="right">${esc(r.fetched_at||"")}</td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="muted">å°šç„¡è³‡æ–™ï¼ˆå…ˆæŸ¥è©¢å¹¾å€‹è§’è‰²ï¼‰</td></tr>`}
      </tbody>
    </table>
  `;

  return `
    <div class="card full">
      <div class="title">æ’è¡Œæ¦œï¼ˆä»¥ä½ æŸ¥éçš„è§’è‰²ç‚ºæº–ï¼‰</div>
      <div class="tabs">
        <button class="tab active" id="tabExp" onclick="switchTab('exp')">ç¶“é©—å€¼æ’è¡Œæ¦œ</button>
        <button class="tab" id="tabCombat" onclick="switchTab('combat')">æˆ°é¬¥åŠ›æ’è¡Œæ¦œ</button>
        <span class="small">ï¼ˆè³‡æ–™å­˜åœ¨ç€è¦½å™¨ localStorageï¼‰</span>
      </div>
      <div id="lbExp" style="margin-top:10px;">${table(expTop, "exp")}</div>
      <div id="lbCombat" style="margin-top:10px; display:none;">${table(combatTop, "combat")}</div>
    </div>
  `;
}

function switchTab(which) {
  const a = $("tabExp"), b = $("tabCombat");
  const exp = $("lbExp"), combat = $("lbCombat");
  if (which === "exp") {
    a.classList.add("active"); b.classList.remove("active");
    exp.style.display = "block"; combat.style.display = "none";
  } else {
    b.classList.add("active"); a.classList.remove("active");
    combat.style.display = "block"; exp.style.display = "none";
  }
}

/** ===== ä¸»æµç¨‹ ===== */
async function run() {
  const name = $("name").value.trim();
  if (!name) {
    $("status").innerHTML = `<span class="err">è«‹è¼¸å…¥è§’è‰²æš±ç¨±</span>`;
    return;
  }

  $("btn").disabled = true;
  $("status").textContent = "æŸ¥è©¢ä¸­â€¦";
  $("out").innerHTML = "";

  const date = getYesterdayYmdTz();
  const url = `${WORKER_BASE.replace(/\/+$/,"")}/character?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&parts=${encodeURIComponent(DEFAULT_PARTS)}`;

  try {
    const t0 = performance.now();
    const resp = await fetch(url, { method:"GET", cache:"no-store" });
    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); } catch(e) {
      throw new Error(`Worker å›å‚³ä¸æ˜¯ JSONï¼š${text.slice(0,200)}`);
    }
    if (!json.ok) {
      const msg = json?.body?.error?.message || `HTTP ${json.status || resp.status}`;
      throw new Error(msg);
    }

    const data = json.data || {};
    const basic = data.basic || {};
    const popularity = data.popularity?.popularity ?? "";
    const statMap = statArrayToMap(data.stat?.final_stat);
    const metrics = extractMetrics(statMap);

    const now = new Date();
    const fetched_at = fmtTs(now);
    upsertLB({
      character_name: basic.character_name || name,
      world_name: basic.world_name || "",
      class: basic.character_class || "",
      level: basic.character_level ?? "",
      exp: basic.character_exp ?? "",
      combat_power: metrics.combat_power ?? "",
      date,
      fetched_at,
    });

    const t1 = performance.now();
    $("status").textContent = `å®Œæˆï¼ˆè€—æ™‚ ${(t1-t0)/1000.0 >= 1 ? ((t1-t0)/1000).toFixed(2)+'s' : Math.round(t1-t0)+'ms'}ï¼‰`;

    $("out").innerHTML =
      renderProfile(basic, date, popularity, metrics) +
      renderAbility(data.ability) +
      renderEquip(data.itemEquipment) +
      renderCash(data.cashitemEquipment) +
      renderLeaderboard();

  } catch (err) {
    $("status").innerHTML = `<span class="err">æŸ¥è©¢å¤±æ•—ï¼š${esc(err?.message || String(err))}</span>`;
    $("out").innerHTML = renderLeaderboard();
  } finally {
    $("btn").disabled = false;
  }
}

// Enter é€å‡º
document.addEventListener("keydown", (e)=> {
  if (e.key === "Enter" && document.activeElement === $("name")) run();
});

// é å¡«ï¼ˆæ–¹ä¾¿ä½ æ¸¬ï¼‰
if (!$("name").value) $("name").value = "Ezraçµ•";


</script>
</body>
</html>
