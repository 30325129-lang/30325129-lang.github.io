<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maple 角色查詢（Web）</title>
  <style>

:root{
  --bg:#050608;
  --panel:#1b1f2a;
  --panel2:#23283a;
  --line:#303851;
  --text:#e9edf7;
  --muted:#aab4c3;
  --accent:#00d1ff;
  --good:#4ade80;
  --warn:#fbbf24;
  --bad:#fb7185;
}
*{box-sizing:border-box;}
html,body{height:100%;}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
  background: radial-gradient(1000px 600px at 20% 0%, rgba(0,209,255,.12), transparent 55%),
              radial-gradient(900px 540px at 90% 10%, rgba(168,85,247,.10), transparent 60%),
              var(--bg);
  color:var(--text);
}
a{color:var(--accent);text-decoration:none;}
.wrap{max-width:1200px;margin:0 auto;padding:28px 18px 44px;}
h1{margin:0 0 4px;font-size:22px;font-weight:800;letter-spacing:.2px;}
.sub{color:var(--muted);font-size:13px;margin-bottom:16px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:10px 0 16px;}
.input{
  flex:1 1 360px;
  height:44px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  outline:none;
}
.input:focus{border-color:rgba(0,209,255,.55); box-shadow:0 0 0 3px rgba(0,209,255,.12);}
.btn{
  height:44px;
  padding:0 16px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:var(--text);
  cursor:pointer;
  font-weight:700;
}
.btn.primary{background:linear-gradient(180deg, rgba(0,209,255,.20), rgba(0,209,255,.08)); border-color:rgba(0,209,255,.35);}
.btn:active{transform:translateY(1px);}
.status{min-height:18px;color:var(--muted);font-size:13px;margin:6px 0 14px;}
.panel{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:18px;
  padding:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.grid{
  display:grid;
  grid-template-columns: 300px 1fr;
  gap:14px;
}
@media (max-width: 980px){
  .grid{grid-template-columns:1fr;}
}
.char{
  display:flex; gap:14px; align-items:center;
}
.avatar{
  width:88px;height:88px;border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.avatar img{width:100%;height:100%;object-fit:contain;image-rendering:auto;}
.char h2{margin:0;font-size:20px;font-weight:900;}
.char .meta{color:var(--muted);font-size:13px;margin-top:2px;line-height:1.45;}
.kpis{
  display:grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap:10px;
  margin-top:12px;
}
@media (max-width: 980px){
  .kpis{grid-template-columns: repeat(2, minmax(0,1fr));}
}
.kpi{
  border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  padding:10px 12px;
}
.kpi .k{color:var(--muted);font-size:12px;margin-bottom:4px}
.kpi .v{font-size:18px;font-weight:900;letter-spacing:.2px}
.section-title{
  margin:18px 0 10px;
  font-size:14px;
  font-weight:900;
  color:var(--text);
  display:flex; align-items:center; justify-content:space-between;
}
.abilityWrap{display:flex;flex-direction:column;gap:8px;}
.small{color:var(--muted);font-size:12px}
.equip-grid{
  display:flex; flex-wrap:wrap; gap:10px;
}
.equip{
  width:84px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.22);
  padding:8px 8px 6px;
  cursor:pointer;
  user-select:none;
  transition:transform .08s ease, border-color .12s ease;
}
.equip:hover{transform:translateY(-1px); border-color:rgba(0,209,255,.35);}
.equip .iconbox{
  width:68px;height:68px;border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  margin:0 auto;
}
.equip img{max-width:100%;max-height:100%;image-rendering:auto;}
.equip .nm{
  margin-top:6px;
  font-size:11px;
  line-height:1.2;
  text-align:center;
  color:rgba(233,237,247,.92);
  min-height:26px;
  overflow:hidden;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
}
.equip .sf{
  text-align:center;
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}

/* ===== Modal ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.60);
  z-index:9999;
}
.modal.hidden{display:none;}
.modal-panel{
  position:fixed;
  width:420px;
  max-width:calc(100vw - 32px);
  max-height:calc(100vh - 32px);
  overflow:auto;
  background:transparent; /* inner tooltip handles bg */
}
.modal-x{
  position:absolute;
  top:10px; right:10px;
  width:34px;height:34px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.35);
  color:var(--text);
  font-size:18px;
  cursor:pointer;
  z-index:2;
}
.modal-x:hover{border-color:rgba(0,209,255,.35);}

/* ===== Maple-like tooltip ===== */
.ms-tip{
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(43,47,66,.98), rgba(33,36,54,.98));
  box-shadow:0 24px 70px rgba(0,0,0,.55);
  padding:14px 14px 12px;
  position:relative;
}
.ms-stars{
  font-size:14px;
  letter-spacing:1px;
  color:#fff;
  opacity:.95;
  text-shadow:0 1px 0 rgba(0,0,0,.35);
  margin-bottom:6px;
  line-height:1.1;
  white-space:nowrap;
}
.ms-title{
  font-size:16px;
  font-weight:900;
  margin-bottom:10px;
  color:#fff;
}
.ms-top{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.ms-iconframe{
  width:62px;height:62px;border-radius:14px;
  border:2px solid rgba(173,255,47,.55);
  box-shadow:0 0 0 2px rgba(0,0,0,.40) inset;
  background:rgba(0,0,0,.20);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
}
.ms-iconframe img{max-width:100%;max-height:100%;}
.ms-lines{
  flex:1;
  font-size:13px;
  line-height:1.55;
  color:rgba(255,255,255,.92);
}
.ms-lines .muted{color:rgba(170,180,195,.95);}
.ms-divider{
  height:1px;
  background:rgba(255,255,255,.10);
  margin:10px 0;
}
.ms-bar{
  margin-top:10px;
  border-radius:6px;
  padding:6px 10px;
  font-size:13px;
  font-weight:900;
  display:flex;
  gap:8px;
  align-items:center;
  color:#0b0c10;
}
.ms-bar .tag{
  width:22px;height:22px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;
  font-weight:1000;
  background:rgba(0,0,0,.18);
  border:1px solid rgba(0,0,0,.18);
}
.ms-bar.legendary{background:linear-gradient(90deg, #c7ff3a, #7cffd6);}
.ms-bar.unique{background:linear-gradient(90deg, #ffb020, #ffd27a);} /* 罕見 */
.ms-bar.epic{background:linear-gradient(90deg,#7dd3fc,#93c5fd);} /* 史詩/特殊（保留舊class） */
.ms-bar.rare{background:linear-gradient(90deg, #a78bfa, #6c44c8);} /* 稀有/附加稀有 */
.ms-bar.special{background:linear-gradient(90deg,#7dd3fc,#93c5fd);} /* 特殊/特殊級 */
.ms-bar.special .tag{background:rgba(125,211,252,.22);border:1px solid rgba(125,211,252,.55);}
.ms-bar.rare .tag{background:rgba(167,139,250,.18);border:1px solid rgba(167,139,250,.55);}
.ms-bar.unique .tag{background:rgba(255,176,32,.18);border:1px solid rgba(255,176,32,.55);}
.ms-bar.common{background:linear-gradient(90deg, #94a3b8, #cbd5e1);}
.ms-opt{
  margin-top:6px;
  font-size:13px;
  color:rgba(255,255,255,.94);
}
.ms-opt .line{margin:2px 0;}
.ms-foot{
  margin-top:10px;
  display:flex;flex-direction:column;gap:6px;
}
.ms-buff{
  border-radius:8px;
  padding:8px 10px;
  font-size:13px;
  font-weight:800;
  color:#10131a;
}
.ms-buff.green{background:linear-gradient(90deg, #b8ff3a, #7cffd6);}
.ms-buff.orange{background:linear-gradient(90deg, #ffb020, #ffd27a);}


.ms-buff.cyan{background:linear-gradient(90deg, #3ac6ff, #a7e8ff);}
/* 內潛（依級別上色） */
.ability-wrap{margin-top:8px;display:flex;flex-direction:column;gap:10px;}
.ms-buff.blue{background:linear-gradient(0deg,#0b4a8f,#0f5fb8);}
.ms-buff.purple{background:linear-gradient(0deg,#4a2a88,#6c44c8);}
.ms-buff.gray{background:linear-gradient(0deg,#3a3f49,#4a5160);}

/* 裝備數值配色：基本(白) + 星力(黃) + 卷軸(藍) + 星火(綠) */
.c-base{color:rgba(255,255,255,.92);font-weight:700;}
.c-star{color:#ffd35a;font-weight:800;}
.c-scroll{color:#53b6ff;font-weight:800;}
.c-flame{color:#7cff7c;font-weight:800;}

/* ====== 裝備視窗（仿遊戲背包版面） ====== */
.invWrap{ max-width: 980px; margin: 10px auto 0; }
.invFrame{
  background: linear-gradient(180deg, rgba(245,246,248,.98), rgba(219,223,228,.98));
  border: 1px solid rgba(170,175,182,.9);
  border-radius: 12px;
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  overflow: hidden;
}
.invTop{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 12px 6px 12px;
  font-weight: 800;
  letter-spacing: .5px;
  color: #2b2f36;
  text-transform: uppercase;
  font-size: 13px;
}
.invTop .closeBtn{
  width: 28px; height: 24px;
  border-radius: 8px;
  border: 1px solid rgba(120,128,138,.8);
  background: linear-gradient(180deg, rgba(250,250,252,.9), rgba(210,214,220,.9));
  cursor: pointer;
}
.invTabs{
  display:flex; gap: 8px;
  padding: 0 12px 0 12px;
}
.invTab{
  padding: 8px 12px;
  border-radius: 10px 10px 0 0;
  border: 1px solid rgba(25,112,132,.9);
  background: linear-gradient(180deg, rgba(32,170,195,.95), rgba(22,126,150,.95));
  color: #fff;
  font-weight: 800;
  cursor: pointer;
  min-width: 88px;
  text-align:center;
}
.invTab.inactive{
  border-color: rgba(120,125,132,.85);
  background: linear-gradient(180deg, rgba(130,134,140,.92), rgba(90,94,100,.92));
  color: rgba(255,255,255,.9);
}
.invBody{
  padding: 12px;
}
.invInner{
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(245,247,250,.96));
  border: 1px solid rgba(180,186,194,.9);
  border-radius: 12px;
  padding: 14px;
  display:grid;
  grid-template-columns: 128px 1fr 128px;
  gap: 14px;
}
.invGrid{
  display:grid;
  grid-template-columns: repeat(2, 56px);
  gap: 8px;
  justify-content:center;
  align-content:start;
}
.invSlot{
  width: 56px; height: 56px;
  border-radius: 8px;
  border: 2px solid rgba(120,125,132,.95);
  background: linear-gradient(180deg, rgba(40,42,46,.92), rgba(25,26,30,.92));
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
  display:flex; align-items:center; justify-content:center;
  position: relative;
}
.invSlot.filled{
  border-color: rgba(66,220,78,.95);
  cursor: pointer;
}
.invSlot.empty{ opacity: .9; }
.invSlot img{
  width: 48px; height: 48px;
  image-rendering: pixelated;
  filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
}
.invStarBadge{
  position:absolute;
  left: 6px;
  bottom: 4px;
  display:flex; align-items:center; gap: 2px;
  font-size: 11px;
  font-weight: 900;
  color: #ffd86a;
  text-shadow: 0 2px 6px rgba(0,0,0,.85);
  pointer-events:none;
}
.invStarBadge .s{ font-size: 10px; opacity:.95; }
.invCenter{
  display:flex; flex-direction:column;
  align-items:center; justify-content:flex-start;
  gap: 10px;
}
.invPreview{
  width: min(420px, 100%);
  height: 220px;
  border-radius: 12px;
  border: 1px solid rgba(190,196,204,.95);
  background:
    radial-gradient(circle at 50% 40%, rgba(255,255,255,.9), rgba(215,220,226,.85) 55%, rgba(195,200,206,.85)),
    linear-gradient(180deg, rgba(255,255,255,.0), rgba(0,0,0,.08));
  display:flex; align-items:center; justify-content:center;
  overflow:hidden;
  position:relative;
}
.invPreview .bgGlow{
  position:absolute; inset: 0;
  background: radial-gradient(circle at 50% 50%, rgba(255,225,160,.18), rgba(0,0,0,0) 60%);
  pointer-events:none;
}
.invPreview img{
  width: 160px; height: 160px;
  image-rendering: pixelated;
  filter: drop-shadow(0 20px 26px rgba(0,0,0,.28));
}
.invCharName{
  font-weight: 900;
  color: rgba(40,44,50,.95);
}
.invFooter{
  display:flex; align-items:center; justify-content:space-between;
  padding: 10px 12px 12px 12px;
  gap: 12px;
  flex-wrap: wrap;
}
.invPresets{
  display:flex; align-items:center; gap: 8px;
}
.invPresetLabel{
  font-weight: 900;
  color: rgba(35,40,46,.85);
  font-size: 12px;
}
.invPresetBtn{
  width: 30px; height: 22px;
  border-radius: 6px;
  border: 1px solid rgba(135,140,148,.9);
  background: linear-gradient(180deg, rgba(250,250,252,.95), rgba(210,214,220,.95));
  cursor:pointer;
  font-weight: 900;
  color: rgba(40,44,50,.9);
}
.invPresetBtn.active{
  border-color: rgba(30,130,160,.95);
  background: linear-gradient(180deg, rgba(45,190,210,.95), rgba(24,135,160,.95));
  color: #fff;
}
.invExtras{
  width: 100%;
  display:flex; gap: 8px; flex-wrap: wrap;
  padding: 10px 12px 12px 12px;
  border-top: 1px solid rgba(195,200,206,.9);
  background: rgba(240,242,245,.85);
}
.invExtrasTitle{
  width: 100%;
  font-weight: 900;
  color: rgba(40,44,50,.7);
  font-size: 12px;
}

</style>
</head>
<body>
  <div class="wrap">
    <h1>Maple 角色查詢（Web）</h1>
    <div class="sub">只輸入角色暱稱；日期自動查詢昨天（台灣時間）。戰鬥力顯示「億/萬」單位；BOSS傷/無視/爆傷/爆率/最終傷/傷害 皆自動加上 %。裝備/時裝滑鼠移到圖片即可看完整數值。</div>

    <div class="search">
      <input id="name" type="text" placeholder="輸入角色暱稱（例：Ezra絕）" />
      <button id="btn" onclick="run()">查詢</button>
    </div>
    <div id="status" class="status">待命</div>

    <div id="out" class="row"></div>
  </div>
<div id="modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-panel" role="document">
      <button class="modal-x" type="button" aria-label="關閉">×</button>
      <div class="modal-body"></div>
    </div>
  </div>


<script>


/** ===== 基本設定 ===== */
const WORKER_BASE = "https://maple-proxy.ezraop.workers.dev";
const DEFAULT_PARTS = "basic,popularity,stat,ability,itemEquipment,cashitemEquipment,symbolEquipment";
const TZ = "Asia/Taipei";

/** ===== DOM helper ===== */
const $ = (id) => document.getElementById(id);
const esc = (s) => String(s ?? "").replace(/[&<>\"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

/** ===== 日期（台灣）昨天 yyyy-mm-dd ===== */
function getYesterdayYmdTz() {
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
  const parts = fmt.formatToParts(new Date());
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const dt = new Date(Date.UTC(y, m-1, d));
  dt.setUTCDate(dt.getUTCDate() - 1);
  const y2 = dt.getUTCFullYear();
  const m2 = String(dt.getUTCMonth()+1).padStart(2,"0");
  const d2 = String(dt.getUTCDate()).padStart(2,"0");
  return `${y2}-${m2}-${d2}`;
}


function fmtTs(d) {
  try {
    return new Intl.DateTimeFormat("zh-TW", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).format(d);
  } catch (e) {
    // fallback
    return d.toISOString();
  }
}


/** ===== BigInt 單位格式：億/萬 ===== */
function formatZhUnit(nLike) {
  // 專門給「戰鬥力」用：>=1億時一定同時顯示「億」與「萬」
  const s0 = String(nLike ?? "").trim();
  if (!s0) return "";
  const s = s0.replace(/,/g, "");
  if (!/^\d+$/.test(s)) return s0;

  const n = BigInt(s);
  const YI = 100000000n;
  const WAN = 10000n;

  if (n >= YI) {
    const yi = n / YI;
    const remYi = n % YI;
    const wan = remYi / WAN;
    const rem = remYi % WAN; // 0..9999
    // 億、萬固定出現；餘數(千/百/十/個)視情況補上
    return `${yi}億${wan}萬${rem === 0n ? "" : String(rem)}`;
  }
  if (n >= WAN) {
    const wan = n / WAN;
    const rem = n % WAN;
    return `${wan}萬${rem === 0n ? "" : String(rem)}`;
  }
  return String(n);
}


/** ===== % 顯示 ===== */
function formatPercent(v) {
  const s = String(v ?? "").trim();
  if (!s) return "";
  if (s.includes("%")) return s;
  return s + "%";
}



/** ===== HTML 轉義（避免 XSS / 避免面板炸掉） ===== */
function escapeHtml(input) {
  const s = String(input ?? "");
  return s.replace(/[&<>"']/g, (ch) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;",
  }[ch]));
}


function renderStars_(n, max) {
  const nn = Math.max(0, Math.floor(Number(n) || 0));
  const mm = Math.max(0, Math.floor(Number(max) || 0));
  if (!mm) return "";
  const filled = "★".repeat(Math.min(nn, mm));
  const empty = "☆".repeat(Math.max(0, mm - nn));
  // 分兩行顯示，避免太長
  const s = filled + empty;
  if (s.length <= 15) return s;
  return s.slice(0, 15) + "<br>" + s.slice(15);
}

function fmtNum_(v, isPct) {
  const n = Number(v || 0);
  const sign = n >= 0 ? "+" : "";
  const abs = Math.abs(n);
  const txt = abs % 1 === 0 ? abs.toString() : abs.toFixed(2);
  return sign + txt + (isPct ? "%" : "");
}

function potentialClass_(grade) {
  const g = String(grade || "").trim();
  if (!g) return "common";

  // 依你指定：傳說=綠、罕見=橘、特殊/特殊級=淺藍、稀有/附加稀有=紫
  if (g.includes("傳說") || g.toLowerCase().includes("legend")) return "legendary";
  if (g.includes("罕見") || g.toLowerCase().includes("unique")) return "unique";
  if (g.includes("特殊級") || g.includes("特殊") || g.includes("史詩") || g.toLowerCase().includes("epic") || g.toLowerCase().includes("special")) return "special";
  if (g.includes("稀有") || g.toLowerCase().includes("rare")) return "rare";
  return "common";
}

function potentialTag_(grade) {
  const g = String(grade || "").trim();
  if (!g) return "C";
  if (g.includes("傳說") || g.toLowerCase().includes("legend")) return "L";
  if (g.includes("罕見") || g.toLowerCase().includes("unique")) return "U";
  if (g.includes("特殊級") || g.includes("特殊") || g.includes("史詩") || g.toLowerCase().includes("epic") || g.toLowerCase().includes("special")) return "C";
  if (g.includes("稀有") || g.toLowerCase().includes("rare")) return "R";
  return "C";
}

function renderPotentialBlock_(grade, opts, isAdd) {
  const g = String(grade || "").trim();
  const list = (opts || []).filter((x) => String(x || "").trim());
  if (!g && !list.length) return "";
  const cls = potentialClass_(g);
  const tag = potentialTag_(g);
  const title = isAdd ? "附加潛能" : "潛能";
  return `
    <div class="ms-bar ${cls}">
      <div class="tag">${tag}</div>
      <div>${escapeHtml(title)}</div>
    </div>
    <div class="ms-opt">
      ${list.map((s)=>`<div class="line">${escapeHtml(String(s))}</div>`).join("")}
    </div>
  `;
}


/** ===== 8 大數值抽取 ===== */
function statArrayToMap(final_stat) {
  const map = {};
  if (Array.isArray(final_stat)) {
    for (const s of final_stat) {
      if (s && s.stat_name) map[s.stat_name] = s.stat_value;
    }
  }
  return map;
}
function pick(map, keys) {
  for (const k of keys) {
    const v = map[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}
function extractMetrics(statMap) {
  const boss = pick(statMap, ["BOSS怪物傷害","Boss怪物傷害","boss怪物傷害"]);
  return {
    combat_power: pick(statMap, ["戰鬥力"]),
    boss_damage: boss,
    ignore_def: pick(statMap, ["無視防禦率"]),
    crit_damage: pick(statMap, ["爆擊傷害"]),
    crit_rate: pick(statMap, ["爆擊機率"]),
    final_damage: pick(statMap, ["最終傷害"]),
    damage: pick(statMap, ["傷害"]),
    attack_power: pick(statMap, ["攻擊力"]),
  };
}

/** ===== Leaderboard（全網共用 Google Sheet）===== */
const SHEET_ID = "1XTOyTA5m9EamrEg8BKAFJAZenRnxBA1kPMYLqQtM63s";
const SHEET_NAME = "characters";
const LB_LIMIT = 50;
const LB_CACHE_MS = 60 * 1000;

let __lbCache = { at: 0, rows: null };
let __lbLoading = false;

function gvizJsonp_(sheetName, tq = "") {
  return new Promise((resolve, reject) => {
    const cb = "__gviz_cb_" + Math.random().toString(36).slice(2);
    const script = document.createElement("script");
    const timeout = setTimeout(() => {
      cleanup();
      reject(new Error("排行榜載入逾時"));
    }, 15000);

    window[cb] = (resp) => {
      cleanup();
      resolve(resp);
    };

    const tqx = `out:json;responseHandler:${cb}`;
    const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
    const url = `${base}?sheet=${encodeURIComponent(sheetName)}&tq=${encodeURIComponent(tq)}&tqx=${encodeURIComponent(tqx)}&headers=1`;

    script.src = url;
    script.async = true;
    script.onerror = () => {
      cleanup();
      reject(new Error("排行榜載入失敗（網路或試算表權限）"));
    };
    document.head.appendChild(script);

    function cleanup() {
      clearTimeout(timeout);
      try { delete window[cb]; } catch(e) { window[cb] = undefined; }
      if (script && script.parentNode) script.parentNode.removeChild(script);
    }
  });
}

function gvizToObjects_(resp) {
  try {
    const table = resp && resp.table;
    const cols = (table && table.cols) || [];
    const rows = (table && table.rows) || [];
    const headers = cols.map((c, i) => (c && (c.label || c.id)) || `col_${i}`);

    return rows.map((r) => {
      const obj = {};
      const cells = (r && r.c) || [];
      for (let i = 0; i < headers.length; i++) {
        const cell = cells[i];
        obj[headers[i]] = (cell && cell.v !== undefined) ? cell.v : "";
      }
      return obj;
    });
  } catch (e) {
    return [];
  }
}

function pickField_(obj, candidates) {
  for (const k of candidates) {
    if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
  }
  // case-insensitive fallback
  const keys = obj ? Object.keys(obj) : [];
  for (const cand of candidates) {
    const found = keys.find(k => k.toLowerCase() === String(cand).toLowerCase());
    if (found) return obj[found];
  }
  return "";
}

function parseZhUnitToBigInt_(s) {
  // 支援：65億4321萬2345 / 65億4321萬 / 4321萬2345 / 12345
  try {
    let str = String(s || "").replace(/,/g, "").trim();
    if (!str) return 0n;

    let total = 0n;

    const yiMatch = str.match(/^(\d+)\s*億/);
    if (yiMatch) {
      total += BigInt(yiMatch[1]) * 100000000n;
      str = str.slice(yiMatch[0].length);
    }

    const wanMatch = str.match(/^(\d+)\s*萬/);
    if (wanMatch) {
      total += BigInt(wanMatch[1]) * 10000n;
      str = str.slice(wanMatch[0].length);
    }

    const remMatch = str.match(/^(\d+)/);
    if (remMatch) total += BigInt(remMatch[1]);

    return total;
  } catch (e) {
    return 0n;
  }
}

function parseBigInt_(v) {
  if (v === null || v === undefined) return 0n;
  if (typeof v === "number" && Number.isFinite(v)) return BigInt(Math.floor(v));
  const s0 = String(v).trim();
  if (!s0) return 0n;

  const s = s0.replace(/,/g, "").trim();
  if (/[億萬]/.test(s)) return parseZhUnitToBigInt_(s);

  if (/^\d+$/.test(s)) {
    try { return BigInt(s); } catch (e) { return 0n; }
  }

  const n = Number(s);
  if (Number.isFinite(n)) return BigInt(Math.floor(n));
  return 0n;
}

function normalizeLbRow_(raw) {
  const name = pickField_(raw, ["character_name", "name", "角色", "角色名稱", "character"]);
  const world = pickField_(raw, ["world_name", "world", "伺服器", "server"]);
  const level = pickField_(raw, ["level", "Lv", "lv", "等級"]);
  const exp = pickField_(raw, ["exp", "EXP", "experience", "經驗", "經驗值"]);
  const combat = pickField_(raw, ["combat_power", "combat", "power", "戰鬥力", "combatPower", "combat_power_raw"]);
  const updated = pickField_(raw, ["fetched_at", "updated_at", "updatedAt", "timestamp", "更新時間", "日期", "date"]);

  return {
    character_name: name || "",
    world_name: world || "",
    level: level || "",
    exp: exp || "",
    combat_power: combat || "",
    fetched_at: updated || "",
  };
}

async function getSharedLeaderboardRows_() {
  const now = Date.now();
  if (__lbCache.rows && (now - __lbCache.at) < LB_CACHE_MS) return __lbCache.rows;

  const resp = await gvizJsonp_(SHEET_NAME, "select *");
  const objs = gvizToObjects_(resp);

  const rows = objs
    .map(normalizeLbRow_)
    .filter(r => String(r.character_name || "").trim());

  __lbCache = { at: now, rows };
  return rows;
}

function sortTop_(rows, field) {
  const arr = [...(rows || [])];
  arr.sort((a, b) => {
    const A = parseBigInt_(a[field]);
    const B = parseBigInt_(b[field]);
    if (B > A) return 1;
    if (B < A) return -1;
    return String(b.fetched_at || "").localeCompare(String(a.fetched_at || ""));
  });
  return arr.slice(0, LB_LIMIT);
}

function renderLbTable_(rows, type) {
  const isExp = type === "exp";
  const headVal = isExp ? "EXP" : "戰鬥力";
  const body = (rows || []).map((r, i) => {
    const val = isExp ? String(r.exp || "") : formatZhUnit(r.combat_power || "");
    return `
      <tr>
        <td class="right">${i + 1}</td>
        <td>${esc(r.character_name || "")}</td>
        <td>${esc(r.world_name || "")}</td>
        <td class="right">${esc(val || "")}</td>
        <td class="right">${esc(r.level || "")}</td>
        <td class="right">${esc(r.fetched_at || "")}</td>
      </tr>
    `;
  }).join("");

  return `
    <table>
      <thead>
        <tr>
          <th class="right">#</th>
          <th>角色</th>
          <th>伺服器</th>
          <th class="right">${headVal}</th>
          <th class="right">Lv</th>
          <th class="right">更新時間</th>
        </tr>
      </thead>
      <tbody>
        ${body || `<tr><td colspan="6" class="muted">尚無資料</td></tr>`}
      </tbody>
    </table>
  `;
}/** ===== Tooltip（點一下顯示完整數值（點背景可關閉））===== */
let __lastPointer = { x: 0, y: 0 };
let __tipInited = false;
window.__equipItems = [];
window.__cashItems = [];

function openItemModal(type, idx, anchorEl) {
  const it = getItemByTypeIdx_(type, idx);
  if (!it) return;

  const modal = document.getElementById("modal");
  const panel = modal.querySelector(".modal-panel");
  const body = modal.querySelector(".modal-body");

  let html = "";
  if (type === "equip") html = buildEquipModalHtml_(it);
  else if (type === "cash") html = buildCashModalHtml_(it);
  else html = "<div class='ms-tip'>無法顯示</div>";

  body.innerHTML = html;

  modal.classList.remove("hidden");

  // 先給一個合理寬度
  const desiredW = 420;
  const maxW = Math.max(280, window.innerWidth - 32);
  const pw = Math.min(desiredW, maxW);
  panel.style.width = pw + "px";

  // 定位：優先放在點擊物件左側，空間不夠再放右側
  const rect = anchorEl ? anchorEl.getBoundingClientRect() : { left: window.innerWidth / 2, right: window.innerWidth / 2, top: window.innerHeight / 2 };
  let left = rect.left - pw - 14;
  if (left < 16) left = rect.right + 14;
  left = Math.min(left, window.innerWidth - pw - 16);
  left = Math.max(16, left);

  // top 先對齊到 item 上方一點，之後再 clamp
  let top = rect.top - 80;
  top = Math.max(16, top);

  panel.style.left = left + "px";
  panel.style.top = top + "px";

  // 顯示後取得高度，避免超出視窗
  requestAnimationFrame(() => {
    const ph = panel.offsetHeight || 0;
    let t = top;
    if (t + ph > window.innerHeight - 16) t = Math.max(16, window.innerHeight - ph - 16);
    panel.style.top = t + "px";
  });
}

function closeItemModal() {
  const modal = document.getElementById("modal");
  if (!modal) return;
  modal.classList.add("hidden");
  const body = modal.querySelector(".modal-body");
  if (body) body.innerHTML = "";
}

function getItemByTypeIdx_(type, idx) {
  const i = Number(idx);
  if (!Number.isFinite(i) || i < 0) return null;
  if (type === "equip") return (window.__equipItems || [])[i] || null;
  if (type === "cash") return (window.__cashItems || [])[i] || null;
  return null;
}

function gradeClass_(g) {
  const s = String(g || "");
  if (s.includes("傳說")) return "g-legend";
  if (s.includes("特殊")) return "g-unique";
  if (s.includes("罕見")) return "g-epic";
  if (s.includes("稀有")) return "g-rare";
  return "g-normal";
}

function pickNum_(v) {
  const s = String(v ?? "").trim();
  if (!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function buildOptionLines_(label, totalObj, baseObj, addObj, etcObj, starObj, exObj) {
  const keys = [
    ["str", "STR"],
    ["dex", "DEX"],
    ["int", "INT"],
    ["luk", "LUK"],
    ["max_hp", "最大HP"],
    ["max_mp", "最大MP"],
    ["attack_power", "攻擊力"],
    ["magic_power", "魔法攻擊力"],
    ["armor", "防禦力"],
    ["speed", "移動速度"],
    ["jump", "跳躍力"],
  ];

  const lines = [];
  for (const [k, name] of keys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;

    const parts = [];
    const b = pickNum_(baseObj?.[k]); if (b) parts.push(b);
    const a = pickNum_(addObj?.[k]); if (a) parts.push(a);
    const e = pickNum_(etcObj?.[k]); if (e) parts.push(e);
    const s = pickNum_(starObj?.[k]); if (s) parts.push(s);
    const x = pickNum_(exObj?.[k]); if (x) parts.push(x);

    const breakdown = parts.length >= 2 ? ` (${parts.join(" + ")})` : "";
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${breakdown}</span></div>`);
  }

  // 百分比類
  const pctKeys = [
    ["all_stat", "全屬性", "%"],
    ["boss_damage", "BOSS傷", "%"],
    ["ignore_monster_armor", "無視", "%"],
    ["damage", "傷害", "%"],
    ["max_hp_rate", "最大HP", "%"],
    ["max_mp_rate", "最大MP", "%"],
  ];
  for (const [k, name, unit] of pctKeys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${unit}</span></div>`);
  }

  return lines.length ? lines.join("") : `<div class="muted">（無可顯示的屬性）</div>`;
}

function buildEquipModalHtml_(it) {
  const star = Number(it.starforce || 0);
  const starMax = 30;
  const stars = renderStars_(star, starMax);

  const scrollUsed = Number(it.scroll_upgrade || 0) || 0;
  const title = escapeHtml(`${it.item_name || ""}${scrollUsed ? ` (+${scrollUsed})` : ""}`);

  const icon = it.item_icon || "";
  const part = it.item_equipment_part || it.item_equipment_slot || "";
  // ===== 數值（配色：基本(白) + 星力(黃) + 卷軸(藍) + 星火(綠)）=====
  const total = it.item_total_option || {};
  const baseOpt = it.item_base_option || {};
  const starOpt = it.item_starforce_option || {};
  const scrollOpt = it.item_etc_option || {};
  const flameOpt = it.item_add_option || {};
  const excOpt = it.item_exceptional_option || {};

  const num = (v) => {
    if (v === "" || v === null || v === undefined) return 0;
    const s = String(v).replace(/,/g, "").trim();
    if (!s) return 0;
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const isPctKey = (k) => ["all_stat","boss_damage","ignore_monster_armor","damage","max_hp_rate","max_mp_rate"].includes(k);

  const fmtPart = (v, cls, pct) => {
    const n = num(v);
    if (!n) return "";
    const txt = (Math.round(n * 100) / 100).toString() + (pct ? "%" : "");
    return `<span class="${cls}">${txt}</span>`;
  };

  const fmtTotal = (v, pct) => {
    const n = num(v);
    if (!n) return "";
    return "+" + (Math.round(n * 100) / 100).toString() + (pct ? "%" : "");
  };

  const buildLine = (label, key) => {
    const pct = isPctKey(key);
    const t = fmtTotal(total[key], pct);
    if (!t) return "";

    // 基本 = base + exceptional（白）
    const baseN = num(baseOpt[key]) + num(excOpt[key]);
    const parts = [];

    if (baseN) parts.push(fmtPart(baseN, "c-base", pct));
    const starP = fmtPart(starOpt[key], "c-star", pct);
    const scrollP = fmtPart(scrollOpt[key], "c-scroll", pct);
    const flameP = fmtPart(flameOpt[key], "c-flame", pct);

    if (starP) parts.push(starP);
    if (scrollP) parts.push(scrollP);
    if (flameP) parts.push(flameP);

    // 若剛好 baseN=0，但其他有值，仍顯示其他（不硬塞 0）
    const sumParts = parts.length ? ` <span class="muted">(${parts.join(" + ")})</span>` : "";

    return `${escapeHtml(label)}: ${t}${sumParts}`;
  };

  const lines = [];
  const keys = [
    ["種類", null],
    ["STR", "str"],
    ["DEX", "dex"],
    ["INT", "int"],
    ["LUK", "luk"],
    ["最大HP", "max_hp"],
    ["最大MP", "max_mp"],
    ["攻擊力", "attack_power"],
    ["魔法攻擊力", "magic_power"],
    ["防禦力", "armor"],
    ["全屬性", "all_stat"],
    ["BOSS怪物傷害", "boss_damage"],
    ["無視怪物防禦率", "ignore_monster_armor"],
  ];

  // 種類
  if (it.item_equipment_part || it.item_equipment_slot) {
    const partTxt = (it.item_equipment_part || it.item_equipment_slot || "").toString();
    lines.push(`種類：${escapeHtml(partTxt)}`);
  }

  for (const [label, key] of keys) {
    if (!key) continue;
    const l = buildLine(label, key);
    if (l) lines.push(l);
  }

  const statBlock = lines.length
    ? `<div class="ms-lines">${lines.map((x) => `<div class="ms-line">${x}</div>`).join("")}</div>`
    : "";


  // 潛能
  const pot = renderPotentialBlock_(it.potential_option_grade, [it.potential_option_1, it.potential_option_2, it.potential_option_3], false);
  const addPot = renderPotentialBlock_(it.additional_potential_option_grade, [it.additional_potential_option_1, it.additional_potential_option_2, it.additional_potential_option_3], true);

  // 靈魂 / 其他簡單資訊
  const soulLines = [];
  if (it.soul_name) soulLines.push(`靈魂：${escapeHtml(it.soul_name)}`);
  if (it.soul_option) soulLines.push(`${escapeHtml(it.soul_option)}`);

  return `
  <div class="ms-tip">
    <div class="ms-stars">${stars}</div>
    <div class="ms-title">${title}</div>

    <div class="ms-top">
      <div class="ms-iconframe">${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}</div>
      <div class="ms-lines">
        ${lines.map((s)=>`<div>${s}</div>`).join("")}
      </div>
    </div>

    ${soulLines.length ? `<div class="ms-divider"></div><div class="ms-lines">${soulLines.map((s)=>`<div>${s}</div>`).join("")}</div>` : ""}

    ${(pot || addPot) ? `<div class="ms-divider"></div>` : ""}

    ${pot || ""}
    ${addPot || ""}
  </div>`;
}

function buildCashModalHtml_(it) {
  const title = escapeHtml(it.cash_item_name || "");
  const icon = it.cash_item_icon || "";
  const part = it.cash_item_equipment_part || it.cash_item_equipment_slot || "";

  const lines = [];
  if (part) lines.push(`<div class="muted">種類：${escapeHtml(part)}</div>`);

  const opts = Array.isArray(it.cash_item_option) ? it.cash_item_option : [];
  for (const o of opts) {
    const t = o.option_type || "";
    const v = o.option_value || "";
    if (!t && !v) continue;
    lines.push(`${escapeHtml(String(t))}: ${escapeHtml(String(v))}`);
  }
  if (it.date_expire) lines.push(`<div class="muted">到期：${escapeHtml(it.date_expire)}</div>`);
  if (it.date_option_expire) lines.push(`<div class="muted">選項到期：${escapeHtml(it.date_option_expire)}</div>`);

  return `
  <div class="ms-tip">
    <div class="ms-stars">${renderStars_(0, 0)}</div>
    <div class="ms-title">${title}</div>

    <div class="ms-top">
      <div class="ms-iconframe">${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}</div>
      <div class="ms-lines">
        ${lines.map((s)=>`<div>${s}</div>`).join("")}
      </div>
    </div>
  </div>`;
}

function setupModalOnce() {
  if (window.__modalInited) return;
  window.__modalInited = true;
  const modal = document.getElementById("modal");
  if (!modal) return;

  modal.addEventListener("click", (e) => {
    if (e.target && e.target.classList.contains("modal")) closeItemModal();
    if (e.target && e.target.getAttribute("data-close") === "1") closeItemModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeItemModal();
  });
}

function initItemModalOnce() {
  if (window.__itemModalInited) return;
  window.__itemModalInited = true;

  // 點背景關閉、ESC 關閉
  const modal = document.getElementById("modal");
  modal.addEventListener("click", (e) => {
    if (e.target === modal) closeItemModal();
  });
  modal.querySelector(".modal-x").addEventListener("click", (e) => {
    e.preventDefault();
    closeItemModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeItemModal();
  });

  // 點裝備 / 時裝就開啟 tooltip
  document.addEventListener("click", (e) => {
    const el = e.target.closest(".equip");
    if (!el) return;
    const type = el.dataset.type;
    const idx = el.dataset.idx;
    if (!type) return;
    e.preventDefault();
    e.stopPropagation();
    openItemModal(type, idx, el);
  });
}

function isZeroLike(v) {
  const s = String(v ?? "").trim();
  if (!s) return true;
  return s === "0" || s === "0.0" || s === "0.00" || s === "0%" || s === "0.000" || s === "0.0000";
}
function formatObjLines(obj, label, keyOrder = null) {
  if (!obj || typeof obj !== "object") return [];
  const lines = [];
  lines.push(label + "：");
  const keys = Array.isArray(keyOrder) ? keyOrder : Object.keys(obj);
  for (const k of keys) {
    const v = obj[k];
    if (v === undefined || v === null) continue;
    if (isZeroLike(v)) continue;
    lines.push(`- ${k}: ${v}`);
  }
  if (lines.length === 1) lines.push("- （無）");
  return lines;
}

/** ===== Render ===== */
function renderProfile(basic, date, popularity, metrics) {
  const expRate = basic.character_exp_rate ? formatPercent(basic.character_exp_rate) : "";
  const expText = basic.character_exp ? String(basic.character_exp) : "";
  const cls = basic.character_class || "";
  const world = basic.world_name || "";
  const level = basic.character_level ?? "";
  const guild = basic.character_guild_name || "";

  const img = basic.character_image || "";
  const chips = [
    world ? `伺服器：${world}` : "",
    cls ? `職業：${cls}` : "",
    level !== "" ? `Lv.${level}` : "",
    guild ? `公會：${guild}` : "",
    popularity !== "" ? `人氣：${popularity}` : "",
    date ? `日期：${date}` : "",
  ].filter(Boolean);

  return `
    <div class="card big">
      <div class="profile">
        ${img ? `<img class="avatar" src="${esc(img)}" />` : `<div class="avatar"></div>`}
        <div>
          <p class="pname">${esc(basic.character_name || "")}</p>
          <div class="pmeta">
            EXP：${esc(expText)} ${expRate ? `（${esc(expRate)}）` : ""}
          </div>
          <div class="chips">${chips.map(c=>`<span class="chip">${esc(c)}</span>`).join("")}</div>
        </div>
      </div>

      <div class="grid">
        ${renderMetric("戰鬥力", formatZhUnit(metrics.combat_power))}
        ${renderMetric("BOSS傷", metrics.boss_damage ? formatPercent(metrics.boss_damage) : "")}
        ${renderMetric("無視", metrics.ignore_def ? formatPercent(metrics.ignore_def) : "")}
        ${renderMetric("爆傷", metrics.crit_damage ? formatPercent(metrics.crit_damage) : "")}
        ${renderMetric("爆率", metrics.crit_rate ? formatPercent(metrics.crit_rate) : "")}
        ${renderMetric("最終傷", metrics.final_damage ? formatPercent(metrics.final_damage) : "")}
        ${renderMetric("傷害", metrics.damage ? formatPercent(metrics.damage) : "")}
        ${renderMetric("攻擊力", metrics.attack_power || "")}
      </div>
    </div>
  `;
}
function renderMetric(name, val) {
  return `
    <div class="metric">
      <div class="mname">${esc(name)}</div>
      <div class="mval">${esc(val || "-")}</div>
    </div>
  `;
}


function renderInventorySkeleton_(){
  return `
    <section class="section">
      <h2>裝備 / 裝飾</h2>
      <div class="invWrap">
        <div id="invHost"></div>
      </div>
    </section>
  `;
}

function initInventoryUI_(basic, itemEquipment, cashitemEquipment){
  const host = document.getElementById("invHost");
  if(!host) return;

  window.__invData = {
    basic: basic || {},
    itemEquipment: itemEquipment || null,
    cashitemEquipment: cashitemEquipment || null,
  };

  if(!window.__invState){
    window.__invState = { tab: "equip", equipPreset: "equipped", cashPreset: "base" };
  }

  // 若 API 有提供 preset_no，第一次渲染時用它當預設（但不改使用者後續手動選擇）
  try{
    const ie = itemEquipment || {};
    const n = Number(ie.preset_no || 0);
    if(!window.__invState.__initFromServer && n>=1 && n<=3){
      window.__invState.equipPreset = "preset_" + n;
      window.__invState.__initFromServer = true;
    }
  }catch(e){}

  host.innerHTML = renderInventoryWindow_(window.__invState);

  host.onclick = (ev)=>{
    const el = ev.target.closest("[data-action]");
    if(!el) return;

    const act = el.dataset.action;
    if(act === "invTab"){
      window.__invState.tab = el.dataset.tab;
      host.innerHTML = renderInventoryWindow_(window.__invState);
      return;
    }
    if(act === "invPreset"){
      const tab = window.__invState.tab;
      const v = el.dataset.preset;
      if(tab === "equip") window.__invState.equipPreset = v;
      else window.__invState.cashPreset = v;
      host.innerHTML = renderInventoryWindow_(window.__invState);
      return;
    }
    if(act === "invClose"){
      host.innerHTML = "";
      return;
    }
    if(act === "openItem"){
      const kind = el.dataset.kind;
      const idx = Number(el.dataset.idx);
      openItemModal(kind, idx, el);
      return;
    }
  };
}

function renderInventoryWindow_(state){
  const data = window.__invData || {};
  const basic = data.basic || {};
  const tab = (state && state.tab) || "equip";

  const equip = data.itemEquipment || null;
  const cash = data.cashitemEquipment || null;

  const kind = (tab === "cash") ? "cash" : "equip";
  const preset = (tab === "cash") ? (state.cashPreset || "base") : (state.equipPreset || "equipped");

  const items = (kind === "equip")
    ? pickEquipItems_(equip, preset)
    : pickCashItems_(cash, preset);

  if(kind === "equip") window.__equipItems = items;
  else window.__cashItems = items;

  const slotMap = buildSlotMap_(items, kind);
  const usedIdx = new Set(Object.values(slotMap).filter(v => typeof v === "number"));
  const extras = [];
  for(let i=0;i<items.length;i++){
    if(!usedIdx.has(i)) extras.push(i);
  }

  const leftKeys = [
    "ring1","ring2",
    "ring3","ring4",
    "pendant1","pendant2",
    "pocket","badge",
    "belt","medal",
    "totem1","totem2",
  ];
  const rightKeys = [
    "hat","face",
    "eye","ear",
    "shoulder","cape",
    "top","bottom",
    "glove","shoe",
    "weapon","secondary",
    "emblem","heart",
  ];

  const leftHtml = leftKeys.map(k => renderInvSlot_(k, slotMap, items, kind)).join("");
  const rightHtml = rightKeys.map(k => renderInvSlot_(k, slotMap, items, kind)).join("");

  const tabEquipClass = (tab === "equip") ? "" : "inactive";
  const tabCashClass = (tab === "cash") ? "" : "inactive";

  const presetBtns = (kind === "equip")
    ? [
        ["裝", "equipped"],
        ["1", "preset_1"],
        ["2", "preset_2"],
        ["3", "preset_3"],
      ]
    : [
        ["B", "base"],
        ["1", "preset_1"],
        ["2", "preset_2"],
        ["3", "preset_3"],
      ];

  const presetHtml = presetBtns.map(([label, val])=>{
    const active = (val === preset) ? "active" : "";
    return `<button class="invPresetBtn ${active}" data-action="invPreset" data-preset="${val}">${label}</button>`;
  }).join("");

  const charImg = basic.character_image || "";
  const charName = escapeHtml(basic.character_name || "");
  const extrasHtml = extras.length ? `
    <div class="invExtras">
      <div class="invExtrasTitle">其他（未對應到固定槽位的裝備）</div>
      ${extras.map(i => renderInvSlotExtra_(i, items, kind)).join("")}
    </div>
  ` : "";

  return `
    <div class="invFrame">
      <div class="invTop">
        <div>EQUIPMENT INVENTORY</div>
        <button class="closeBtn" data-action="invClose" title="關閉">✕</button>
      </div>

      <div class="invTabs">
        <button class="invTab ${tabEquipClass}" data-action="invTab" data-tab="equip">裝備</button>
        <button class="invTab ${tabCashClass}" data-action="invTab" data-tab="cash">裝飾</button>
      </div>

      <div class="invBody">
        <div class="invInner">
          <div class="invGrid">${leftHtml}</div>

          <div class="invCenter">
            <div class="invPreview">
              <div class="bgGlow"></div>
              ${charImg ? `<img src="${escapeHtml(charImg)}" alt="">` : `<div style="opacity:.7">No Image</div>`}
            </div>
            <div class="invCharName">${charName}</div>
          </div>

          <div class="invGrid">${rightHtml}</div>
        </div>
      </div>

      <div class="invFooter">
        <div class="invPresets">
          <div class="invPresetLabel">PRESETS</div>
          ${presetHtml}
        </div>
        <div style="opacity:.7; font-weight:800; font-size:12px;">
          ${kind === "equip" ? "裝備" : "裝飾"}：${presetLabel_(kind, preset)}
        </div>
      </div>

      ${extrasHtml}
    </div>
  `;
}

function presetLabel_(kind, preset){
  if(kind === "cash"){
    if(preset === "base") return "base";
  }else{
    if(preset === "equipped") return "equipped";
  }
  return preset.replace("preset_","") || preset;
}

function pickEquipItems_(itemEquipment, preset){
  if(!itemEquipment) return [];
  switch(preset){
    case "preset_1": return itemEquipment.item_equipment_preset_1 || [];
    case "preset_2": return itemEquipment.item_equipment_preset_2 || [];
    case "preset_3": return itemEquipment.item_equipment_preset_3 || [];
    case "equipped":
    default: return itemEquipment.item_equipment || [];
  }
}

function pickCashItems_(cash, preset){
  if(!cash) return [];
  const base = (cash.cash_item_equipment_base || []).concat(cash.additional_cash_item_equipment_base || []);
  const p1 = (cash.cash_item_equipment_preset_1 || []).concat(cash.additional_cash_item_equipment_preset_1 || []);
  const p2 = (cash.cash_item_equipment_preset_2 || []).concat(cash.additional_cash_item_equipment_preset_2 || []);
  const p3 = (cash.cash_item_equipment_preset_3 || []).concat(cash.additional_cash_item_equipment_preset_3 || []);
  switch(preset){
    case "preset_1": return p1;
    case "preset_2": return p2;
    case "preset_3": return p3;
    case "base":
    default: return base;
  }
}

function buildSlotMap_(items, kind){
  const map = {};
  if(!Array.isArray(items)) return map;

  // 圖騰可能會有多個，允許分配到 totem1/2/3
  let totemCounter = 1;

  for(let i=0;i<items.length;i++){
    const it = items[i] || {};
    let key = (kind === "cash") ? normCashSlotKey_(it) : normEquipSlotKey_(it);

    if(key === "totem"){
      key = "totem" + (totemCounter++);
    }
    if(!key) continue;

    if(map[key] === undefined){
      map[key] = i;
    }
  }
  return map;
}

function normEquipSlotKey_(it){
  const s = String(it.item_equipment_slot || "").trim();
  const p = String(it.item_equipment_part || "").trim();

  const has = (x)=> s === x || s.includes(x);
  if(has("戒指1")) return "ring1";
  if(has("戒指2")) return "ring2";
  if(has("戒指3")) return "ring3";
  if(has("戒指4")) return "ring4";
  if(s === "墜飾") return "pendant1";
  if(s === "墜飾2") return "pendant2";
  if(has("口袋道具")) return "pocket";
  if(has("徽章")) return "badge";
  if(has("腰帶")) return "belt";
  if(has("勳章")) return "medal";
  if(has("圖騰")) return "totem";

  if(has("帽子")) return "hat";
  if(has("臉飾")) return "face";
  if(has("眼飾")) return "eye";
  if(has("耳環")) return "ear";
  if(has("肩膀")) return "shoulder";
  if(has("披風")) return "cape";
  if(has("上衣")) return "top";
  if(has("下衣")) return "bottom";
  if(p.includes("套服")) return "top";
  if(has("手套")) return "glove";
  if(has("鞋子")) return "shoe";
  if(has("武器") && !has("輔助")) return "weapon";
  if(has("輔助武器")) return "secondary";
  if(has("胸章")) return "emblem";
  if(has("機器心臟")) return "heart";

  // fallback：用 part 猜
  if(p.includes("帽")) return "hat";
  if(p.includes("臉")) return "face";
  if(p.includes("眼")) return "eye";
  if(p.includes("耳")) return "ear";
  if(p.includes("披風")) return "cape";
  if(p.includes("手套")) return "glove";
  if(p.includes("鞋")) return "shoe";
  return "";
}

function normCashSlotKey_(it){
  const s = String(it.cash_item_equipment_slot || "").trim();
  const p = String(it.cash_item_equipment_part || "").trim();

  const has = (x)=> s === x || s.includes(x);
  if(has("戒指1")) return "ring1";
  if(has("戒指2")) return "ring2";
  if(has("戒指3")) return "ring3";
  if(has("戒指4")) return "ring4";
  if(s === "墜飾") return "pendant1";
  if(s === "墜飾2") return "pendant2";
  if(has("口袋道具")) return "pocket";
  if(has("徽章")) return "badge";
  if(has("腰帶")) return "belt";
  if(has("勳章")) return "medal";
  if(has("圖騰")) return "totem";

  if(has("帽子")) return "hat";
  if(has("臉飾")) return "face";
  if(has("眼飾")) return "eye";
  if(has("耳環")) return "ear";
  if(has("肩膀")) return "shoulder";
  if(has("披風")) return "cape";
  if(has("上衣")) return "top";
  if(has("下衣")) return "bottom";
  if(p.includes("套服")) return "top";
  if(has("手套")) return "glove";
  if(has("鞋子")) return "shoe";
  if(has("武器") && !has("輔助")) return "weapon";
  if(has("輔助武器")) return "secondary";
  if(has("胸章")) return "emblem";
  if(has("機器心臟")) return "heart";

  return "";
}

function renderInvSlot_(slotKey, slotMap, items, kind){
  const idx = slotMap[slotKey];
  if(idx === undefined){
    return `<div class="invSlot empty" data-slot="${slotKey}"></div>`;
  }
  const it = items[idx] || {};
  const icon = (kind === "cash") ? (it.cash_item_icon || "") : (it.item_icon || "");
  const name = (kind === "cash") ? (it.cash_item_name || "") : (it.item_name || "");
  const star = (kind === "equip") ? Number(it.starforce || 0) : 0;

  const badge = (kind === "equip" && star>0)
    ? `<div class="invStarBadge"><span class="s">★</span>${star}</div>`
    : "";

  return `
    <button class="invSlot filled"
      data-action="openItem"
      data-kind="${kind}"
      data-idx="${idx}"
      title="${escapeHtml(name)}">
      ${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}
      ${badge}
    </button>
  `;
}

function renderInvSlotExtra_(idx, items, kind){
  const it = items[idx] || {};
  const icon = (kind === "cash") ? (it.cash_item_icon || "") : (it.item_icon || "");
  const name = (kind === "cash") ? (it.cash_item_name || "") : (it.item_name || "");
  const star = (kind === "equip") ? Number(it.starforce || 0) : 0;

  const badge = (kind === "equip" && star>0)
    ? `<div class="invStarBadge"><span class="s">★</span>${star}</div>`
    : "";

  return `
    <button class="invSlot filled"
      data-action="openItem"
      data-kind="${kind}"
      data-idx="${idx}"
      title="${escapeHtml(name)}">
      ${icon ? `<img src="${escapeHtml(icon)}" alt="">` : ""}
      ${badge}
    </button>
  `;
}


function renderLeaderboard() {
  // 先渲染外殼，實際資料用 Google gviz JSONP 非同步載入（避開 CORS，GitHub Pages 可用）
  return `
    <div class="card full">
      <div class="title">排行榜（全網共用）</div>
      <div class="tabs">
        <button class="tab active" id="tabExp" onclick="switchTab('exp')">EXP Top</button>
        <button class="tab" id="tabCombat" onclick="switchTab('combat')">戰鬥力 Top</button>
        <span class="small">（資料來源：共用 Google Sheet）</span>
      </div>
      <div id="lbStatus" class="small" style="margin-top:8px;color:var(--muted)">載入中…</div>
      <div id="lbExp" style="margin-top:10px;"></div>
      <div id="lbCombat" style="margin-top:10px; display:none;"></div>
    </div>
  `;
}

async function ensureLeaderboardLoaded_() {
  const hostExp = document.getElementById("lbExp");
  const hostCombat = document.getElementById("lbCombat");
  const st = document.getElementById("lbStatus");
  if (!hostExp || !hostCombat) return;

  if (__lbLoading) return;
  __lbLoading = true;

  try {
    if (st) st.textContent = "載入中…";
    const rows = await getSharedLeaderboardRows_();
    const expTop = sortTop_(rows, "exp");
    const combatTop = sortTop_(rows, "combat_power");

    hostExp.innerHTML = renderLbTable_(expTop, "exp");
    hostCombat.innerHTML = renderLbTable_(combatTop, "combat");

    if (st) {
      const ts = __lbCache.at ? new Date(__lbCache.at) : new Date();
      st.textContent = `已載入 ${rows.length} 筆（快取 ${Math.round(LB_CACHE_MS/1000)} 秒｜${ts.toLocaleString("zh-TW", { timeZone: TZ })}）`;
    }
  } catch (err) {
    const msg = String(err && err.message ? err.message : err);
    if (st) st.textContent = `載入失敗：${msg}`;
    hostExp.innerHTML = `<div class="muted">（無法載入排行榜）</div>`;
    hostCombat.innerHTML = hostExp.innerHTML;
  } finally {
    __lbLoading = false;
  }
}

function switchTab(which) {
  const a = $("tabExp"), b = $("tabCombat");
  const exp = $("lbExp"), combat = $("lbCombat");
  if (which === "exp") {
    a.classList.add("active"); b.classList.remove("active");
    exp.style.display = "block"; combat.style.display = "none";
  } else {
    b.classList.add("active"); a.classList.remove("active");
    combat.style.display = "block"; exp.style.display = "none";
  }
}

/** ===== 主流程 ===== */
async function run() {
  const name = $("name").value.trim();
  if (!name) {
    $("status").innerHTML = `<span class="err">請輸入角色暱稱</span>`;
    return;
  }

  $("btn").disabled = true;
  $("status").textContent = "查詢中…";
  $("out").innerHTML = "";

  const date = getYesterdayYmdTz();
  const url = `${WORKER_BASE.replace(/\/+$/,"")}/character?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&parts=${encodeURIComponent(DEFAULT_PARTS)}`;

  try {
    const t0 = performance.now();
    const resp = await fetch(url, { method:"GET", cache:"no-store" });
    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); } catch(e) {
      throw new Error(`Worker 回傳不是 JSON：${text.slice(0,200)}`);
    }
    if (!json.ok) {
      const msg = json?.body?.error?.message || `HTTP ${json.status || resp.status}`;
      throw new Error(msg);
    }

    const data = json.data || {};
    const basic = data.basic || {};
    const popularity = data.popularity?.popularity ?? "";
    const statMap = statArrayToMap(data.stat?.final_stat);
    const metrics = extractMetrics(statMap);

    const t1 = performance.now();
    $("status").textContent = `完成（耗時 ${(t1-t0)/1000.0 >= 1 ? ((t1-t0)/1000).toFixed(2)+'s' : Math.round(t1-t0)+'ms'}）`;

    $("out").innerHTML =
      renderProfile(basic, date, popularity, metrics) +
      renderAbility(data.ability) +
      renderInventorySkeleton_() +
      renderLeaderboard();

    initInventoryUI_(basic, data.itemEquipment, data.cashitemEquipment);

    ensureLeaderboardLoaded_();

  } catch (err) {
    $("status").innerHTML = `<span class="err">查詢失敗：${esc(err?.message || String(err))}</span>`;
    $("out").innerHTML = renderLeaderboard();
    ensureLeaderboardLoaded_();
  } finally {
    $("btn").disabled = false;
  }
}

// Enter 送出
document.addEventListener("keydown", (e)=> {
  if (e.key === "Enter" && document.activeElement === $("name")) run();
});

// 預填（方便你測）
if (!$("name").value) $("name").value = "Ezra絕";

// v10：立刻掛上裝備詳細視窗（X / 點黑幕 / ESC）事件
initItemModalOnce();




function renderAbility(data){
  const a = data && data.ability;
  if(!a) return "";
  let lines = Array.isArray(a.ability_info) ? a.ability_info : [];
  if(!lines.length){
    const pn = a.preset_no || a.use_preset_no || 1;
    const preset = a["ability_preset_"+pn];
    if(preset && Array.isArray(preset.ability_info)) lines = preset.ability_info;
  }
  const gradeToClass = (grade)=>{
    const g = String(grade||"");
    if(g.includes("傳說")) return "green";
    if(g.includes("罕見")) return "orange";
    if(g.includes("特殊級") || g.includes("特殊") || g.includes("史詩")) return "cyan";
    if(g.includes("稀有")) return "purple";
    return "gray";
  };
  const htmlLines = lines.map(li=>{
    const g = li && (li.ability_grade || a.ability_grade) || "";
    const v = li && li.ability_value || "";
    return `<div class="ms-buff ${gradeToClass(g)}">${escapeHtml(v)}</div>`;
  }).join("");

  const right = a.preset_no ? `<span class="small">Preset ${escapeHtml(String(a.preset_no))}</span>` : (a.ability_grade ? `<span class="small">${escapeHtml(String(a.ability_grade))}</span>` : "");
  return `
    <section class="section">
      <div class="section-title"><span>👁️ 內潛</span>${right}</div>
      <div class="abilityWrap">${htmlLines || `<div class="small">無資料</div>`}</div>
    </section>
  `;
}

</script>
</body>
</html>
