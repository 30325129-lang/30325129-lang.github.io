<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maple 角色查詢（Web）</title>
  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Arial; margin:0; background:#fafafa; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .title { font-size: 20px; font-weight: 900; }
    .muted { color:#666; font-size:12px; }
    .row { display:flex; gap:10px; margin-top:12px; }
    input { flex:1; padding:12px; border:1px solid #ddd; border-radius:12px; font-size:14px; }
    button { padding:12px 14px; border:1px solid #111; background:#111; color:#fff; border-radius:12px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .err { color:#c62828; white-space:pre-wrap; margin-top:10px; }
    .card { background:#fff; border:1px solid #e9e9e9; border-radius:16px; padding:14px; margin:14px 0; }
    .head { display:flex; gap:14px; align-items:center; }
    .avatar { width:84px; height:84px; border-radius:18px; object-fit:cover; background:#eee; }
    .name { font-size:22px; font-weight:1000; }
    .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px; }
    .kv { border:1px solid #eee; border-radius:14px; padding:10px; }
    .k { color:#666; font-size:12px; }
    .v { font-weight:900; font-size:16px; margin-top:4px; word-break: break-all; }
    .equip-grid { display:grid; grid-template-columns: repeat(10, 1fr); gap:8px; }
    .equip { border:1px solid #eee; border-radius:14px; padding:8px; text-align:center; background:#fff; }
    .equip img { width:44px; height:44px; object-fit:contain; display:block; margin:0 auto 6px; }
    .equip .ename { font-size:11px; line-height:1.2; height: 30px; overflow:hidden; }
    .tabs { display:flex; gap:10px; margin-top:10px; }
    .tab { padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:12px; cursor:pointer; }
    .tab.active { border-color:#111; font-weight:900; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:13px; }
    .pill { display:inline-block; padding:4px 8px; border:1px solid #eee; border-radius:999px; font-size:12px; color:#333; margin-right:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Maple 角色查詢（Web）</div>
    <div class="muted">
      只輸入暱稱；日期自動查詢昨天（台北時間）；8大數值一個不漏；裝備/時裝圖片顯示。
    </div>

    <div class="row">
      <input id="name" placeholder="輸入角色暱稱，例如：Ezra絕" />
      <button id="btn" onclick="run()">查詢</button>
    </div>

    <div id="status" class="muted" style="margin-top:10px;"></div>
    <div id="error" class="err"></div>

    <div id="result"></div>
  </div>

<script>
/** ===== 你要打的 Worker ===== */
const WORKER_BASE = "https://maple-proxy.ezraop.workers.dev";
const PARTS = "basic,popularity,stat,itemEquipment,cashitemEquipment,symbolEquipment";

/** ===== 工具 ===== */
const $ = (id) => document.getElementById(id);
function esc(s) {
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/** 台北時間昨天 yyyy-MM-dd（不管你電腦時區） */
function getTaipeiYesterdayYmd() {
  const now = Date.now();
  const taipeiNow = new Date(now + 8 * 3600 * 1000);
  const y = new Date(taipeiNow.getTime() - 24 * 3600 * 1000);
  const yyyy = y.getUTCFullYear();
  const mm = String(y.getUTCMonth() + 1).padStart(2, "0");
  const dd = String(y.getUTCDate()).padStart(2, "0");
  return `${yyyy}-${mm}-${dd}`;
}

function setStatus(msg){ $("status").textContent = msg || ""; }
function setError(msg){ $("error").textContent = msg || ""; }

/** 把 final_stat 轉 map */
function finalStatToMap(stat) {
  const m = {};
  const arr = stat?.final_stat;
  if (!Array.isArray(arr)) return m;
  for (const s of arr) {
    if (s?.stat_name) m[s.stat_name] = s.stat_value;
  }
  return m;
}

/** 8 大欄位（缺一不可） */
function extractMetrics(statMap) {
  const pick = (keys) => {
    for (const k of keys) {
      const v = statMap[k];
      if (v !== undefined && v !== null && v !== "") return v;
    }
    return "";
  };
  const boss = pick(["BOSS怪物傷害","Boss怪物傷害","boss怪物傷害"]);
  return {
    combat_power: pick(["戰鬥力"]),
    boss_damage: boss,
    ignore_def: pick(["無視防禦率"]),
    crit_damage: pick(["爆擊傷害"]),
    crit_rate: pick(["爆擊機率"]),
    final_damage: pick(["最終傷害"]),
    damage: pick(["傷害"]),
    attack_power: pick(["攻擊力"]),
  };
}

/** ===== local leaderboard：記錄「你查過的人」 ===== */
const LS_KEY = "maple_char_cache_v1";
function loadCache() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch { return []; }
}
function saveCache(list) {
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}
function upsertCache(entry) {
  const list = loadCache();
  const key = `${entry.character_name}@@${entry.world_name}`;
  const i = list.findIndex(x => `${x.character_name}@@${x.world_name}` === key);
  if (i >= 0) list[i] = entry; else list.push(entry);
  saveCache(list);
  return list;
}
function toBigIntSafe(v) {
  try {
    if (v === "" || v === null || v === undefined) return 0n;
    let s = String(v).trim();
    if (!s) return 0n;
    s = s.split(".")[0].replace(/[^\d-]/g,"");
    if (!s || s === "-") return 0n;
    return BigInt(s);
  } catch { return 0n; }
}
function buildLeaderboard(list) {
  const expTop = list.slice().sort((a,b)=>{
    const A = toBigIntSafe(a.exp), B = toBigIntSafe(b.exp);
    return A===B ? 0 : (A < B ? 1 : -1);
  }).slice(0,50);

  const combatTop = list.slice().sort((a,b)=>{
    const A = toBigIntSafe(a.combat_power), B = toBigIntSafe(b.combat_power);
    return A===B ? 0 : (A < B ? 1 : -1);
  }).slice(0,50);

  return { expTop, combatTop };
}

/** ===== 主流程 ===== */
async function run() {
  const name = $("name").value.trim();
  if (!name) { setError("請輸入角色暱稱"); return; }

  setError("");
  setStatus("查詢中…（若 10~20 秒內沒回來，通常是 CORS 或 Worker/網路問題）");
  $("btn").disabled = true;

  const date = getTaipeiYesterdayYmd();
  const url = `${WORKER_BASE.replace(/\/+$/,"")}/character?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&parts=${encodeURIComponent(PARTS)}`;

  // 超時保護
  const ctrl = new AbortController();
  const timer = setTimeout(()=>ctrl.abort(), 25000);

  try {
    const resp = await fetch(url, { method:"GET", signal: ctrl.signal });
    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); }
    catch { throw new Error(`Worker 回傳不是 JSON（HTTP ${resp.status}）：${text.slice(0,300)}`); }

    if (!json.ok) {
      const msg = json?.body?.error?.message || `HTTP ${json.status || resp.status}`;
      throw new Error(`查詢失敗：${msg}`);
    }

    const data = json.data || {};
    const basic = data.basic || {};
    const statMap = finalStatToMap(data.stat);
    const metrics = extractMetrics(statMap);
    const popularity = data.popularity?.popularity ?? "";

    // 更新 local cache（做排行榜）
    const fetched_at = new Date().toISOString();
    const cacheList = upsertCache({
      character_name: basic.character_name || name,
      world_name: basic.world_name || "",
      level: basic.character_level || "",
      exp: basic.character_exp || "",
      combat_power: metrics.combat_power || "",
      fetched_at,
      date,
    });
    const leaderboard = buildLeaderboard(cacheList);

    render({
      date,
      basic,
      popularity,
      metrics,
      itemEquipment: data.itemEquipment || null,
      cashitemEquipment: data.cashitemEquipment || null,
      leaderboard,
    });

    setStatus("完成 ✅");
  } catch (e) {
    const msg = (e && e.name === "AbortError")
      ? "查詢逾時（25 秒）。可能 Worker 太慢 / 網路 / 或 CORS 被擋。"
      : (e?.message || String(e));
    setStatus("");
    setError(msg + "\n\n（建議：按 F12 → Console 看是否有 CORS error）");
  } finally {
    clearTimeout(timer);
    $("btn").disabled = false;
  }
}

function render(payload) {
  const b = payload.basic || {};
  const m = payload.metrics || {};
  const img = b.character_image || "";

  const summary = `
    <div class="card">
      <div class="head">
        ${img ? `<img class="avatar" src="${esc(img)}" />` : `<div class="avatar"></div>`}
        <div>
          <div class="name">${esc(b.character_name || "")}</div>
          <div class="muted">${esc(b.world_name || "")}｜${esc(b.character_class || "")}｜Lv.${esc(b.character_level || "")}</div>
          <div class="muted">
            <span class="pill">日期：${esc(payload.date)}</span>
            <span class="pill">人氣：${esc(payload.popularity)}</span>
          </div>
          <div class="muted">EXP：${esc(b.character_exp || "")}（${esc(b.character_exp_rate || "")}%）</div>
        </div>
      </div>

      <div class="grid">
        <div class="kv"><div class="k">戰鬥力</div><div class="v">${esc(m.combat_power)}</div></div>
        <div class="kv"><div class="k">BOSS傷</div><div class="v">${esc(m.boss_damage)}</div></div>
        <div class="kv"><div class="k">無視</div><div class="v">${esc(m.ignore_def)}</div></div>
        <div class="kv"><div class="k">爆傷</div><div class="v">${esc(m.crit_damage)}</div></div>
        <div class="kv"><div class="k">爆率</div><div class="v">${esc(m.crit_rate)}</div></div>
        <div class="kv"><div class="k">最終傷</div><div class="v">${esc(m.final_damage)}</div></div>
        <div class="kv"><div class="k">傷害</div><div class="v">${esc(m.damage)}</div></div>
        <div class="kv"><div class="k">攻擊力</div><div class="v">${esc(m.attack_power)}</div></div>
      </div>
    </div>
  `;

  const equip = renderEquip(payload.itemEquipment);
  const cash = renderCash(payload.cashitemEquipment);
  const lb = renderLeaderboard(payload.leaderboard);

  $("result").innerHTML = summary + equip + cash + lb;
}

function renderEquip(e) {
  const items = e?.item_equipment;
  const arr = Array.isArray(items) ? items : [];
  const cells = arr.map(it => {
    const icon = it.item_icon || it.item_shape_icon || "";
    const name = it.item_name || "";
    const star = it.starforce ? `★${it.starforce}` : "";
    return `
      <div class="equip" title="${esc(name)}\n${esc(star)}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
        <div class="muted">${esc(star)}</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card">
      <div class="title" style="font-size:16px;">裝備（equipped）</div>
      <div class="muted" style="margin:6px 0 10px;">顯示裝備圖示（item_icon）。</div>
      <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
    </div>
  `;
}

function renderCash(c) {
  const items = c?.cash_item_equipment_base;
  const arr = Array.isArray(items) ? items : [];
  const cells = arr.map(it => {
    const icon = it.cash_item_icon || "";
    const name = it.cash_item_name || "";
    return `
      <div class="equip" title="${esc(name)}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card">
      <div class="title" style="font-size:16px;">時裝（base）</div>
      <div class="muted" style="margin:6px 0 10px;">顯示時裝圖示（cash_item_icon）。</div>
      <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
    </div>
  `;
}

function renderLeaderboard(lb) {
  const exp = Array.isArray(lb?.expTop) ? lb.expTop : [];
  const combat = Array.isArray(lb?.combatTop) ? lb.combatTop : [];

  const table = (rows, mode) => {
    if (!rows.length) return `<div class="muted" style="margin-top:10px;">尚無資料（先查幾個角色）</div>`;
    const th = mode === "exp"
      ? `<tr><th>#</th><th>角色</th><th>伺服器</th><th>Lv</th><th>EXP</th></tr>`
      : `<tr><th>#</th><th>角色</th><th>伺服器</th><th>Lv</th><th>戰鬥力</th></tr>`;
    const body = rows.map((r,i)=> mode==="exp"
      ? `<tr><td>${i+1}</td><td>${esc(r.character_name)}</td><td>${esc(r.world_name)}</td><td>${esc(r.level)}</td><td>${esc(r.exp)}</td></tr>`
      : `<tr><td>${i+1}</td><td>${esc(r.character_name)}</td><td>${esc(r.world_name)}</td><td>${esc(r.level)}</td><td>${esc(r.combat_power)}</td></tr>`
    ).join("");
    return `<table>${th}${body}</table>`;
  };

  return `
    <div class="card">
      <div class="title" style="font-size:16px;">排行榜（你查過的人，本機記錄）</div>
      <div class="tabs">
        <button class="tab active" id="tExp" onclick="showLB('exp')">EXP</button>
        <button class="tab" id="tCombat" onclick="showLB('combat')">戰鬥力</button>
      </div>
      <div id="lbExp">${table(exp,"exp")}</div>
      <div id="lbCombat" style="display:none;">${table(combat,"combat")}</div>
    </div>
  `;
}

function showLB(type) {
  const expEl = document.getElementById("lbExp");
  const combatEl = document.getElementById("lbCombat");
  const tExp = document.getElementById("tExp");
  const tCombat = document.getElementById("tCombat");
  if (type === "exp") {
    expEl.style.display = "";
    combatEl.style.display = "none";
    tExp.classList.add("active");
    tCombat.classList.remove("active");
  } else {
    expEl.style.display = "none";
    combatEl.style.display = "";
    tCombat.classList.add("active");
    tExp.classList.remove("active");
  }
}
</script>
</body>
</html>
