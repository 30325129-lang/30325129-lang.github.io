<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maple 角色查詢（Web）</title>
  <style>
    :root{--fg:#111;--muted:#666;--line:#e9e9e9;--card:#fff;--bg:#f6f7f9;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px;}
    h1{margin:0 0 6px;font-size:22px;font-weight:800;}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    .search{display:flex;gap:10px;align-items:center}
    input[type="text"]{flex:1;min-width:220px;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:14px;outline:none;background:#fff}
    button{border:0;background:#111;color:#fff;border-radius:10px;padding:11px 16px;font-size:14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin:10px 0 0;color:var(--muted);font-size:13px}
    .row{display:flex;gap:14px;flex-wrap:wrap;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px 14px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .card.big{flex:1;min-width:320px}
    .card.full{width:100%}
    .title{font-weight:800;margin:0 0 10px;font-size:16px}
    .muted{color:var(--muted)}
    .profile{display:flex;gap:12px;align-items:flex-start}
    .avatar{width:68px;height:68px;border-radius:14px;background:#eee;flex:0 0 auto;object-fit:cover}
    .pname{font-size:20px;font-weight:900;margin:0}
    .pmeta{color:var(--muted);font-size:13px;line-height:1.4;margin-top:3px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .chip{border:1px solid var(--line);background:#fafafa;border-radius:999px;padding:4px 10px;font-size:12px;color:#333}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:12px}
    @media (max-width:860px){.grid{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .metric{border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    .mname{color:var(--muted);font-size:12px}
    .mval{font-size:16px;font-weight:900;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .equip-grid{display:grid;grid-template-columns:repeat(10,minmax(0,1fr));gap:10px}
    @media (max-width:1100px){.equip-grid{grid-template-columns:repeat(8,minmax(0,1fr));}}
    @media (max-width:860px){.equip-grid{grid-template-columns:repeat(6,minmax(0,1fr));}}
    @media (max-width:520px){.equip-grid{grid-template-columns:repeat(4,minmax(0,1fr));}}
    .equip{border:1px solid var(--line);border-radius:14px;padding:10px 8px;text-align:center;background:#fff}
    .equip img{width:44px;height:44px;image-rendering:pixelated;object-fit:contain}
    .ename{font-size:12px;margin-top:6px;line-height:1.2;height:2.4em;overflow:hidden}
    .tabs{display:flex;gap:8px;align-items:center;margin-top:10px}
    .tab{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;color:#333;cursor:pointer}
    .tab.active{background:#111;color:#fff;border-color:#111}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px 8px;font-size:13px;text-align:left}
    th{color:var(--muted);font-weight:700}
    .right{text-align:right}
    .small{font-size:12px;color:var(--muted)}
    .err{color:#b00020;font-weight:700}

    /* === Tooltip === */
    .tooltip {
      position: fixed;
      z-index: 99999;
      display: none;
      max-width: 560px;
      max-height: 70vh;
      overflow: auto;
      background: rgba(17,17,17,0.95);
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      box-shadow: 0 14px 35px rgba(0,0,0,.25);
      pointer-events: none;
    }
  

/* ===== Modal (點一下裝備/時裝跳出完整數值) ===== */
.no-scroll { overflow: hidden; }

.ability-list { margin: 8px 0 0 18px; padding: 0; line-height: 1.6; color: #e7e7e7; }

.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.65);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  padding: 20px;
}
.modal.hidden { display: none; }
.modal-panel {
  width: min(720px, 96vw);
  max-height: 92vh;
  overflow: auto;
  background: #1b1f2a;
  border: 1px solid #2a3143;
  border-radius: 14px;
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
}
.modal-head {
  display: flex;
  justify-content: flex-end;
  padding: 10px 12px;
  position: sticky;
  top: 0;
  background: linear-gradient(#1b1f2a, rgba(27,31,42,.92));
  backdrop-filter: blur(6px);
  border-bottom: 1px solid #2a3143;
}
.modal-close {
  cursor: pointer;
  border: 0;
  background: #2a3143;
  color: #fff;
  padding: 8px 10px;
  border-radius: 10px;
}
.modal-body { padding: 14px 16px 18px; }

/* ===== Maple 風格 tooltip box ===== */
.tooltipBox { color: #e8e8e8; font-size: 14px; }
.tooltipBox .starline { letter-spacing: 2px; color: #fff; opacity: .9; margin-bottom: 8px; white-space: pre; }
.tooltipBox .hrow { display: flex; gap: 12px; align-items: center; }
.tooltipBox .bigicon { width: 56px; height: 56px; border-radius: 12px; background: #101521; border: 1px solid #2a3143; }
.tooltipBox .hname { font-size: 18px; font-weight: 800; }
.tooltipBox .hmeta { margin-top: 2px; color: #b9c1d9; font-size: 12px; }
.tooltipBox .sec { margin-top: 12px; padding-top: 10px; border-top: 1px solid #2a3143; }
.tooltipBox .sectitle { font-weight: 800; color: #e7eefc; margin-bottom: 6px; }
.tooltipBox .kvlist { display: flex; flex-direction: column; gap: 6px; }
.tooltipBox .kv { display: flex; justify-content: space-between; gap: 12px; }
.tooltipBox .kv span:first-child { color: #c7d0ea; }
.tooltipBox .kv span:last-child { color: #ffffff; font-variant-numeric: tabular-nums; }
.tooltipBox .line { margin: 4px 0; }
.tooltipBox .pot { padding-left: 2px; }
.tooltipBox .desc { margin-top: 8px; color: #c7d0ea; line-height: 1.4; }
.tooltipBox .grade { padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-left: 6px; }
.g-normal { background: #2a3143; color: #d4d8e5; }
.g-rare { background: #1f3b7a; color: #bcd3ff; }
.g-epic { background: #4a2a7a; color: #e2c5ff; }
.g-unique { background: #0f5b5b; color: #baffff; }
.g-legend { background: #577a00; color: #eaff9b; }
.tooltipBox details > summary { cursor: pointer; }
.tooltipBox .json { background: #0f1320; border: 1px solid #2a3143; border-radius: 12px; padding: 10px; overflow: auto; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Maple 角色查詢（Web）</h1>
    <div class="sub">只輸入角色暱稱；日期自動查詢昨天（台灣時間）。戰鬥力顯示「億/萬」單位；BOSS傷/無視/爆傷/爆率/最終傷/傷害 皆自動加上 %。裝備/時裝滑鼠移到圖片即可看完整數值。</div>

    <div class="search">
      <input id="name" type="text" placeholder="輸入角色暱稱（例：Ezra絕）" />
      <button id="btn" onclick="run()">查詢</button>
    </div>
    <div id="status" class="status">待命</div>

    <div id="out" class="row"></div>
  </div>

  <div id="tip" class="tooltip"></div>

  <div id="modal" class="modal hidden">
    <div class="modal-panel">
      <div class="modal-head">
        <button class="modal-close" data-close="1">關閉</button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>


<script>

/** ===== 基本設定 ===== */
const WORKER_BASE = "https://maple-proxy.ezraop.workers.dev";
const DEFAULT_PARTS = "basic,popularity,stat,ability,itemEquipment,cashitemEquipment,symbolEquipment";
const TZ = "Asia/Taipei";

/** ===== DOM helper ===== */
const $ = (id) => document.getElementById(id);
const esc = (s) => String(s ?? "").replace(/[&<>\"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

/** ===== 日期（台灣）昨天 yyyy-mm-dd ===== */
function getYesterdayYmdTz() {
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: TZ, year:"numeric", month:"2-digit", day:"2-digit" });
  const parts = fmt.formatToParts(new Date());
  const y = Number(parts.find(p=>p.type==="year").value);
  const m = Number(parts.find(p=>p.type==="month").value);
  const d = Number(parts.find(p=>p.type==="day").value);
  const dt = new Date(Date.UTC(y, m-1, d));
  dt.setUTCDate(dt.getUTCDate() - 1);
  const y2 = dt.getUTCFullYear();
  const m2 = String(dt.getUTCMonth()+1).padStart(2,"0");
  const d2 = String(dt.getUTCDate()).padStart(2,"0");
  return `${y2}-${m2}-${d2}`;
}


function fmtTs(d) {
  try {
    return new Intl.DateTimeFormat("zh-TW", {
      timeZone: TZ,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    }).format(d);
  } catch (e) {
    // fallback
    return d.toISOString();
  }
}


/** ===== BigInt 單位格式：億/萬 ===== */
function formatZhUnit(nLike) {
  // 專門給「戰鬥力」用：>=1億時一定同時顯示「億」與「萬」
  const s0 = String(nLike ?? "").trim();
  if (!s0) return "";
  const s = s0.replace(/,/g, "");
  if (!/^\d+$/.test(s)) return s0;

  const n = BigInt(s);
  const YI = 100000000n;
  const WAN = 10000n;

  if (n >= YI) {
    const yi = n / YI;
    const remYi = n % YI;
    const wan = remYi / WAN;
    const rem = remYi % WAN; // 0..9999
    // 億、萬固定出現；餘數(千/百/十/個)視情況補上
    return `${yi}億${wan}萬${rem === 0n ? "" : String(rem)}`;
  }
  if (n >= WAN) {
    const wan = n / WAN;
    const rem = n % WAN;
    return `${wan}萬${rem === 0n ? "" : String(rem)}`;
  }
  return String(n);
}


/** ===== % 顯示 ===== */
function formatPercent(v) {
  const s = String(v ?? "").trim();
  if (!s) return "";
  if (s.includes("%")) return s;
  return s + "%";
}

/** ===== 8 大數值抽取 ===== */
function statArrayToMap(final_stat) {
  const map = {};
  if (Array.isArray(final_stat)) {
    for (const s of final_stat) {
      if (s && s.stat_name) map[s.stat_name] = s.stat_value;
    }
  }
  return map;
}
function pick(map, keys) {
  for (const k of keys) {
    const v = map[k];
    if (v !== undefined && v !== null && String(v).trim() !== "") return v;
  }
  return "";
}
function extractMetrics(statMap) {
  const boss = pick(statMap, ["BOSS怪物傷害","Boss怪物傷害","boss怪物傷害"]);
  return {
    combat_power: pick(statMap, ["戰鬥力"]),
    boss_damage: boss,
    ignore_def: pick(statMap, ["無視防禦率"]),
    crit_damage: pick(statMap, ["爆擊傷害"]),
    crit_rate: pick(statMap, ["爆擊機率"]),
    final_damage: pick(statMap, ["最終傷害"]),
    damage: pick(statMap, ["傷害"]),
    attack_power: pick(statMap, ["攻擊力"]),
  };
}

/** ===== Local leaderboard（你查過的人）===== */
const LB_KEY = "maple_lb_v1";
function loadLB() {
  try { return JSON.parse(localStorage.getItem(LB_KEY) || "[]"); } catch { return []; }
}
function saveLB(list) {
  localStorage.setItem(LB_KEY, JSON.stringify(list.slice(0, 500)));
}
function upsertLB(entry) {
  const list = loadLB();
  const key = `${entry.character_name}@@${entry.world_name}`;
  const idx = list.findIndex(x => `${x.character_name}@@${x.world_name}` === key);
  if (idx >= 0) list[idx] = entry;
  else list.push(entry);
  list.sort((a,b)=> (b.fetched_at||"").localeCompare(a.fetched_at||""));
  saveLB(list);
}
function topByBigInt(field, limit=50) {
  const list = loadLB();
  const toBig = (v)=>{ try{ const s=String(v??"").replace(/,/g,"").trim(); return s?BigInt(s):0n; }catch{ return 0n; } };
  return [...list].sort((a,b)=>{
    const A = toBig(a[field]);
    const B = toBig(b[field]);
    return B > A ? 1 : B < A ? -1 : 0;
  }).slice(0, limit);
}

/** ===== Tooltip（滑過去顯示完整數值）===== */
let __lastPointer = { x: 0, y: 0 };
let __tipInited = false;
window.__equipItems = [];
window.__cashItems = [];

function openItemModal(type, idx) {
  const modal = document.getElementById("modal");
  const body = modal?.querySelector(".modal-body");
  if (!modal || !body) return;

  const it = getItemByTypeIdx_(type, idx);
  if (!it) return;

  body.innerHTML = (type === "equip")
    ? buildEquipModalHtml_(it)
    : buildCashModalHtml_(it);

  modal.classList.remove("hidden");
  document.body.classList.add("no-scroll");
}

function closeItemModal() {
  const modal = document.getElementById("modal");
  if (!modal) return;
  modal.classList.add("hidden");
  document.body.classList.remove("no-scroll");
}

function getItemByTypeIdx_(type, idx) {
  const i = Number(idx);
  if (!Number.isFinite(i) || i < 0) return null;
  if (type === "equip") return (window.__equipItems || [])[i] || null;
  if (type === "cash") return (window.__cashItems || [])[i] || null;
  return null;
}

function gradeClass_(g) {
  const s = String(g || "");
  if (s.includes("傳說")) return "g-legend";
  if (s.includes("特殊")) return "g-unique";
  if (s.includes("罕見")) return "g-epic";
  if (s.includes("稀有")) return "g-rare";
  return "g-normal";
}

function pickNum_(v) {
  const s = String(v ?? "").trim();
  if (!s) return 0;
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function buildOptionLines_(label, totalObj, baseObj, addObj, etcObj, starObj, exObj) {
  const keys = [
    ["str", "STR"],
    ["dex", "DEX"],
    ["int", "INT"],
    ["luk", "LUK"],
    ["max_hp", "最大HP"],
    ["max_mp", "最大MP"],
    ["attack_power", "攻擊力"],
    ["magic_power", "魔法攻擊力"],
    ["armor", "防禦力"],
    ["speed", "移動速度"],
    ["jump", "跳躍力"],
  ];

  const lines = [];
  for (const [k, name] of keys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;

    const parts = [];
    const b = pickNum_(baseObj?.[k]); if (b) parts.push(b);
    const a = pickNum_(addObj?.[k]); if (a) parts.push(a);
    const e = pickNum_(etcObj?.[k]); if (e) parts.push(e);
    const s = pickNum_(starObj?.[k]); if (s) parts.push(s);
    const x = pickNum_(exObj?.[k]); if (x) parts.push(x);

    const breakdown = parts.length >= 2 ? ` (${parts.join(" + ")})` : "";
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${breakdown}</span></div>`);
  }

  // 百分比類
  const pctKeys = [
    ["all_stat", "全屬性", "%"],
    ["boss_damage", "BOSS傷", "%"],
    ["ignore_monster_armor", "無視", "%"],
    ["damage", "傷害", "%"],
    ["max_hp_rate", "最大HP", "%"],
    ["max_mp_rate", "最大MP", "%"],
  ];
  for (const [k, name, unit] of pctKeys) {
    const total = pickNum_(totalObj?.[k]);
    if (!total) continue;
    lines.push(`<div class="kv"><span>${name}</span><span>+${total}${unit}</span></div>`);
  }

  return lines.length ? lines.join("") : `<div class="muted">（無可顯示的屬性）</div>`;
}

function buildEquipModalHtml_(it) {
  const name = escapeHtml(it.item_name || "");
  const part = escapeHtml(it.item_equipment_part || "");
  const slot = escapeHtml(it.item_equipment_slot || "");
  const icon = it.item_icon || "";
  const sf = Number(it.starforce || 0) || 0;
  const MAX_STAR = 25;
  const starLine = "★".repeat(Math.min(sf, MAX_STAR)) + "☆".repeat(Math.max(0, MAX_STAR - Math.min(sf, MAX_STAR)));

  const total = it.item_total_option || {};
  const base = it.item_base_option || {};
  const add = it.item_add_option || {};
  const etc = it.item_etc_option || {};
  const star = it.item_starforce_option || {};
  const ex = it.item_exceptional_option || {};

  const optHtml = buildOptionLines_("總屬性", total, base, add, etc, star, ex);

  const pGrade = it.potential_option_grade || "";
  const apGrade = it.additional_potential_option_grade || "";
  const pLines = [it.potential_option_1, it.potential_option_2, it.potential_option_3].filter(Boolean);
  const apLines = [it.additional_potential_option_1, it.additional_potential_option_2, it.additional_potential_option_3].filter(Boolean);

  const potHtml = pLines.length ? pLines.map(v => `<div class="line">${escapeHtml(v)}</div>`).join("") : `<div class="muted">（無）</div>`;
  const apHtml = apLines.length ? apLines.map(v => `<div class="line">${escapeHtml(v)}</div>`).join("") : `<div class="muted">（無）</div>`;

  const desc = it.item_description ? `<div class="desc">${escapeHtml(String(it.item_description)).replace(/\n/g,"<br>")}</div>` : "";

  return `
    <div class="tooltipBox">
      <div class="starline">${starLine}</div>
      <div class="hrow">
        <img class="bigicon" src="${icon}" alt="">
        <div class="htxt">
          <div class="hname">${name}</div>
          <div class="hmeta">${part} / ${slot}　<span class="muted">★${sf}</span></div>
        </div>
      </div>

      ${desc}

      <div class="sec">
        <div class="sectitle">屬性</div>
        <div class="kvlist">${optHtml}</div>
      </div>

      <div class="sec">
        <div class="sectitle">潛能 <span class="grade ${gradeClass_(pGrade)}">${escapeHtml(pGrade || "")}</span></div>
        <div class="pot">${potHtml}</div>
      </div>

      <div class="sec">
        <div class="sectitle">附加潛能 <span class="grade ${gradeClass_(apGrade)}">${escapeHtml(apGrade || "")}</span></div>
        <div class="pot">${apHtml}</div>
      </div>

      <details class="sec">
        <summary class="sectitle">原始資料（JSON）</summary>
        <pre class="json">${escapeHtml(JSON.stringify(it, null, 2))}</pre>
      </details>
    </div>
  `;
}

function buildCashModalHtml_(it) {
  const name = escapeHtml(it.cash_item_name || "");
  const part = escapeHtml(it.cash_item_equipment_part || "");
  const slot = escapeHtml(it.cash_item_equipment_slot || "");
  const icon = it.cash_item_icon || "";
  const opts = Array.isArray(it.cash_item_option) ? it.cash_item_option : [];
  const optHtml = opts.length
    ? opts.map(o => `<div class="kv"><span>${escapeHtml(o.option_type || "")}</span><span>+${escapeHtml(o.option_value || "")}</span></div>`).join("")
    : `<div class="muted">（無）</div>`;

  const exp = it.date_expire ? escapeHtml(it.date_expire) : "";
  const exp2 = it.date_option_expire ? escapeHtml(it.date_option_expire) : "";

  return `
    <div class="tooltipBox">
      <div class="hrow">
        <img class="bigicon" src="${icon}" alt="">
        <div class="htxt">
          <div class="hname">${name}</div>
          <div class="hmeta">${part} / ${slot}</div>
        </div>
      </div>

      <div class="sec">
        <div class="sectitle">時裝屬性</div>
        <div class="kvlist">${optHtml}</div>
      </div>

      ${(exp || exp2) ? `<div class="sec"><div class="sectitle">到期</div><div class="muted">${exp || ""}<br>${exp2 || ""}</div></div>` : ""}

      <details class="sec">
        <summary class="sectitle">原始資料（JSON）</summary>
        <pre class="json">${escapeHtml(JSON.stringify(it, null, 2))}</pre>
      </details>
    </div>
  `;
}

function setupModalOnce() {
  if (window.__modalInited) return;
  window.__modalInited = true;
  const modal = document.getElementById("modal");
  if (!modal) return;

  modal.addEventListener("click", (e) => {
    if (e.target && e.target.classList.contains("modal")) closeItemModal();
    if (e.target && e.target.getAttribute("data-close") === "1") closeItemModal();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeItemModal();
  });
}

function initTooltipOnce() {
  if (__tipInited) return;
  __tipInited = true;

  const tip = $("tip");
  const isEquipEl = (el) => el && el.classList && el.classList.contains("equip") && el.dataset && el.dataset.type && el.dataset.idx !== undefined;

  function showTip(text) {
    tip.textContent = text || "";
    tip.style.display = "block";
    positionTip(__lastPointer.x, __lastPointer.y);
  }
  function hideTip() { tip.style.display = "none"; }
  function positionTip(x, y) {
    if (tip.style.display === "none") return;
    const pad = 14;
    tip.style.left = (x + pad) + "px";
    tip.style.top  = (y + pad) + "px";
    const w = tip.offsetWidth, h = tip.offsetHeight;
    let left = x + pad, top = y + pad;
    if (left + w + pad > window.innerWidth) left = Math.max(pad, window.innerWidth - w - pad);
    if (top + h + pad > window.innerHeight) top = Math.max(pad, window.innerHeight - h - pad);
    tip.style.left = left + "px";
    tip.style.top  = top + "px";
  }

  document.addEventListener("pointermove", (e) => {
    __lastPointer = { x: e.clientX, y: e.clientY };
    positionTip(e.clientX, e.clientY);
  }, { passive: true });

  document.addEventListener("pointerover", (e) => {
    const el = e.target.closest(".equip[data-type][data-idx]");
    if (!isEquipEl(el)) return;
    const type = el.dataset.type;
    const idx = Number(el.dataset.idx);
    if (type === "equip") showTip(formatEquipTooltip(window.__equipItems[idx]));
    else if (type === "cash") showTip(formatCashTooltip(window.__cashItems[idx]));
  });

  document.addEventListener("pointerout", (e) => {
    const from = e.target.closest(".equip[data-type][data-idx]");
    if (!isEquipEl(from)) return;
    const to = e.relatedTarget && e.relatedTarget.closest && e.relatedTarget.closest(".equip[data-type][data-idx]");
    if (to && isEquipEl(to) && to === from) return;
    hideTip();
  });

  window.addEventListener("scroll", hideTip, { passive: true });
}

function isZeroLike(v) {
  const s = String(v ?? "").trim();
  if (!s) return true;
  return s === "0" || s === "0.0" || s === "0.00" || s === "0%" || s === "0.000" || s === "0.0000";
}
function formatObjLines(obj, label, keyOrder = null) {
  if (!obj || typeof obj !== "object") return [];
  const lines = [];
  lines.push(label + "：");
  const keys = Array.isArray(keyOrder) ? keyOrder : Object.keys(obj);
  for (const k of keys) {
    const v = obj[k];
    if (v === undefined || v === null) continue;
    if (isZeroLike(v)) continue;
    lines.push(`- ${k}: ${v}`);
  }
  if (lines.length === 1) lines.push("- （無）");
  return lines;
}
function formatEquipTooltip(it) {
  if (!it) return "（無裝備資料）";
  const lines = [];
  lines.push(`部位/格子：${it.item_equipment_part || ""} / ${it.item_equipment_slot || ""}`);
  lines.push(`名稱：${it.item_name || ""}`);
  if (it.item_description) lines.push(`描述：${it.item_description}`);
  lines.push(`星力：${it.starforce ?? ""}｜卷數：${it.scroll_upgrade ?? ""}｜黃金鐵鎚：${it.golden_hammer_flag ?? ""}`);
  lines.push(`剪刀：${it.cuttable_count ?? ""}｜可強化：${it.scroll_upgradeable_count ?? ""}｜回復卷：${it.scroll_resilience_count ?? ""}`);
  if (it.item_shape_name || it.item_shape_icon) {
    lines.push(`外觀：${it.item_shape_name || ""}`);
    if (it.item_shape_icon) lines.push(`外觀Icon：${it.item_shape_icon}`);
  }
  lines.push("");
  lines.push(`潛能等級：${it.potential_option_grade || "無"}`);
  lines.push(`- 1: ${it.potential_option_1 || ""}`);
  lines.push(`- 2: ${it.potential_option_2 || ""}`);
  lines.push(`- 3: ${it.potential_option_3 || ""}`);
  lines.push("");
  lines.push(`附加潛能等級：${it.additional_potential_option_grade || "無"}`);
  lines.push(`- 1: ${it.additional_potential_option_1 || ""}`);
  lines.push(`- 2: ${it.additional_potential_option_2 || ""}`);
  lines.push(`- 3: ${it.additional_potential_option_3 || ""}`);
  if (it.soul_name || it.soul_option) {
    lines.push("");
    lines.push(`靈魂：${it.soul_name || ""}`);
    lines.push(`靈魂能力：${it.soul_option || ""}`);
  }
  if (it.date_expire) {
    lines.push("");
    lines.push(`到期：${it.date_expire}`);
  }

  lines.push("");
  lines.push(...formatObjLines(it.item_total_option, "總合屬性 item_total_option", [
    "str","dex","int","luk","max_hp","max_mp","attack_power","magic_power","armor","speed","jump",
    "boss_damage","ignore_monster_armor","all_stat","damage","equipment_level_decrease","max_hp_rate","max_mp_rate"
  ]));
  lines.push("");
  lines.push(...formatObjLines(it.item_base_option, "基礎屬性 item_base_option"));
  lines.push("");
  lines.push(...formatObjLines(it.item_add_option, "附加屬性 item_add_option"));
  lines.push("");
  lines.push(...formatObjLines(it.item_etc_option, "其他屬性 item_etc_option"));
  lines.push("");
  lines.push(...formatObjLines(it.item_starforce_option, "星力屬性 item_starforce_option"));
  lines.push("");
  lines.push(...formatObjLines(it.item_exceptional_option, "卓越屬性 item_exceptional_option"));

  if (it.growth_exp !== undefined || it.growth_level !== undefined) {
    lines.push("");
    lines.push(`成長：growth_level=${it.growth_level ?? ""}｜growth_exp=${it.growth_exp ?? ""}`);
  }

  lines.push("");
  lines.push("========== 原始 JSON（完整） ==========");
  lines.push(JSON.stringify(it, null, 2));
  return lines.join("\n");
}
function formatCashTooltip(it) {
  if (!it) return "（無時裝資料）";
  const lines = [];
  lines.push(`部位/格子：${it.cash_item_equipment_part || ""} / ${it.cash_item_equipment_slot || ""}`);
  lines.push(`名稱：${it.cash_item_name || ""}`);
  if (it.cash_item_description) lines.push(`描述：${it.cash_item_description}`);
  if (it.item_gender) lines.push(`性別限制：${it.item_gender}`);
  if (it.date_expire) lines.push(`到期：${it.date_expire}`);
  if (it.date_option_expire) lines.push(`能力到期：${it.date_option_expire}`);

  lines.push("");
  lines.push("能力（cash_item_option）：");
  if (Array.isArray(it.cash_item_option) && it.cash_item_option.length) {
    for (const o of it.cash_item_option) lines.push(`- ${o.option_type || ""}: ${o.option_value || ""}`);
  } else {
    lines.push("- （無）");
  }
  lines.push("");
  lines.push("========== 原始 JSON（完整） ==========");
  lines.push(JSON.stringify(it, null, 2));
  return lines.join("\n");
}

/** ===== Render ===== */
function renderProfile(basic, date, popularity, metrics) {
  const expRate = basic.character_exp_rate ? formatPercent(basic.character_exp_rate) : "";
  const expText = basic.character_exp ? String(basic.character_exp) : "";
  const cls = basic.character_class || "";
  const world = basic.world_name || "";
  const level = basic.character_level ?? "";
  const guild = basic.character_guild_name || "";

  const img = basic.character_image || "";
  const chips = [
    world ? `伺服器：${world}` : "",
    cls ? `職業：${cls}` : "",
    level !== "" ? `Lv.${level}` : "",
    guild ? `公會：${guild}` : "",
    popularity !== "" ? `人氣：${popularity}` : "",
    date ? `日期：${date}` : "",
  ].filter(Boolean);

  return `
    <div class="card big">
      <div class="profile">
        ${img ? `<img class="avatar" src="${esc(img)}" />` : `<div class="avatar"></div>`}
        <div>
          <p class="pname">${esc(basic.character_name || "")}</p>
          <div class="pmeta">
            EXP：${esc(expText)} ${expRate ? `（${esc(expRate)}）` : ""}
          </div>
          <div class="chips">${chips.map(c=>`<span class="chip">${esc(c)}</span>`).join("")}</div>
        </div>
      </div>

      <div class="grid">
        ${renderMetric("戰鬥力", formatZhUnit(metrics.combat_power))}
        ${renderMetric("BOSS傷", metrics.boss_damage ? formatPercent(metrics.boss_damage) : "")}
        ${renderMetric("無視", metrics.ignore_def ? formatPercent(metrics.ignore_def) : "")}
        ${renderMetric("爆傷", metrics.crit_damage ? formatPercent(metrics.crit_damage) : "")}
        ${renderMetric("爆率", metrics.crit_rate ? formatPercent(metrics.crit_rate) : "")}
        ${renderMetric("最終傷", metrics.final_damage ? formatPercent(metrics.final_damage) : "")}
        ${renderMetric("傷害", metrics.damage ? formatPercent(metrics.damage) : "")}
        ${renderMetric("攻擊力", metrics.attack_power || "")}
      </div>
    </div>
  `;
}
function renderMetric(name, val) {
  return `
    <div class="metric">
      <div class="mname">${esc(name)}</div>
      <div class="mval">${esc(val || "-")}</div>
    </div>
  `;
}

function renderEquip(e) {
  const arr = Array.isArray(e?.item_equipment) ? e.item_equipment : [];
  window.__equipItems = arr;
  initTooltipOnce();

  const cells = arr.map((it, i) => {
    const icon = it.item_icon || it.item_shape_icon || "";
    const name = it.item_name || "";
    const star = it.starforce ? `★${it.starforce}` : "";
    return `
      <div class="equip" data-type="equip" data-idx="${i}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
        <div class="small">${esc(star)}</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card full">
      <div class="title">裝備（equipped）</div>
      <div class="small" style="margin:6px 0 10px;">滑鼠移到圖片上可看完整數值（含原始 JSON）。</div>
      <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
    </div>
  `;
}


function renderAbility(ability) {
  if (!ability) return "";
  const grade = ability.ability_grade || "";
  const lines = Array.isArray(ability.ability_info) ? ability.ability_info : [];
  const items = lines
    .slice(0, 3)
    .map((x) => `<li>${escapeHtml(x.ability_value || "")}</li>`)
    .join("");

  return `
    <div class="card full">
      <div class="title">內潛（${escapeHtml(grade)}）</div>
      <ul class="ability-list">${items || "<li>（無資料）</li>"}</ul>
    </div>
  `;
}

function renderCash(c) {
  const arr = Array.isArray(c?.cash_item_equipment_base) ? c.cash_item_equipment_base : [];
  window.__cashItems = arr;
  initTooltipOnce();

  const cells = arr.map((it, i) => {
    const icon = it.cash_item_icon || "";
    const name = it.cash_item_name || "";
    return `
      <div class="equip" data-type="cash" data-idx="${i}">
        ${icon ? `<img src="${esc(icon)}" />` : `<div style="height:44px;"></div>`}
        <div class="ename">${esc(name)}</div>
        <div class="small">&nbsp;</div>
      </div>
    `;
  }).join("");

  return `
    <div class="card full">
      <div class="title">時裝（base）</div>
      <div class="small" style="margin:6px 0 10px;">滑鼠移到圖片上可看完整數值（含原始 JSON）。</div>
      <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
    </div>
  `;
}

function renderLeaderboard() {
  const expTop = topByBigInt("exp", 50);
  const combatTop = topByBigInt("combat_power", 50);

  const table = (rows, type) => `
    <table>
      <thead>
        <tr>
          <th class="right">#</th>
          <th>角色</th>
          <th>伺服器</th>
          <th class="right">${type==="exp"?"EXP":"戰鬥力"}</th>
          <th class="right">Lv</th>
          <th class="right">更新時間</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map((r,i)=>`
          <tr>
            <td class="right">${i+1}</td>
            <td>${esc(r.character_name||"")}</td>
            <td>${esc(r.world_name||"")}</td>
            <td class="right">${type==="exp"?esc(r.exp||""):esc(formatZhUnit(r.combat_power||""))}</td>
            <td class="right">${esc(r.level||"")}</td>
            <td class="right">${esc(r.fetched_at||"")}</td>
          </tr>
        `).join("") || `<tr><td colspan="6" class="muted">尚無資料（先查詢幾個角色）</td></tr>`}
      </tbody>
    </table>
  `;

  return `
    <div class="card full">
      <div class="title">排行榜（以你查過的角色為準）</div>
      <div class="tabs">
        <button class="tab active" id="tabExp" onclick="switchTab('exp')">經驗值排行榜</button>
        <button class="tab" id="tabCombat" onclick="switchTab('combat')">戰鬥力排行榜</button>
        <span class="small">（資料存在瀏覽器 localStorage）</span>
      </div>
      <div id="lbExp" style="margin-top:10px;">${table(expTop, "exp")}</div>
      <div id="lbCombat" style="margin-top:10px; display:none;">${table(combatTop, "combat")}</div>
    </div>
  `;
}

function switchTab(which) {
  const a = $("tabExp"), b = $("tabCombat");
  const exp = $("lbExp"), combat = $("lbCombat");
  if (which === "exp") {
    a.classList.add("active"); b.classList.remove("active");
    exp.style.display = "block"; combat.style.display = "none";
  } else {
    b.classList.add("active"); a.classList.remove("active");
    combat.style.display = "block"; exp.style.display = "none";
  }
}

/** ===== 主流程 ===== */
async function run() {
  const name = $("name").value.trim();
  if (!name) {
    $("status").innerHTML = `<span class="err">請輸入角色暱稱</span>`;
    return;
  }

  $("btn").disabled = true;
  $("status").textContent = "查詢中…";
  $("out").innerHTML = "";

  const date = getYesterdayYmdTz();
  const url = `${WORKER_BASE.replace(/\/+$/,"")}/character?name=${encodeURIComponent(name)}&date=${encodeURIComponent(date)}&parts=${encodeURIComponent(DEFAULT_PARTS)}`;

  try {
    const t0 = performance.now();
    const resp = await fetch(url, { method:"GET", cache:"no-store" });
    const text = await resp.text();
    let json;
    try { json = JSON.parse(text); } catch(e) {
      throw new Error(`Worker 回傳不是 JSON：${text.slice(0,200)}`);
    }
    if (!json.ok) {
      const msg = json?.body?.error?.message || `HTTP ${json.status || resp.status}`;
      throw new Error(msg);
    }

    const data = json.data || {};
    const basic = data.basic || {};
    const popularity = data.popularity?.popularity ?? "";
    const statMap = statArrayToMap(data.stat?.final_stat);
    const metrics = extractMetrics(statMap);

    const now = new Date();
    const fetched_at = fmtTs(now);
    upsertLB({
      character_name: basic.character_name || name,
      world_name: basic.world_name || "",
      class: basic.character_class || "",
      level: basic.character_level ?? "",
      exp: basic.character_exp ?? "",
      combat_power: metrics.combat_power ?? "",
      date,
      fetched_at,
    });

    const t1 = performance.now();
    $("status").textContent = `完成（耗時 ${(t1-t0)/1000.0 >= 1 ? ((t1-t0)/1000).toFixed(2)+'s' : Math.round(t1-t0)+'ms'}）`;

    $("out").innerHTML =
      renderProfile(basic, date, popularity, metrics) +
      renderAbility(data.ability) +
      renderEquip(data.itemEquipment) +
      renderCash(data.cashitemEquipment) +
      renderLeaderboard();

  } catch (err) {
    $("status").innerHTML = `<span class="err">查詢失敗：${esc(err?.message || String(err))}</span>`;
    $("out").innerHTML = renderLeaderboard();
  } finally {
    $("btn").disabled = false;
  }
}

// Enter 送出
document.addEventListener("keydown", (e)=> {
  if (e.key === "Enter" && document.activeElement === $("name")) run();
});

// 預填（方便你測）
if (!$("name").value) $("name").value = "Ezra絕";

</script>
</body>
</html>
