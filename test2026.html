<!doctype html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, "Segoe UI", Arial; margin: 0; background:#fafafa; }
      .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
      .top { display:flex; align-items:center; justify-content:space-between; gap:12px; }
      .title { font-size: 18px; font-weight: 900; }
      .muted { color: #666; font-size: 12px; }
      .row { margin: 12px 0; display:flex; gap:10px; }
      input { flex:1; padding: 12px; font-size: 14px; border:1px solid #ddd; border-radius: 12px; }
      button { padding: 12px 14px; font-size: 14px; border:1px solid #111; background:#111; color:#fff; border-radius: 12px; cursor:pointer; }
      button:disabled { opacity:.6; cursor:not-allowed; }
      .err { color:#c62828; white-space:pre-wrap; margin-top:8px; }
      .card { background:#fff; border:1px solid #e9e9e9; border-radius: 16px; padding: 14px; margin: 14px 0; }
      .grid { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:10px; }
      .kv { border:1px solid #eee; border-radius: 14px; padding:10px; }
      .k { color:#666; font-size:12px; }
      .v { font-weight:900; font-size:16px; margin-top:4px; }
      .equip-grid { display:grid; grid-template-columns: repeat(10, 1fr); gap:8px; }
      .equip { border:1px solid #eee; border-radius: 14px; padding:8px; text-align:center; background:#fff; }
      .equip img { width:44px; height:44px; object-fit:contain; display:block; margin:0 auto 6px; }
      .equip .name { font-size:11px; line-height:1.2; }
      .tabs { display:flex; gap:10px; margin-top:10px; }
      .tab { padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius: 12px; cursor:pointer; }
      .tab.active { border-color:#111; font-weight:900; }
      table { width:100%; border-collapse:collapse; }
      th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; font-size:13px; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="top">
        <div>
          <div class="title">Maple 角色查詢（Web）</div>
          <div class="muted">只輸入暱稱；日期自動查詢昨天；8大數值一個不漏；裝備/時裝圖片完整顯示。</div>
        </div>
      </div>

      <div class="row">
        <input id="name" placeholder="輸入角色暱稱，例如：Ezra絕" />
        <button id="btn" onclick="run()">查詢</button>
      </div>

      <div id="status" class="muted"></div>
      <div id="error" class="err"></div>

      <div id="result"></div>
    </div>

    <script>
      function esc(s) {
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#39;");
      }
      function setStatus(msg) { document.getElementById("status").textContent = msg || ""; }
      function setError(msg) { document.getElementById("error").textContent = msg || ""; }

      function run() {
        const name = document.getElementById("name").value.trim();
        if (!name) { setError("請輸入角色暱稱"); return; }
        setError("");
        setStatus("查詢中…");
        const btn = document.getElementById("btn");
        btn.disabled = true;

        google.script.run
          .withSuccessHandler((data) => {
            btn.disabled = false;
            setStatus("完成（已寫入試算表：characters / equipment / cash_items）");
            render(data);
          })
          .withFailureHandler((err) => {
            btn.disabled = false;
            setStatus("");
            setError(err && err.message ? err.message : String(err));
          })
          .importCharacter(name);
      }

      function render(data) {
        const b = data.basic || {};
        const m = data.metrics || {};
        const img = b.character_image || "";

        const summary = `
          <div class="card">
            <div style="display:flex; gap:14px; align-items:center;">
              ${img ? `<img src="${esc(img)}" style="width:84px;height:84px;border-radius:18px;object-fit:cover;">` : ""}
              <div>
                <div style="font-size:22px;font-weight:1000;">${esc(b.character_name || "")}</div>
                <div class="muted">${esc(b.world_name || "")}｜${esc(b.character_class || "")}｜Lv.${esc(b.character_level || "")}</div>
                <div class="muted">日期：${esc(data.date || "")}｜人氣：${esc(data.popularity ?? "")}</div>
                <div class="muted">EXP：${esc(b.character_exp || "")}（${esc(b.character_exp_rate || "")}%）</div>
              </div>
            </div>

            <div class="grid">
              <div class="kv"><div class="k">戰鬥力</div><div class="v">${esc(m.combat_power)}</div></div>
              <div class="kv"><div class="k">BOSS傷</div><div class="v">${esc(m.boss_damage)}</div></div>
              <div class="kv"><div class="k">無視</div><div class="v">${esc(m.ignore_def)}</div></div>
              <div class="kv"><div class="k">爆傷</div><div class="v">${esc(m.crit_damage)}</div></div>
              <div class="kv"><div class="k">爆率</div><div class="v">${esc(m.crit_rate)}</div></div>
              <div class="kv"><div class="k">最終傷</div><div class="v">${esc(m.final_damage)}</div></div>
              <div class="kv"><div class="k">傷害</div><div class="v">${esc(m.damage)}</div></div>
              <div class="kv"><div class="k">攻擊力</div><div class="v">${esc(m.attack_power)}</div></div>
            </div>
          </div>
        `;

        const equip = renderEquip(data.itemEquipment);
        const cash = renderCash(data.cashitemEquipment);
        const lb = renderLB(data.leaderboard || { expTop: [], combatTop: [] });

        document.getElementById("result").innerHTML = summary + equip + cash + lb;
      }

      function renderEquip(e) {
        const items = e && Array.isArray(e.item_equipment) ? e.item_equipment : [];
        const cells = items.map(it => {
          const icon = it.item_icon || it.item_shape_icon || "";
          const name = it.item_name || "";
          const star = it.starforce ? `★${it.starforce}` : "";
          return `
            <div class="equip" title="${esc(name)}">
              ${icon ? `<img src="${esc(icon)}">` : `<div style="height:44px;"></div>`}
              <div class="name">${esc(name)}</div>
              <div class="muted">${esc(star)}</div>
            </div>
          `;
        }).join("");

        return `
          <div class="card">
            <div style="font-weight:1000; font-size:16px;">裝備（equipped）</div>
            <div class="muted" style="margin:6px 0 10px;">已完整寫入試算表 equipment（含 preset_1~3）</div>
            <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
          </div>
        `;
      }

      function renderCash(c) {
        const items = c && Array.isArray(c.cash_item_equipment_base) ? c.cash_item_equipment_base : [];
        const cells = items.map(it => {
          const icon = it.cash_item_icon || "";
          const name = it.cash_item_name || "";
          return `
            <div class="equip" title="${esc(name)}">
              ${icon ? `<img src="${esc(icon)}">` : `<div style="height:44px;"></div>`}
              <div class="name">${esc(name)}</div>
            </div>
          `;
        }).join("");

        return `
          <div class="card">
            <div style="font-weight:1000; font-size:16px;">時裝（base）</div>
            <div class="muted" style="margin:6px 0 10px;">已完整寫入試算表 cash_items（含 preset / additional）</div>
            <div class="equip-grid">${cells || `<div class="muted">無資料</div>`}</div>
          </div>
        `;
      }

      function renderLB(lb) {
        const exp = Array.isArray(lb.expTop) ? lb.expTop : [];
        const combat = Array.isArray(lb.combatTop) ? lb.combatTop : [];

        return `
          <div class="card">
            <div style="font-weight:1000; font-size:16px;">排行榜（以你查過的人生成）</div>
            <div class="tabs">
              <button class="tab active" id="tExp" onclick="showLB('exp')">EXP</button>
              <button class="tab" id="tCombat" onclick="showLB('combat')">戰鬥力</button>
            </div>
            <div id="lbExp">${table(exp, "exp")}</div>
            <div id="lbCombat" style="display:none;">${table(combat, "combat")}</div>
          </div>
        `;

        function table(rows, mode) {
          if (!rows.length) return `<div class="muted" style="margin-top:10px;">尚無資料（先查幾個角色）</div>`;
          const th = mode === "exp"
            ? `<tr><th>#</th><th>角色</th><th>伺服器</th><th>Lv</th><th>EXP</th></tr>`
            : `<tr><th>#</th><th>角色</th><th>伺服器</th><th>Lv</th><th>戰鬥力</th></tr>`;
          const body = rows.map((r,i)=> mode==="exp"
            ? `<tr><td>${i+1}</td><td>${esc(r.character_name)}</td><td>${esc(r.world_name)}</td><td>${esc(r.level)}</td><td>${esc(r.exp)}</td></tr>`
            : `<tr><td>${i+1}</td><td>${esc(r.character_name)}</td><td>${esc(r.world_name)}</td><td>${esc(r.level)}</td><td>${esc(r.combat_power)}</td></tr>`
          ).join("");
          return `<table>${th}${body}</table>`;
        }
      }

      function showLB(type) {
        const expEl = document.getElementById("lbExp");
        const combatEl = document.getElementById("lbCombat");
        const tExp = document.getElementById("tExp");
        const tCombat = document.getElementById("tCombat");
        if (type === "exp") {
          expEl.style.display = "";
          combatEl.style.display = "none";
          tExp.classList.add("active");
          tCombat.classList.remove("active");
        } else {
          expEl.style.display = "none";
          combatEl.style.display = "";
          tCombat.classList.add("active");
          tExp.classList.remove("active");
        }
      }
    </script>
  </body>
</html>
